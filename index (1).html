<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Postgraduate Portfolio</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <style>
        :root {
            --forest-green: #15803d;
            --clay: #92400e;
            --earth-black: #1f2937;
            --bg-rural: #fdfbf7;
            --accent-orange: #d97706;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-rural);
            color: var(--earth-black);
            line-height: 1.5;
        }

        button { font-family: inherit; transition: all 0.2s; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } }

        input, select, textarea {
            width: 100%; padding: 10px;
            border: 1px solid #d1d5db; border-radius: 6px; background: white;
        }

        .btn-rural {
            background: var(--forest-green); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;
        }
        .btn-rural:hover { background: var(--clay); }

        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500; }
        .status-done { background: #dcfce7; color: #166534; }
        .status-pending { background: #f3f4f6; color: #6b7280; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { animation: fadeIn 0.15s ease-out; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #e5e7eb; border-top-color: var(--forest-green);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }

        .mobile-header { display: none; }
        #mobile-overlay { display: none; }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed !important; left: -280px; top: 0; bottom: 0;
                z-index: 1000; transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            #sidebar.open { transform: translateX(280px); }
            #mobile-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; }
            #mobile-overlay.open { display: block; }
            .mobile-header {
                display: flex; background: var(--forest-green); color: white;
                padding: 15px; align-items: center; gap: 15px;
                position: sticky; top: 0; z-index: 900;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <div id="app"></div>
    <script>
        const moduleConfigs = [
            {
                id: 'surgery', name: 'Surgery (Module 1)', color: '#15803d', duration: '9 months', procedures: 45,
                weeks: [
                    { id: 'w1', title: 'Trauma Assessment & Shock' }, { id: 'w2', title: 'Antibiotics & Pre-op Prep' },
                    { id: 'w3', title: 'Instruments & Sterilization' }, { id: 'w4', title: 'Theatre Setup (Case: Stab wound)' },
                    { id: 'w5', title: 'Acute Pain' }, { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Wounds & Suturing' }, { id: 'w8', title: 'Transfer Principles' },
                    { id: 'w9', title: 'Pyomyositis & Osteo' }, { id: 'w10', title: 'Chest Drains' },
                    { id: 'w11', title: 'Closed Fractures' }, { id: 'w12', title: 'Neurovascular & Secondary Intention' },
                    { id: 'w13', title: 'Dental/Airway Infections' }, { id: 'w14', title: 'Abscesses' },
                    { id: 'w15', title: 'Appendicitis' }, { id: 'w16', title: 'Laparotomy Basics' },
                    { id: 'w17', title: 'Gut Repair' }, { id: 'w18', title: 'Stomas & Ulcers' },
                    { id: 'w19', title: 'Bowel Obstruction' }, { id: 'w20', title: 'Casting & Splinting' },
                    { id: 'w21', title: 'Traction' }, { id: 'w22', title: 'Open Fractures' },
                    { id: 'w23', title: 'Dislocations' }, { id: 'w24', title: 'Upper Limb Trauma' },
                    { id: 'w25', title: 'Bleeding Control' }, { id: 'w26', title: 'Enucleation' },
                    { id: 'w27', title: 'Hernia Repair' }, { id: 'w28', title: 'Strangulated Hernia' },
                    { id: 'w29', title: 'Minor Procedures' }, { id: 'w30', title: 'Head & Spinal Injury' },
                    { id: 'w31', title: 'Burns' }, { id: 'w32', title: 'Ethics' }
                ],
                assignmentList: [
                    { title: '1. Cancer Pathophysiology', prompt: 'Staging and development in rural contexts.' },
                    { title: '2. Cancer Screening in PNG', prompt: 'Pros/cons of screening programs.' },
                    { title: '3. Blood Transfusion Protocols', prompt: 'Risks, safety, and rural alternatives.' },
                    { title: '4. Blood / Haemopoiesis', prompt: 'Blood cell development, splenomegaly pathology.' },
                    { title: '5. Cytokines', prompt: 'Role in wound healing, inflammation, haemostasis, neoplasia.' },
                    { title: '6. Wound Healing Physiology', prompt: 'Stages of healing in different tissues.' },
                    { title: '7. Hb & Oxygen Transport', prompt: 'Oxygen dissociation curve, respiratory failure types.' },
                    { title: '8. Genetics', prompt: 'Genetic defects, gene therapy, counselling.' },
                    { title: '9. Nerve Conduction', prompt: 'Peripheral nerve injuries, diagnosis, assessment.' },
                    { title: '10. Pain Pathways', prompt: 'Pathways, analgesics, local anaesthetics.' },
                    { title: '11. Urodynamics', prompt: 'Incontinence, spinal cord injury, bladder function.' },
                    { title: '12. CSF & ICP', prompt: 'Pathophysiology of raised intracranial pressure.' },
                    { title: '13. Calcium Homeostasis', prompt: 'Renal calculi, hypercalcemia, osteoporosis.' },
                    { title: '14. Liver Function', prompt: 'Portal hypertension, cirrhosis, ascites, encephalopathy.' },
                    { title: '15. Bile & Gallstones', prompt: 'Bile composition, gallbladder function, stones.' },
                    { title: '16. Oedema', prompt: 'Pathophysiology of unilateral leg swelling.' },
                    { title: '17. Thrombosis', prompt: 'Thrombosis, embolism, anticoagulants.' },
                    { title: '18. Gastric Secretion', prompt: 'Physiology, H. pylori, ulcer, cancer.' },
                    { title: '19. Surgical Infections', prompt: 'Osteomyelitis, HIV, TB, Necrotising Fasciitis.' },
                    { title: '20. Antibiotics Policy', prompt: 'Antibiotic policy recommendations and monitoring.' }
                ]
            },
            {
                id: 'anaesthesia', name: 'Anaesthesiology (Module 2)', color: '#475569', duration: '4 months', procedures: 50,
                weeks: [
                    { id: 'w1', title: 'Machine Check & Equipment' }, { id: 'w2', title: 'Ketamine (Pharma & Use)' },
                    { id: 'w3', title: 'Propofol & Benzos' }, { id: 'w4', title: 'Pre-op Assessment' },
                    { id: 'w5', title: 'Opiates & Deferring Surgery' }, { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Spinal & LUSCS' }, { id: 'w8', title: 'Brachial Plexus Blocks' },
                    { id: 'w9', title: 'Wrist/Ankle Blocks' }, { id: 'w10', title: 'Neonatal Resuscitation' },
                    { id: 'w11', title: 'Cannot Intubate/Ventilate' }, { id: 'w12', title: 'IV Access' },
                    { id: 'w13', title: 'Cardiac Arrest' }, { id: 'w14', title: 'Handling Negative Outcomes' }
                ],
                caseReports: ['General Anaesthesia', 'Ketamine Anaesthesia', 'Spinal Anaesthesia', 'Paediatric Anaesthesia', 'Resuscitation']
            },
            {
                id: 'childhealth', name: 'Child Health (Module 3)', color: '#f97316', duration: '1 month', procedures: 30,
                weeks: [
                    { id: 'w1', title: 'Milestones & Malnutrition' }, { id: 'w2', title: 'Pneumonia & Oxygen' },
                    { id: 'w3', title: 'Cardiac & Kidney' }, { id: 'w4', title: 'Newborn Exam' },
                    { id: 'w5', title: 'Ponsetti & Diarrhoea' }, { id: 'w6', title: 'Immunization' }
                ],
                caseReports: ['Pneumonia', 'Diarrhoea', 'Malnutrition', 'Meningitis', 'Neonatal Sepsis']
            },
            {
                id: 'obs_gyn', name: 'Obs & Gynae (Module 4)', color: '#ec4899', duration: '3 months', procedures: 40,
                weeks: [
                    { id: 'w1', title: 'Menstrual Cycle' }, { id: 'w2', title: 'Contraception' },
                    { id: 'w3', title: 'Routine Antenatal' }, { id: 'w4', title: 'Basic USS' },
                    { id: 'w5', title: 'Miscarriage/Ectopic' }, { id: 'w6', title: 'Normal Labour' },
                    { id: 'w7', title: 'Partograms' }, { id: 'w8', title: 'CS Technique' },
                    { id: 'w9', title: 'APH & Pre-eclampsia' }, { id: 'w10', title: 'Failure to Progress' },
                    { id: 'w11', title: 'PPH' }, { id: 'w12', title: 'Puerperal Sepsis' },
                    { id: 'w13', title: 'Infertility' }, { id: 'w15', title: 'Ovarian Tumours' },
                    { id: 'w17', title: 'Endometrial CA' }, { id: 'w19', title: 'Cervical CA' },
                    { id: 'w21', title: 'Pelvic Sepsis' }, { id: 'w23', title: 'Pre-eclampsia/Eclampsia' },
                    { id: 'w26', title: 'PPH Advanced' }, { id: 'w29', title: 'Destructive Delivery' }
                ],
                assignmentList: [
                    { title: 'Written Assignment 1', prompt: 'Topic: Antenatal Care or Family Planning' },
                    { title: 'Written Assignment 2', prompt: 'Topic: Emergency Obstetric Care' }
                ]
            },
            {
                id: 'medicine', name: 'Internal Medicine (Module 5)', color: '#3b82f6', duration: '2 months', procedures: 20,
                weeks: [
                    { id: 'w1', title: 'Diabetes' }, { id: 'w2', title: 'Antibiotics & Sepsis' },
                    { id: 'w3', title: 'Tuberculosis' }, { id: 'w4', title: 'Snake Bite & ECG' },
                    { id: 'w5', title: 'Hypertension & HIV' }, { id: 'w6', title: 'Asthma/COAD' }
                ],
                caseReports: ['Severe Malaria', 'Meningitis', 'Pneumonia', 'Heart Failure', 'TB']
            },
            { id: 'psychiatry', name: 'Psychiatry (Module 6)', color: '#a855f7', duration: '1 month', procedures: 10,
                caseReports: ['Acute Psychosis', 'Somatoform Disorder'] },
            { id: 'publichealth', name: 'Public Health (Module 7)', color: '#10b981', duration: 'Longitudinal',
                assignmentList: ['PH1: Community Diagnosis', 'PH2: Outbreak Investigation', 'PH3: Program Evaluation', 'PH4: Health Management', 'PH5: Environmental Health'] },
            { id: 'eye_ent', name: 'Eye/ENT (Module 8)', color: '#06b6d4', duration: '1 month', procedures: 15,
                caseReports: ['Perforating Eye Injury', 'Red Eye Differential', 'Epistaxis Mgmt'] },
            { id: 'lab', name: 'Laboratory (Module 9)', color: '#6366f1', duration: '1 month', procedures: 10,
                assignmentList: ['Skill: Cross-match', 'Skill: Malaria Stain'] },
            { id: 'management', name: 'Management (Module 10)', color: '#475569', duration: '4 weeks',
                assignmentList: ['4-Week Intensive Course', 'Major Assignment (3500 words)'] }
        ];

        const milestoneConfigs = {
            research: [
                { id: 'res_topic', label: 'Research Topic Approved' }, { id: 'res_data', label: 'Data Collection Completed' },
                { id: 'res_submit', label: 'Research Submitted' }, { id: 'res_present', label: 'Research Presented' }
            ],
            exams: [
                { id: 'exam_part1', label: 'Part 1 Exam Passed' }, { id: 'exam_part2_written', label: 'Part 2 Written Passed' },
                { id: 'exam_part2_clinical', label: 'Part 2 Clinical Passed' }
            ],
            management: [
                { id: 'mgmt_course', label: '4-Week Intensive Course' }, { id: 'mgmt_assign', label: '7,500 Word Assignment' }
            ],
            other: [ { id: 'solar_course', label: 'Solar/Radio Maintenance Course' } ]
        };

        const masterLogbookConfig = [
            { category: 'Anaesthesiology', items: [
                { id: 'la_pre', label: 'Pre-op Assessment', target: 50 }, { id: 'la_int', label: 'Intubation', target: 10 },
                { id: 'la_spin', label: 'Spinal Anaesthesia', target: 20 }, { id: 'la_ket', label: 'Ketamine Anaesthesia', target: 10 }
            ]},
            { category: 'Obstetrics & Gynaecology', items: [
                { id: 'lo_norm', label: 'Normal Delivery', target: 20 }, { id: 'lo_cs', label: 'LUSCS (Caesarean)', target: 6 },
                { id: 'lo_breech', label: 'Breech Delivery', target: 5 }, { id: 'lo_vac', label: 'Vacuum Extraction', target: 6 },
                { id: 'lo_pph', label: 'PPH Management', target: 6 }
            ]},
            { category: 'Child Health', items: [
                { id: 'lc_neo', label: 'Neonatal Resuscitation', target: 4 }, { id: 'lc_pon', label: 'Ponsetti Casting', target: 2 },
                { id: 'lc_io', label: 'Intraosseous Needle', target: 1 }
            ]},
            { category: 'Surgery & Medicine', items: [
                { id: 'ls_hernia', label: 'Hernia Repair', target: 8 }, { id: 'ls_lap', label: 'Laparotomy', target: 5 },
                { id: 'ls_chest', label: 'Chest Drain Insertion', target: 7 }, { id: 'lm_lp', label: 'Lumbar Puncture', target: 10 }
            ]},
            { category: 'Laboratory Medicine', items: [
                { id: 'log_blood', label: 'Blood Typing & Crossmatch', target: 10 }, { id: 'log_malaria', label: 'Malaria Smear Staining', target: 10 }
            ]}
        ];

        // --- State Management ---
        class AppState {
            constructor() {
                this.account = null;
                this.modules = {};
                this.procedureLog = [];
                this.milestones = {};
                this.logbook = {};
                this.sidebarOpen = window.innerWidth > 768;
                this.activeTab = 'dashboard';
                this.listeners = [];
                this._authReady = false;
                this._loginProcessed = false;

                this.loadData();
                this.initFirebase();
            }

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyBhEln9kmgq22NnNHI83eUH7_d6S4F1O5s",
                    authDomain: "rural-mmed-logbook-3e095.firebaseapp.com",
                    projectId: "rural-mmed-logbook-3e095",
                    storageBucket: "rural-mmed-logbook-3e095.firebasestorage.app",
                    messagingSenderId: "826477177641",
                    appId: "1:826477177641:web:fe9de6e733b442fdffe538"
                };

                try {
                    firebase.initializeApp(firebaseConfig);
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();

                    // SINGLE source of truth for auth state
                    this.auth.onAuthStateChanged(user => {
                        console.log("Auth state changed:", user ? user.email : "signed out");
                        this._authReady = true;
                        if (user && !this._loginProcessed) {
                            this._loginProcessed = true;
                            this.handleCloudLogin(user);
                        } else if (!user) {
                            this._loginProcessed = false;
                            if (this.account) {
                                this.account = null;
                                render();
                            } else {
                                render();
                            }
                        }
                    });
                } catch (e) {
                    console.log("Firebase not configured: " + e.message);
                    this._authReady = true;
                    render();
                }
            }

            async handleCloudLogin(user) {
                console.log("Processing login for:", user.email);
                this._showLoading("Syncing your data...");

                const defaultYear = 1;
                try {
                    const cloudRef = this.db.collection('users').doc(user.uid);
                    const doc = await cloudRef.get();
                    let cloudData = doc.exists ? doc.data() : {};
                    console.log("Cloud data", doc.exists ? "found, merging..." : "not found, creating...");

                    this.account = {
                        name: cloudData.account?.name || user.displayName || "Dr. " + user.email.split('@')[0],
                        email: user.email, photo: user.photoURL, id: user.uid,
                        year: cloudData.account?.year || defaultYear, lastBackup: Date.now()
                    };

                    this.modules = cloudData.modules || this.modules;
                    this.procedureLog = cloudData.procedureLog || this.procedureLog;
                    this.milestones = cloudData.milestones || this.milestones;
                    this.logbook = cloudData.logbook || this.logbook;
                    this.saveData(true);
                    if (!doc.exists) this.saveData();
                } catch (e) {
                    console.error("Login Sync Error:", e);
                    this.account = {
                        name: user.displayName || "User", email: user.email,
                        id: user.uid, year: defaultYear, lastBackup: Date.now()
                    };
                    this.saveData(true);
                }

                // Clear redirect flag and render
                sessionStorage.removeItem('mmed_auth_pending');
                console.log("Login complete, rendering dashboard...");
                render();
            }

            _showLoading(msg) {
                document.getElementById('app').innerHTML = '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;"><div style="text-align:center;"><div class="spinner"></div><p style="color:#6b7280;font-size:1.1em;">'+msg+'</p></div></div>';
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('mmed_tracker_data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.account = data.account || null;
                        this.modules = data.modules || {};
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                        this.logbook = data.logbook || {};
                    }
                    moduleConfigs.forEach(m => {
                        if (!this.modules[m.id]) this.modules[m.id] = { assignments: {}, weeks: {}, caseReports: {} };
                    });
                } catch (e) { console.error("Data load failed", e); }
            }

            saveData(skipCloud = false) {
                const data = { account: this.account, modules: this.modules, procedureLog: this.procedureLog, milestones: this.milestones, logbook: this.logbook };
                localStorage.setItem('mmed_tracker_data', JSON.stringify(data));
                if (!skipCloud && this.account && this.db && this.account.id) {
                    this.db.collection('users').doc(this.account.id).set(data, { merge: true }).catch(e => console.error("Cloud Save Failed:", e));
                }
                this.notify();
            }

            exportData() {
                const dataStr = localStorage.getItem('mmed_tracker_data');
                if (!dataStr) return alert('No data to export!');
                if (this.account) { this.account.lastBackup = Date.now(); this.saveData(); }
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'mmed_backup_' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url); render();
            }

            importData(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm('Replace current data with backup from ' + (data.account ? data.account.name : 'file') + '? This cannot be undone.')) {
                            localStorage.setItem('mmed_tracker_data', JSON.stringify(data));
                            location.reload();
                        }
                    } catch (err) { alert('Error importing: ' + err.message); }
                };
                reader.readAsText(file); input.value = '';
            }

            // REDIRECT auth (popup has COOP issues on GitHub Pages)
            signInWithGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                sessionStorage.setItem('mmed_auth_pending', 'true');
                this.auth.signInWithRedirect(provider);
            }

            signInWithEmail() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (!email || !password) return alert("Please enter email and password.");
                this.auth.signInWithEmailAndPassword(email, password).catch(error => {
                    if (error.code === 'auth/user-not-found') {
                        if (confirm("No user found. Create a new account?")) this.signUpWithEmail(email, password);
                    } else { alert("Login Failed: " + error.message); }
                });
            }

            signUpWithEmail(email, password) {
                this.auth.createUserWithEmailAndPassword(email, password)
                    .then(() => alert("Account Created!"))
                    .catch(error => alert("Signup Failed: " + error.message));
            }

            logout() {
                this._loginProcessed = false;
                sessionStorage.removeItem('mmed_auth_pending');
                if (this.auth) this.auth.signOut();
                this.account = null;
                localStorage.removeItem('mmed_tracker_data');
                location.reload();
            }

            updateModuleData(moduleId, type, id, value) {
                if (!this.modules[moduleId]) this.modules[moduleId] = { assignments: {}, weeks: {}, caseReports: {} };
                if (type === 'week') {
                    if (!this.modules[moduleId].weeks) this.modules[moduleId].weeks = {};
                    if (!this.modules[moduleId].weeks[id]) this.modules[moduleId].weeks[id] = {};
                    if (typeof value === 'object') this.modules[moduleId].weeks[id] = { ...this.modules[moduleId].weeks[id], ...value };
                    else this.modules[moduleId].weeks[id].status = value;
                } else if (type === 'assignment') {
                    if (!this.modules[moduleId].assignments) this.modules[moduleId].assignments = {};
                    if (!this.modules[moduleId].assignments[id]) this.modules[moduleId].assignments[id] = {};
                    this.modules[moduleId].assignments[id] = { ...this.modules[moduleId].assignments[id], ...value };
                } else if (type === 'caseReport') {
                    if (!this.modules[moduleId].caseReports) this.modules[moduleId].caseReports = {};
                    this.modules[moduleId].caseReports[id] = value;
                }
                this.saveData();
            }

            addProcedure(data) { this.procedureLog.push({ ...data, timestamp: Date.now() }); this.saveData(); render(); }

            logProcedure(moduleId) {
                const lastSup = this.procedureLog.length > 0 ? this.procedureLog[this.procedureLog.length - 1].supervisor : '';
                const date = prompt("Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]); if (!date) return;
                const procedure = prompt("Procedure Name:"); if (!procedure) return;
                const supervisor = prompt("Supervisor:", lastSup); if (!supervisor) return;
                this.addProcedure({ moduleId, date, procedure, supervisor });
            }

            updateMilestone(category, id, value, date) {
                if (!this.milestones[category]) this.milestones[category] = {};
                this.milestones[category][id] = { status: value, date: date }; this.saveData();
            }

            updateLogbook(id, value) { this.logbook[id] = value; this.saveData(); render(); }
            notify() { this.listeners.forEach(l => l()); }
            subscribe(l) { this.listeners.push(l); }
        }

        const state = new AppState();

        function renderLogin() {
            const app = document.getElementById('app');
            // Show loading if returning from redirect
            if (sessionStorage.getItem('mmed_auth_pending') && !state._authReady) {
                state._showLoading("Completing sign-in...");
                return;
            }
            sessionStorage.removeItem('mmed_auth_pending');

            app.innerHTML = '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;"><div style="background:white;padding:40px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.1);width:100%;max-width:400px;border-top:6px solid var(--forest-green);text-align:center;"><h1 style="color:var(--forest-green);font-size:1.6em;font-weight:bold;margin-bottom:10px;">Master of Medicine (Rural)</h1><p style="color:#6b7280;font-size:0.9em;margin-bottom:30px;">Cloud-Synced Portfolio</p><div style="margin-bottom:20px;text-align:left;"><input type="email" id="email" placeholder="Email Address" style="margin-bottom:10px;"><input type="password" id="password" placeholder="Password" style="margin-bottom:15px;"><button onclick="state.signInWithEmail()" class="btn-rural" style="width:100%;margin-bottom:10px;">Sign In / Sign Up</button></div><div style="display:flex;align-items:center;margin:20px 0;color:#9ca3af;"><div style="flex:1;height:1px;background:#e5e7eb;"></div><span style="padding:0 10px;font-size:0.8em;">OR</span><div style="flex:1;height:1px;background:#e5e7eb;"></div></div><button onclick="state.signInWithGoogle()" style="background:white;color:#374151;border:1px solid #d1d5db;padding:12px 20px;border-radius:6px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;width:100%;box-shadow:0 1px 2px rgba(0,0,0,0.05);"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with Google</button><div style="margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb;"><button onclick="document.getElementById(\'importInput\').click()" style="background:none;border:none;cursor:pointer;font-size:0.9em;color:var(--forest-green);text-decoration:underline;">üì• Import Backup</button><input type="file" id="importInput" style="display:none" onchange="state.importData(this)" accept=".json"></div><div style="margin-top:20px;background:#fff7ed;padding:10px;border-radius:6px;font-size:0.8em;color:#c2410c;border:1px solid #ffedd5;">Note: First time validation requires internet.</div></div></div>';
        }

        function renderModuleDetail(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const data = state.modules[moduleId] || { assignments: {}, weeks: {}, caseReports: {} };
            return '<div style="padding:20px;max-width:1000px;margin:auto;"><div style="background:'+config.color+';color:white;padding:30px;border-radius:12px;margin-bottom:30px;"><h1>'+config.name+'</h1><p>Rotation Duration: '+config.duration+'</p></div>' +
                (config.weeks ? '<div style="background:white;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px;"><h3 style="color:var(--clay);margin-bottom:15px;">Weekly Clinical Schedule</h3><div style="display:grid;gap:10px;">' +
                config.weeks.map(w => {
                    const wData = (data.weeks && data.weeks[w.id]) || {};
                    const wStatus = wData.status || 'Not Started';
                    return '<div style="padding:15px;background:'+(wStatus==='Completed'?'#dcfce7':wStatus==='Pending'?'#fef9c3':'white')+';border-radius:8px;margin-bottom:10px;border:1px solid '+(wStatus==='Completed'?'#bbf7d0':'#e5e7eb')+';"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><div><span style="font-weight:bold;color:var(--forest-green);margin-right:10px;">'+w.id.toUpperCase()+'</span><span style="font-weight:600;color:#374151;">'+w.title+'</span></div><select onchange="state.updateModuleData(\''+moduleId+'\',\'week\',\''+w.id+'\',{status:this.value})" style="padding:6px 12px;border-radius:6px;border:1px solid #d1d5db;cursor:pointer;font-weight:500;'+(wStatus==='Completed'?'background:#15803d;color:white':wStatus==='Pending'?'background:#ca8a04;color:white':'color:#6b7280')+'"><option value="Not Started" '+(wStatus==='Not Started'?'selected':'')+'>Not Started</option><option value="Pending" '+(wStatus==='Pending'?'selected':'')+'>Pending</option><option value="Completed" '+(wStatus==='Completed'?'selected':'')+'>Completed</option></select></div><div style="display:flex;gap:20px;font-size:0.9em;color:#6b7280;background:#f9fafb;padding:10px;border-radius:6px;"><div style="display:flex;align-items:center;gap:8px;"><span style="font-weight:500;">Start:</span><input type="date" value="'+(wData.startDate||'')+'" onchange="state.updateModuleData(\''+moduleId+'\',\'week\',\''+w.id+'\',{startDate:this.value'+( wStatus==='Not Started'?',status:\'Pending\'':'')+'})" style="padding:5px;border:1px solid #d1d5db;border-radius:4px;color:#374151;"></div><div style="display:flex;align-items:center;gap:8px;"><span style="font-weight:500;">End:</span><input type="date" value="'+(wData.completeDate||'')+'" onchange="state.updateModuleData(\''+moduleId+'\',\'week\',\''+w.id+'\',{completeDate:this.value,status:\'Completed\'})" style="padding:5px;border:1px solid #d1d5db;border-radius:4px;color:#374151;"></div></div></div>';
                }).join('') + '</div></div>' : '') +
                (config.caseReports ? '<div style="background:white;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px;"><h3 style="color:var(--clay);margin-bottom:15px;">Required Case Reports</h3><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;">' +
                config.caseReports.map((cr,i) => {
                    const crId = 'cr_'+i;
                    const isDone = data.caseReports && data.caseReports[crId] === 'Done';
                    return '<div onclick="state.updateModuleData(\''+moduleId+'\',\'caseReport\',\''+crId+'\',\''+(isDone?'':'Done')+'\')" style="padding:15px;border:1px solid '+(isDone?'#22c55e':'#e5e7eb')+';background:'+(isDone?'#f0fdf4':'white')+';border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:10px;"><div style="width:20px;height:20px;border-radius:50%;border:2px solid #22c55e;background:'+(isDone?'#22c55e':'white')+';display:flex;justify-content:center;align-items:center;font-size:12px;color:white;">'+(isDone?'‚úì':'')+'</div><span style="'+(isDone?'font-weight:bold;color:#15803d':'')+'">'+cr+'</span></div>';
                }).join('') + '</div></div>' : '') +
                (config.assignmentList && config.assignmentList.length > 0 ? '<h3 style="color:var(--clay);border-bottom:2px solid var(--clay);display:inline-block;margin-bottom:20px;">Assignments Tracking</h3><div style="display:grid;gap:20px;">' +
                config.assignmentList.map((a,i) => {
                    const aId = 'assign_'+i;
                    const aData = (data.assignments && data.assignments[aId]) || {};
                    const title = typeof a === 'string' ? a : a.title;
                    const prompt = typeof a === 'string' ? '' : a.prompt;
                    return '<div style="background:white;padding:20px;border-radius:8px;border:1px solid #e5e7eb;box-shadow:0 2px 4px rgba(0,0,0,0.05);"><h4 style="font-weight:bold;margin-bottom:5px;">'+title+'</h4>'+(prompt?'<p style="font-size:0.9em;color:#6b7280;margin-bottom:15px;">'+prompt+'</p>':'')+'<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;"><div><label style="font-size:0.7em;font-weight:bold;color:var(--clay);">STARTED</label><input type="date" value="'+(aData.dateStarted||'')+'" onchange="state.updateModuleData(\''+moduleId+'\',\'assignment\',\''+aId+'\',{dateStarted:this.value})"></div><div><label style="font-size:0.7em;font-weight:bold;color:var(--clay);">SUBMITTED</label><input type="date" value="'+(aData.dateSubmitted||'')+'" onchange="state.updateModuleData(\''+moduleId+'\',\'assignment\',\''+aId+'\',{dateSubmitted:this.value})"></div></div></div>';
                }).join('') + '</div>' : '') +
                '<div style="background:white;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-top:20px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;"><h3 style="color:var(--clay);">Procedure Log</h3><div style="display:flex;gap:10px;"><button onclick="renderPrintView(\''+moduleId+'\')" style="background:#f3f4f6;color:#4b5563;border:1px solid #d1d5db;padding:8px 15px;border-radius:6px;cursor:pointer;font-size:0.9em;">üñ®Ô∏è Print</button><button onclick="state.logProcedure(\''+moduleId+'\')" class="btn-rural" style="font-size:0.9em;">+ Log New</button></div></div><p><strong>Goal:</strong> '+state.procedureLog.filter(p=>p.moduleId===moduleId).length+' / '+(config.procedures||0)+'</p><div style="margin-top:15px;display:grid;gap:10px;">' +
                state.procedureLog.filter(p=>p.moduleId===moduleId).map(p => '<div style="padding:10px;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;font-size:0.9em;"><strong>'+p.date+'</strong>: '+p.procedure+' <span style="color:#6b7280;">(Supervisor: '+p.supervisor+')</span></div>').join('') +
                (state.procedureLog.filter(p=>p.moduleId===moduleId).length===0?'<p style="color:#9ca3af;font-style:italic;">No procedures logged yet.</p>':'') +
                '</div></div></div>';
        }

        function renderPrintView(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const logs = state.procedureLog.filter(p => p.moduleId === moduleId);
            document.getElementById('app').innerHTML = '<div style="padding:40px;max-width:800px;margin:auto;background:white;min-height:100vh;"><div style="text-align:center;margin-bottom:30px;border-bottom:2px solid #15803d;padding-bottom:20px;"><h1 style="color:#15803d;margin:0;">Master of Medicine (Rural)</h1><h2 style="color:#4b5563;margin:5px 0 0 0;">'+config.name+' Logbook</h2><p style="margin-top:10px;"><strong>Student:</strong> '+state.account.name+'</p></div><table style="width:100%;border-collapse:collapse;margin-bottom:30px;"><thead><tr style="background:#f3f4f6;text-align:left;"><th style="border:1px solid #d1d5db;padding:10px;">Date</th><th style="border:1px solid #d1d5db;padding:10px;">Procedure</th><th style="border:1px solid #d1d5db;padding:10px;">Supervisor</th><th style="border:1px solid #d1d5db;padding:10px;width:150px;">Signature</th></tr></thead><tbody>' +
                logs.map(p => '<tr><td style="border:1px solid #d1d5db;padding:10px;">'+p.date+'</td><td style="border:1px solid #d1d5db;padding:10px;">'+p.procedure+'</td><td style="border:1px solid #d1d5db;padding:10px;">'+p.supervisor+'</td><td style="border:1px solid #d1d5db;padding:10px;"></td></tr>').join('') +
                (logs.length===0?'<tr><td colspan="4" style="text-align:center;padding:20px;color:#9ca3af;">No procedures logged yet.</td></tr>':'') +
                '</tbody></table><div class="no-print" style="text-align:center;position:fixed;bottom:20px;left:0;width:100%;"><button onclick="window.print()" style="background:#15803d;color:white;border:none;padding:12px 25px;border-radius:6px;font-weight:bold;cursor:pointer;margin-right:10px;">üñ®Ô∏è Print Now</button><button onclick="render()" style="background:#f3f4f6;color:#4b5563;border:1px solid #d1d5db;padding:12px 25px;border-radius:6px;cursor:pointer;">‚ùå Close</button></div></div>';
        }

        function renderMilestones() {
            return '<div style="padding:30px;max-width:1000px;margin:auto;"><h1 style="color:var(--forest-green);margin-bottom:30px;">Milestones & Progress</h1>' +
                Object.keys(milestoneConfigs).map(cat => '<div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);"><h3 style="text-transform:uppercase;color:var(--clay);letter-spacing:1px;margin-bottom:15px;">'+cat+'</h3><div style="display:grid;gap:10px;">' +
                milestoneConfigs[cat].map(m => {
                    const mData = state.milestones[cat] && state.milestones[cat][m.id] ? state.milestones[cat][m.id] : {};
                    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f9fafb;border-radius:8px;"><span style="font-weight:600;">'+m.label+'</span><div style="display:flex;gap:10px;"><select onchange="state.updateMilestone(\''+cat+'\',\''+m.id+'\',this.value,document.getElementById(\'d_'+m.id+'\').value)" style="width:auto;padding:5px;border-radius:4px;'+(mData.status==='Done'||mData.status==='Passed'?'background:#dcfce7;color:#166534':'')+'"><option value="Not Started" '+(mData.status!=='Done'&&mData.status!=='Passed'?'selected':'')+'>Pending</option><option value="'+(cat==='exams'?'Passed':'Done')+'" '+(mData.status==='Done'||mData.status==='Passed'?'selected':'')+'>'+(cat==='exams'?'Passed':'Done')+'</option></select><input type="date" id="d_'+m.id+'" value="'+(mData.date||'')+'" style="width:auto;" onchange="state.updateMilestone(\''+cat+'\',\''+m.id+'\',this.previousElementSibling.value,this.value)"></div></div>';
                }).join('') + '</div></div>').join('') + '</div>';
        }

        function renderMasterLogbook() {
            return '<div style="padding:30px;max-width:1000px;margin:auto;"><h1 style="color:var(--forest-green);margin-bottom:10px;">Master Logbook Checklist</h1><p style="color:#6b7280;margin-bottom:30px;">Track your progress against graduation requirements.</p>' +
                masterLogbookConfig.map(cat => '<div style="background:white;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);"><h3 style="color:#15803d;border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:15px;">'+cat.category+'</h3><div style="display:grid;gap:12px;">' +
                cat.items.map(item => {
                    const val = state.logbook[item.id] || 0;
                    const isDone = val >= item.target;
                    const pct = Math.min(100, Math.round((val/item.target)*100));
                    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:'+(isDone?'#f0fdf4':'#f9fafb')+';border-radius:6px;border:1px solid '+(isDone?'#bbf7d0':'#e5e7eb')+';"><div style="flex:1;"><div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="font-weight:500;color:'+(isDone?'#15803d':'#374151')+';">'+item.label+'</span><span style="font-size:0.9em;color:'+(isDone?'#15803d':'#6b7280')+';margin-right:15px;">'+val+' / '+item.target+'</span></div><div style="background:#e5e7eb;height:6px;border-radius:99px;width:100%;max-width:300px;"><div style="background:'+(isDone?'#22c55e':'#3b82f6')+';height:6px;border-radius:99px;width:'+pct+'%;"></div></div></div><div style="margin-left:20px;"><input type="number" min="0" value="'+val+'" onchange="state.updateLogbook(\''+item.id+'\',parseInt(this.value)||0)" style="width:70px;padding:6px;border:1px solid #d1d5db;border-radius:4px;text-align:center;"></div></div>';
                }).join('') + '</div></div>').join('') +
                '<div style="margin-top:40px;text-align:center;"><button onclick="window.print()" class="btn-rural">üñ®Ô∏è Print Master Logbook</button></div></div>';
        }

        function render() {
            if (!state.account) { renderLogin(); return; }

            const app = document.getElementById('app');
            app.innerHTML = '<div class="mobile-header no-print"><button onclick="toggleSidebar()" style="background:none;border:none;color:white;font-size:1.5em;cursor:pointer;">‚ò∞</button><span style="font-weight:bold;font-size:1.1em;">MMED Rural</span><div style="width:24px;"></div></div>' +
                '<div style="display:flex;min-height:100vh;"><div id="mobile-overlay" onclick="toggleSidebar()"></div>' +
                '<div id="sidebar" class="no-print" style="width:260px;background:var(--earth-black);color:white;padding:20px;display:flex;flex-direction:column;min-height:100vh;"><div style="display:flex;justify-content:space-between;align-items:center;"><h2 style="color:var(--forest-green);margin-bottom:30px;font-weight:bold;">MMED Rural</h2><button onclick="toggleSidebar()" style="background:none;border:none;color:#6b7280;font-size:1.5em;cursor:pointer;">√ó</button></div>' +
                '<button onclick="state.activeTab=\'dashboard\';render();closeSidebarMobile()" style="width:100%;text-align:left;background:none;border:none;color:white;padding:10px;cursor:pointer;">üìä Dashboard</button>' +
                '<button onclick="state.activeTab=\'master_logbook\';render();closeSidebarMobile()" style="width:100%;text-align:left;background:none;border:none;color:white;padding:10px;cursor:pointer;">üìã Master Logbook</button>' +
                '<button onclick="state.activeTab=\'milestones\';render();closeSidebarMobile()" style="width:100%;text-align:left;background:none;border:none;color:white;padding:10px;cursor:pointer;">üèÅ Milestones</button>' +
                '<hr style="margin:20px 0;border:0;border-top:1px solid #374151;">' +
                '<div style="flex:1;overflow-y:auto;"><p style="font-size:0.7em;color:#9ca3af;margin-bottom:10px;letter-spacing:1px;">MODULES</p>' +
                moduleConfigs.map(m => '<button onclick="state.activeTab=\''+m.id+'\';render();closeSidebarMobile()" style="width:100%;text-align:left;background:none;border:none;color:#d1d5db;padding:8px;cursor:pointer;font-size:0.9em;">‚Ä¢ '+m.name+'</button>').join('') +
                '</div><div style="margin-top:auto;"><button onclick="state.exportData()" style="width:100%;text-align:left;background:none;border:none;color:#fbbf24;padding:8px;cursor:pointer;font-size:0.9em;margin-bottom:10px;">üì• Backup Data</button><button onclick="state.logout()" style="color:#f87171;background:none;border:none;cursor:pointer;">üö™ Sign Out</button></div></div>' +
                '<div style="flex:1;overflow-y:auto;height:100vh;">' +
                (state.activeTab === 'dashboard' ?
                    '<div style="padding:40px;"><h1 style="color:var(--forest-green);">Welcome, Dr. '+state.account.name+'</h1><p style="color:#6b7280;">Masters in Medicine (Rural) | Year '+state.account.year+'</p>' +
                    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:30px;">' +
                    '<div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,0.05);border-top:4px solid var(--forest-green);"><h3 style="color:#6b7280;font-size:0.9em;text-transform:uppercase;">Assignments</h3><p style="font-size:2em;font-weight:bold;color:var(--earth-black);">'+Object.values(state.modules).reduce((acc,m)=>acc+(m.assignments?Object.values(m.assignments).filter(a=>a.dateSubmitted).length:0),0)+' <span style="font-size:0.5em;color:#9ca3af;">/ '+moduleConfigs.reduce((acc,m)=>acc+(m.assignmentList?m.assignmentList.length:0),0)+'</span></p></div>' +
                    '<div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,0.05);border-top:4px solid var(--forest-green);"><h3 style="color:#6b7280;font-size:0.9em;text-transform:uppercase;">Procedures</h3><p style="font-size:2em;font-weight:bold;color:var(--earth-black);">'+state.procedureLog.length+' <span style="font-size:0.5em;color:#9ca3af;">/ '+moduleConfigs.reduce((acc,m)=>acc+(m.procedures||0),0)+'</span></p></div></div>' +
                    '<div style="margin-top:30px;background:white;padding:20px;border-radius:12px;border-left:5px solid var(--accent-orange);"><h3 style="color:var(--clay);">Academic Status</h3><p style="font-size:0.9em;">Ensure all procedure logs are signed by supervisors before rotation end.</p></div>' +
                    '<div style="margin-top:30px;background:white;padding:20px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);"><h3 style="color:var(--forest-green);margin-bottom:15px;">Your Profile</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;"><div><label style="font-size:0.8em;font-weight:bold;color:#6b7280;">Display Name</label><input type="text" value="'+state.account.name+'" onchange="state.account.name=this.value;state.saveData();" style="margin-top:5px;"></div><div><label style="font-size:0.8em;font-weight:bold;color:#6b7280;">Current Year (1-6)</label><select onchange="state.account.year=parseInt(this.value);state.saveData();render();" style="margin-top:5px;">' +
                    [1,2,3,4,5,6].map(y => '<option value="'+y+'" '+(state.account.year===y?'selected':'')+'>Year '+y+'</option>').join('') +
                    '</select></div></div><p style="margin-top:10px;font-size:0.8em;color:#9ca3af;">Updates are auto-saved to cloud.</p></div></div>'
                : state.activeTab === 'milestones' ? renderMilestones()
                : state.activeTab === 'master_logbook' ? renderMasterLogbook()
                : renderModuleDetail(state.activeTab)) +
                '</div>' +
                '<button onclick="showQuickLogModal()" style="position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--forest-green);color:white;border:none;box-shadow:0 4px 10px rgba(0,0,0,0.3);font-size:30px;cursor:pointer;display:flex;justify-content:center;align-items:center;z-index:999;" onmouseover="this.style.transform=\'scale(1.1)\'" onmouseout="this.style.transform=\'scale(1)\'">+</button></div>';

            // Backup reminder
            if (state.account && state.account.lastBackup) {
                const days = (Date.now() - state.account.lastBackup) / 86400000;
                if (days > 7 && !document.getElementById('backup-notice')) {
                    const n = document.createElement('div'); n.id = 'backup-notice';
                    n.innerHTML = '<div style="position:fixed;bottom:20px;left:20px;right:20px;background:#fff7ed;border:1px solid #ffedd5;padding:15px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;z-index:2000;"><div><strong style="color:#9a3412;">‚ö†Ô∏è Backup Reminder</strong><p style="font-size:0.9em;color:#c2410c;margin:0;">It has been over 7 days since your last backup.</p></div><div style="display:flex;gap:10px;"><button onclick="state.exportData();document.getElementById(\'backup-notice\').remove()" style="background:#ea580c;color:white;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;">Backup Now</button><button onclick="document.getElementById(\'backup-notice\').remove()" style="background:none;border:none;color:#9a3412;font-size:1.2em;cursor:pointer;">√ó</button></div></div>';
                    document.body.appendChild(n);
                }
            }
        }

        function showQuickLogModal() {
            const modal = document.createElement('div');
            modal.id = 'quickLogModal'; modal.className = 'modal-overlay';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(2px);';
            const procs = ['Cannulation','IV Fluids','IM Injection','Suture','Cast/Backslab','CPR','Needle Decompression','Incision & Drainage','Normal Delivery','Vaginal Tear Repair','Twins Delivery','Vacuum','Manual Placenta Removal','C-Section','Laparotomy','Ultrasound'];
            const lastSup = state.procedureLog.length > 0 ? state.procedureLog[state.procedureLog.length-1].supervisor : '';
            modal.innerHTML = '<div style="background:white;border-radius:12px;padding:30px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><h2 style="font-size:1.5em;font-weight:bold;color:var(--forest-green);">‚ö° Quick Log</h2><button onclick="document.getElementById(\'quickLogModal\').remove()" style="background:none;border:none;font-size:1.5em;cursor:pointer;color:#6b7280;">√ó</button></div><form onsubmit="event.preventDefault();submitQuickLog(this);"><div style="display:grid;gap:15px;"><div><label style="font-size:0.9em;font-weight:600;color:#374151;">Module</label><select name="module" required style="padding:10px;border:1px solid #d1d5db;border-radius:6px;background:white;"><option value="" disabled selected>Select Module</option>'+moduleConfigs.map(m=>'<option value="'+m.id+'" '+(state.activeTab===m.id?'selected':'')+'>'+m.name+'</option>').join('')+'</select></div><div><label style="font-size:0.9em;font-weight:600;color:#374151;">Date</label><input type="date" name="date" required value="'+new Date().toISOString().split('T')[0]+'" style="padding:10px;border:1px solid #d1d5db;border-radius:6px;"></div><div><label style="font-size:0.9em;font-weight:600;color:#374151;">Procedure</label><div style="display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;">'+procs.map(p=>'<button type="button" onclick="setProcedureName(\''+p+'\')" style="padding:6px 12px;border-radius:99px;border:1px solid #d1d5db;background:#f3f4f6;font-size:0.85em;cursor:pointer;color:#374151;">'+p+'</button>').join('')+'</div><input type="text" id="quickProcName" name="procedure" placeholder="Type procedure name..." required style="padding:12px;border:1px solid #d1d5db;border-radius:6px;font-size:1em;"></div><div><label style="font-size:0.9em;font-weight:600;color:#374151;">Supervisor</label><input type="text" name="supervisor" placeholder="Supervisor Name" value="'+lastSup+'" required style="padding:10px;border:1px solid #d1d5db;border-radius:6px;"></div><textarea name="notes" placeholder="Notes (Optional)" rows="2" style="padding:10px;border:1px solid #d1d5db;border-radius:6px;font-family:inherit;"></textarea><button type="submit" class="btn-rural" style="padding:12px;">‚úÖ Save Procedure</button></div></form></div>';
            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
            setTimeout(() => document.getElementById('quickProcName').focus(), 100);
        }

        window.setProcedureName = name => {
            const input = document.getElementById('quickProcName');
            input.value = name; input.style.borderColor = '#15803d'; input.style.backgroundColor = '#f0fdf4';
            setTimeout(() => { input.style.borderColor = '#d1d5db'; input.style.backgroundColor = 'white'; }, 500);
        };

        window.submitQuickLog = form => {
            state.addProcedure({ moduleId: form.module.value, date: form.date.value, procedure: form.procedure.value, supervisor: form.supervisor.value, notes: form.notes.value });
            const toast = document.createElement('div');
            toast.textContent = 'Procedure Logged!';
            toast.style.cssText = 'position:fixed;bottom:100px;right:30px;background:#15803d;color:white;padding:12px 24px;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.2);z-index:2000;';
            document.body.appendChild(toast); setTimeout(() => toast.remove(), 2000);
            document.getElementById('quickLogModal').remove(); render();
        };

        state.subscribe(render);
        render();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(r => console.log('SW registered')).catch(e => console.log('SW skipped:', e.message));
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('open');
        }
        function closeSidebarMobile() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('mobile-overlay').classList.remove('open');
            }
        }
    </script>
</body>
</html>
