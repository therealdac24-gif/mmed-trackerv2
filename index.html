<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Electronic Logbook</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <!-- Removed Tailwind CDN for Offline Support -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }

        button {
            font-family: inherit;
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* Modal Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-overlay {
            animation: fadeIn 0.15s ease-out;
        }
    </style>
</head>

<body>
    <div id="app"></div>
    <script>
        // --- Configuration ---
        let moduleConfigs = [
            {
                id: 'surgery',
                // ... (content is huge, I should use a smaller chunk or just change the declaration line if possible, but I need to be careful with replace_file_content constraints)
                // actually, I can just replace the definition line, and then the AppState separately.

                name: 'Surgery (Module 1)',
                color: '#15803d', // Forest Green
                duration: '9 months',
                procedures: 45,
                type: 'clinical',
                weeks: [
                    { id: 'w1', title: 'Trauma Assessment & Shock' },
                    { id: 'w2', title: 'Antibiotics & Pre-op Prep' },
                    { id: 'w3', title: 'Instruments & Sterilization' },
                    { id: 'w4', title: 'Theatre Setup (Case: Stab wound)' },
                    { id: 'w5', title: 'Acute Pain' },
                    { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Wounds & Suturing' },
                    { id: 'w8', title: 'Transfer Principles' },
                    { id: 'w9', title: 'Pyomyositis & Osteo' },
                    { id: 'w10', title: 'Chest Drains' },
                    { id: 'w11', title: 'Closed Fractures' },
                    { id: 'w12', title: 'Neurovascular & Secondary Intention' },
                    { id: 'w13', title: 'Dental/Airway Infections' },
                    { id: 'w14', title: 'Abscesses' },
                    { id: 'w15', title: 'Appendicitis' },
                    { id: 'w16', title: 'Laparotomy Basics' },
                    { id: 'w17', title: 'Gut Repair' },
                    { id: 'w18', title: 'Stomas & Ulcers' },
                    { id: 'w19', title: 'Bowel Obstruction' },
                    { id: 'w20', title: 'Casting & Splinting' },
                    { id: 'w21', title: 'Traction' },
                    { id: 'w22', title: 'Open Fractures' },
                    { id: 'w23', title: 'Dislocations' },
                    { id: 'w24', title: 'Upper Limb Trauma' },
                    { id: 'w25', title: 'Bleeding Control' },
                    { id: 'w26', title: 'Enucleation' },
                    { id: 'w27', title: 'Hernia Repair' },
                    { id: 'w28', title: 'Strangulated Hernia' },
                    { id: 'w29', title: 'Minor Procedures' },
                    { id: 'w30', title: 'Head & Spinal Injury' },
                    { id: 'w31', title: 'Burns' },
                    { id: 'w32', title: 'Ethics' }
                ],
                assignmentList: [
                    { title: '1. Cancer', prompt: 'What is cancer and how does it develop?' },
                    { title: '2. Cancer Screening', prompt: 'Pros/cons of screening program in PNG (e.g. breast cancer).' },
                    { title: '3. Blood / Haemopoiesis', prompt: 'Blood cell development, splenomegaly pathology.' },
                    { title: '4. Blood Transfusion', prompt: 'Risks, safety, cross-match, alternatives.' },
                    { title: '5. Cytokines', prompt: 'Role in wound healing, inflammation, haemostasis, neoplasia.' },
                    { title: '6. Wound Healing', prompt: 'Physiology in abdomen, bowel, bone, tendon.' },
                    { title: '7. Hb & Oxygen Transport', prompt: 'Oxygen dissociation curve, respiratory failure types.' },
                    { title: '8. Genetics', prompt: 'Genetic defects, gene therapy, counselling.' },
                    { title: '9. Nerve Conduction', prompt: 'Peripheral nerve injuries, diagnosis, assessment.' },
                    { title: '10. Pain', prompt: 'Pathways, analgesics, local anaesthetics.' },
                    { title: '11. Urodynamics', prompt: 'Incontinence, spinal cord injury, bladder function.' },
                    { title: '12. CSF & ICP', prompt: 'Pathophysiology of raised intracranial pressure.' },
                    { title: '13. Calcium Homeostasis', prompt: 'Renal calculi, hypercalcemia, osteoporosis.' },
                    { title: '14. Liver Function', prompt: 'Portal hypertension, cirrhosis, ascites, encephalopathy.' },
                    { title: '15. Bile & Gallstones', prompt: 'Bile composition, gallbladder function, stones.' },
                    { title: '16. Oedema', prompt: 'Pathophysiology of unilateral leg swelling.' },
                    { title: '17. Thrombosis', prompt: 'Thrombosis, embolism, anticoagulants.' },
                    { title: '18. Gastric Secretion', prompt: 'Physiology, H. pylori, ulcer, cancer.' },
                    { title: '19. Surgical Infections', prompt: 'Osteomyelitis, HIV, TB, Necrotising Fasciitis.' },
                    { title: '20. Antibiotics Policy', prompt: 'Antibiotic policy recommendations and monitoring.' }
                ]
            },
            {
                id: 'anaesthesia',
                name: 'Anaesthesiology (Module 2)',
                color: '#64748b', // Slate is fine, or Earthy
                duration: '4 months',
                procedures: 50,
                type: 'clinical',
                weeks: [
                    { id: 'w1', title: 'Machine Check & Equipment' },
                    { id: 'w2', title: 'Ketamine (Pharma & Use)' },
                    { id: 'w3', title: 'Propofol & Benzos' },
                    { id: 'w4', title: 'Pre-op Assessment' },
                    { id: 'w5', title: 'Opiates & Deferring Surgery' },
                    { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Spinal & LUSCS' },
                    { id: 'w8', title: 'Brachial Plexus Blocks' },
                    { id: 'w9', title: 'Wrist/Ankle Blocks' },
                    { id: 'w10', title: 'Neonatal Resuscitation' },
                    { id: 'w11', title: 'Can\'t Intubate/Ventilate' },
                    { id: 'w12', title: 'IV Access' },
                    { id: 'w13', title: 'Cardiac Arrest' },
                    { id: 'w14', title: 'Handling Negative Outcomes' }
                ],
                caseReports: [
                    'General Anaesthesia', 'Ketamine Anaesthesia', 'Spinal Anaesthesia',
                    'Regional Block', 'Paediatric Anaesthesia', 'Resuscitation'
                ]
            },
            {
                id: 'childhealth',
                name: 'Child Health (Module 3)',
                color: '#f97316',
                duration: '1 month',
                procedures: 30,
                type: 'clinical',
                weeks: [
                    { id: 'w1', title: 'Milestones & Malnutrition' },
                    { id: 'w2', title: 'Pneumonia & Oxygen' },
                    { id: 'w3', title: 'Cardiac & Kidney' },
                    { id: 'w4', title: 'Newborn Exam & Cancer' },
                    { id: 'w5', title: 'Ponsetti & Diarrhoea' },
                    { id: 'w6', title: 'Immunization' }
                ],
                caseReports: [
                    'Pneumonia', 'Diarrhoea', 'Malnutrition', 'Meningitis',
                    'Neonatal Sepsis', 'Low Birth Weight'
                ]
            },
            {
                id: 'obs_gyn',
                name: 'Obstetrics & Gynaecology (Module 4)',
                color: '#ec4899',
                duration: '3 months',
                procedures: 40,
                type: 'clinical',
                weeks: [
                    { id: 'w1', title: 'Menstrual Cycle' },
                    { id: 'w2', title: 'Contraception' },
                    { id: 'w3', title: 'Routine Antenatal' },
                    { id: 'w4', title: 'Basic USS' },
                    { id: 'w5', title: 'Miscarriage/Ectopic' },
                    { id: 'w6', title: 'Normal Labour' },
                    { id: 'w7', title: 'Partograms' },
                    { id: 'w8', title: 'CS Technique' },
                    { id: 'w9', title: 'APH & Pre-eclampsia' },
                    { id: 'w10', title: 'Failure to Progress' },
                    { id: 'w11', title: 'PPH' },
                    { id: 'w12', title: 'Puerperal Sepsis' },
                    { id: 'w13', title: 'Infertility' },
                    { id: 'w15', title: 'Ovarian Tumours' },
                    { id: 'w17', title: 'Endometrial CA' },
                    { id: 'w19', title: 'Cervical CA' },
                    { id: 'w21', title: 'Pelvic Sepsis' },
                    { id: 'w23', title: 'Pre-eclampsia/Eclampsia' },
                    { id: 'w26', title: 'PPH Advanced' },
                    { id: 'w29', title: 'Destructive Delivery' }
                ],
                assignmentList: [
                    { title: 'Written Assignment 1', prompt: 'Choose from: Antenatal Care, Family Planning, or Emergency Obstetric Care' },
                    { title: 'Written Assignment 2', prompt: 'Choose a second topic from the list above.' }
                ]
            },
            {
                id: 'medicine',
                name: 'Internal Medicine (Module 5)',
                color: '#3b82f6',
                duration: '2 months',
                procedures: 20,
                type: 'clinical',
                weeks: [
                    { id: 'w1', title: 'Diabetes' },
                    { id: 'w2', title: 'Antibiotics & Sepsis' },
                    { id: 'w3', title: 'Tuberculosis' },
                    { id: 'w4', title: 'Snake Bite & ECG' },
                    { id: 'w5', title: 'Hypertension & HIV' },
                    { id: 'w6', title: 'Asthma/COAD' }
                ],
                assignmentList: [
                    { title: 'Written Assignment 1', prompt: 'Choose from: HIV, TB, Malaria, or Lifestyle Diseases' },
                    { title: 'Written Assignment 2', prompt: 'Choose a second topic from the list above.' }
                ],
                caseReports: [
                    'Severe Malaria', 'Meningitis', 'Pneumonia',
                    'Heart Failure', 'Snake Bite', 'Tuberculosis'
                ]
            },
            {
                id: 'psychiatry',
                name: 'Psychiatry (Module 6)',
                color: '#a855f7',
                duration: '1 month',
                procedures: 10,
                type: 'clinical',
                caseReports: ['Case: Acute Psychosis', 'Case: Somatoform']
            },
            {
                id: 'publichealth',
                name: 'Public Health (Module 7)',
                color: '#10b981',
                duration: 'Longitudinal',
                procedures: 0,
                type: 'assignment',
                assignmentList: [
                    'PH1: Community Diagnosis', 'PH2: Disease Outbreak Investigation', 'PH3: Health Program Evaluation',
                    'PH4: Health Service Management', 'PH5: Environmental Health'
                ]
            },
            {
                id: 'eye_ent',
                name: 'Eye/ENT (Module 8)',
                color: '#06b6d4',
                duration: '1 month',
                procedures: 15,
                type: 'clinical',
                caseReports: ['Case: Perforating Eye', 'Case: Red Eye', 'Case: Epistaxis']
            },
            {
                id: 'lab',
                name: 'Laboratory (Module 9)',
                color: '#6366f1',
                duration: '1 month',
                procedures: 10,
                type: 'clinical',
                assignmentList: ['Skill: Cross-match', 'Skill: Malaria Stain']
            },
            {
                id: 'management',
                name: 'Management (Module 10)',
                color: '#475569',
                duration: '4 weeks',
                procedures: 0,
                type: 'special',
                assignmentList: ['4-Week Intensive Course', 'Major Assignment (3500 words)']
            }
        ];

        const milestoneConfigs = {
            research: [
                { id: 'res_topic', label: 'Research Topic Approved' },
                { id: 'res_data', label: 'Data Collection Completed' },
                { id: 'res_submit', label: 'Research Submitted' },
                { id: 'res_present', label: 'Research Presented' }
            ],
            management: [
                { id: 'mgmt_course', label: '4-Week Intensive Course' },
                { id: 'mgmt_assign', label: '7,500 Word Assignment' }
            ],
            other: [
                { id: 'solar_course', label: 'Solar/Radio Maintenance Course' }
            ],
            exams: [
                { id: 'exam_part1', label: 'Part 1 Exam Passed' },
                { id: 'exam_part2_written', label: 'Part 2 Written Passed' },
                { id: 'exam_part2_clinical', label: 'Part 2 Clinical Passed' }
            ]
        };

        // --- State Management ---
        class AppState {
            constructor() {
                this.modules = {};
                this.milestones = {};
                this.procedureLog = [];
                this.logbook = {};
                this.sidebarOpen = window.innerWidth > 768;
                this.activeTab = 'dashboard';
                this.listeners = [];
                this.user = null; // { name, id, year, password }
                this.loadData();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('mmed_tracker_data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.modules = data.modules || {};
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                        this.logbook = data.logbook || {};
                        this.account = data.account || null;
                        this.session = null; // Session is always fresh on load
                        this.lastBackupDate = data.lastBackupDate || null;

                        // Load dynamic config if present
                        if (data.moduleConfigs) {
                            moduleConfigs = data.moduleConfigs;
                        }

                        // Ensure all modules exist
                        moduleConfigs.forEach(m => {
                            if (!this.modules[m.id]) this.initModule(m);
                        });
                    } else {
                        // Fresh init
                        this.modules = {};
                        this.milestones = {};
                        this.lastBackupDate = null;
                        moduleConfigs.forEach(m => this.initModule(m));
                    }
                } catch (e) {
                    console.error("Data load failed, resetting:", e);
                    this.modules = {};
                    this.lastBackupDate = null;
                    moduleConfigs.forEach(m => this.initModule(m));
                }
            }

            initModule(m) {
                this.modules[m.id] = {
                    total: m.id === 'surgery' ? 32 : 1, // Default Logic
                    completed: 0,
                    units: {},
                    assignments: {},
                    assignmentsTotal: m.assignmentList ? m.assignmentList.length : 0,
                    procedures: 0,
                    notes: ''
                };
            }

            saveData() {
                localStorage.setItem('mmed_tracker_data', JSON.stringify({
                    modules: this.modules,
                    procedureLog: this.procedureLog,
                    milestones: this.milestones,
                    logbook: this.logbook,
                    moduleConfigs: moduleConfigs,
                    account: this.account,
                    lastBackupDate: this.lastBackupDate,
                    lastSaved: new Date().toISOString()
                }));
                this.notify();
            }

            exportData(toCloud = false) {
                if (toCloud) {
                    // Open Google Drive immediately to avoid popup blockers
                    window.open('https://drive.google.com', '_blank');

                    // Show instruction
                    alert(`1. A Google Drive tab has opened.\n2. Your backup file is downloading now.\n3. Please drag the downloaded file into the Google Drive window.`);
                }

                const data = {
                    modules: this.modules,
                    procedureLog: this.procedureLog,
                    milestones: this.milestones,
                    logbook: this.logbook,
                    moduleConfigs: moduleConfigs,
                    account: this.account,
                    lastBackupDate: new Date().toISOString() // Update backup time
                };

                // Update local status immediately
                this.lastBackupDate = data.lastBackupDate;
                this.saveData();

                // Generate filename
                const filename = `mmed_backup_${new Date().toISOString().split('T')[0]}.json`;

                // Download file
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                if (!toCloud) {
                    alert(`Backup saved to Downloads folder as '${filename}'`);
                }

                // Re-render to clear warning if present
                render();
            }

            importData(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.modules = data.modules || {};
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                        this.logbook = data.logbook || {};
                        this.account = data.account || data.user || null; // Support legacy 'user' key
                        this.lastBackupDate = data.lastBackupDate || new Date().toISOString();

                        if (data.moduleConfigs) {
                            moduleConfigs = data.moduleConfigs;
                        }

                        // Ensure modules exist
                        moduleConfigs.forEach(m => {
                            if (!this.modules[m.id]) this.initModule(m);
                        });

                        this.saveData();
                        alert('Data imported successfully!');
                    } catch (err) {
                        alert('Error importing data. Invalid file format.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            }

            register(name, id, year, password, question, answer) {
                this.account = {
                    name,
                    id,
                    year,
                    password,
                    securityQuestion: question,
                    securityAnswer: answer,
                    needsPasswordChange: true // Default for new activations
                };
                this.session = { isLoggedIn: true };
                this.saveData();
                return true;
            }

            login(id, password) {
                if (!this.account) return false;
                if (this.account.id === id && this.account.password === password) {
                    this.session = { isLoggedIn: true };
                    return true;
                }
                return false;
            }

            logout() {
                this.session = null;
                this.notify();
            }

            changePassword(newPassword) {
                if (this.account) {
                    this.account.password = newPassword;
                    this.account.needsPasswordChange = false;
                    this.saveData();
                }
            }

            resetPassword(id, answer, newPassword) {
                if (!this.account || this.account.id !== id) return false;
                if (this.account.securityAnswer && this.account.securityAnswer.toLowerCase() === answer.toLowerCase()) {
                    this.account.password = newPassword;
                    this.account.needsPasswordChange = false; // Resetting implies they know it now
                    this.saveData();
                    return true;
                }
                return false;
            }

            updateProfile(name, year, password) {
                if (this.account) {
                    this.account.name = name;
                    this.account.year = year;
                    if (password) this.account.password = password;
                    this.saveData();
                }
            }

            subscribe(listener) {
                this.listeners.push(listener);
            }

            // ... updateModule ...

            updateAssignmentList(moduleId, newList) {
                const config = moduleConfigs.find(m => m.id === moduleId);
                if (config) {
                    config.assignmentList = newList;
                    if (this.modules[moduleId]) {
                        this.modules[moduleId].assignmentsTotal = newList.length;
                    }
                    this.saveData();
                }
            }

            updateModule(moduleId, type, data) {
                if (!this.modules[moduleId]) return;
                const mod = this.modules[moduleId];

                if (type === 'unit') {
                    mod.units[data.unitId] = data.status;
                    const doneCount = Object.values(mod.units).filter(s => s === 'Done').length;
                    mod.completed = doneCount;
                } else if (type === 'week') {
                    if (!mod.weeks) mod.weeks = {};
                    if (!mod.weeks[data.id]) mod.weeks[data.id] = {};
                    mod.weeks[data.id][data.field] = data.value;

                    // Update generic completion (optional, or just rely on weeks view)
                    // We could count 'Done' weeks
                } else if (type === 'assignment') {
                } else if (type === 'assignment') {
                    // data: { id, field, value }
                    if (!mod.assignments[data.id]) mod.assignments[data.id] = {};
                    mod.assignments[data.id][data.field] = data.value;

                    // Auto-set status if dates are present (optional logic, but good for UX)
                    if (data.field === 'dateSubmitted' && data.value) {
                        mod.assignments[data.id].status = 'Done';
                    }
                } else if (type === 'caseReport') {
                    if (!mod.caseReports) mod.caseReports = {};
                    if (mod.caseReports[data.id] === 'Done') {
                        delete mod.caseReports[data.id];
                    } else {
                        mod.caseReports[data.id] = 'Done';
                    }
                } else if (type === 'notes') {
                    mod.notes = data;
                } else if (type === 'generic_completion') {
                    mod.completed = data.isComplete ? 1 : 0;
                }
                this.saveData();
            }

            updateMilestone(category, id, value, date) {
                if (!this.milestones[category]) this.milestones[category] = {};
                this.milestones[category][id] = { status: value, date: date };
                this.saveData();
            }

            updateLogbook(id, value) {
                this.logbook[id] = value;
                this.saveData();
            }

            addProcedure(proc) {
                this.procedureLog.unshift({
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    ...proc
                });
                if (this.modules[proc.module]) {
                    this.modules[proc.module].procedures++;
                }
                this.saveData();
            }

            deleteProcedure(id) {
                this.procedureLog = this.procedureLog.filter(p => p.id != id);
                // Note: Decrementing count is complex without knowing module, but we recalc counts in render mostly
                this.saveData();
            }

            notify() {
                this.listeners.forEach(l => l());
            }
        }

        const state = new AppState();

        function calculateOverallProgress() {
            const total = Object.values(state.modules).reduce((acc, m) => acc + m.total, 0);
            const completed = Object.values(state.modules).reduce((acc, m) => acc + m.completed, 0);
            return Math.round((completed / total) * 100);
        }

        function getModuleProgress(moduleId) {
            const mod = state.modules[moduleId];
            const pct = Math.round((mod.completed / mod.total) * 100);
            return Math.min(100, pct);
        }

        function printProcedures(moduleId = null) {
            const procs = moduleId ? state.procedureLog.filter(p => p.module === moduleId) : state.procedureLog;
            const moduleName = moduleId ? moduleConfigs.find(m => m.id === moduleId).name : 'All Modules';

            const win = window.open('', '', 'width=800,height=600');
            win.document.write(`
                <html><head><title>Procedure Log</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
                    th { background: #f3f4f6; }
                    @media print { button { display: none; } }
                </style></head><body>
                <h1 style="color:#15803d; border-bottom: 2px solid #15803d; padding-bottom: 10px;">Master of Medicine (Rural) - Procedure Log</h1>
                <p>Print Date: ${new Date().toLocaleDateString()}</p>
                <p>Trainee: <strong>${state.account ? state.account.name : '_____________________'}</strong> (ID: ${state.account ? state.account.id : '________'})</p>
                <table>
                    <tr><th>#</th><th>Date</th><th>Procedure</th><th>Supervisor</th><th>Notes</th><th>Signature</th></tr>
                    ${procs.map((p, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${new Date(p.date).toLocaleDateString()}</td>
                            <td>${p.name}</td>
                            <td>${p.supervisor}</td>
                            <td>${p.notes || '-'}</td>
                            <td style="width:150px"></td>
                        </tr>
                    `).join('')}
                </table>
                <div style="margin-top:50px;border-top:1px solid #000;width:300px;padding-top:5px">
                    Program Coordinator Signature & Date
                </div>
                <button onclick="window.print()" style="margin-top:20px;padding:10px 20px;background:#2563eb;color:white;border:none;border-radius:5px;cursor:pointer">Print</button>
                </body></html>
            `);
            win.document.close();
        }

        function printProgressReport() {
            const win = window.open('', '', 'width=800,height=600');
            win.document.write(`
                <html><head><title>Progress Report</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
                    .module { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                    .progress-bar { background: #e5e7eb; height: 20px; border-radius: 10px; margin: 10px 0; }
                    .progress-fill { background: #10b981; height: 100%; border-radius: 10px; }
                    @media print { button { display: none; } }
                </style></head><body>
                <h1 style="color:#15803d; border-bottom: 2px solid #15803d; padding-bottom: 10px;">Master of Medicine (Rural) - Progress Report</h1>
                <p>Report Date: ${new Date().toLocaleDateString()}</p>
                <p>Trainee: <strong>${state.account ? state.account.name : '_____________________'}</strong> (ID: ${state.account ? state.account.id : '________'})</p>
                <p>Current Year: ${state.account ? state.account.year : state.currentYear} of 6 | Overall Progress: ${calculateOverallProgress()}%</p>
                <h2>Module Progress</h2>
                ${moduleConfigs.map(m => {
                const mod = state.modules[m.id];
                const prog = getModuleProgress(m.id);
                const procCount = state.procedureLog.filter(p => p.module === m.id).length;
                return `
                        <div class="module">
                            <h3>${m.name}</h3>
                            <div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div>
                            <p>Units: ${mod.completed}/${mod.total} | 
                            ${mod.assignmentsTotal > 0 ? `Assignments: ${mod.assignments}/${mod.assignmentsTotal} | ` : ''}
                            ${m.procedures > 0 ? `Procedures: ${procCount}/${m.procedures}` : ''}</p>
                        </div>
                    `;
            }).join('')}
                <div style="margin-top:50px;border-top:1px solid #000;width:300px;padding-top:5px">
                    Training Supervisor Signature & Date
                </div>
                <button onclick="window.print()" style="margin-top:20px;padding:10px 20px;background:#2563eb;color:white;border:none;border-radius:5px;cursor:pointer">Print</button>
                </body></html>
            `);
            win.document.close();
        }

        function renderDashboard() {
            return `
                <div style="max-width:1200px;margin:0 auto;padding:20px">
            
            <!-- 6 Year Roadmap -->
            <div style="background:white;border-radius:12px;padding:25px;margin-bottom:30px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                <details ${state.account.year === 1 ? 'open' : ''}>
                    <summary style="font-size:1.5em;font-weight:bold;color:#1f2937;cursor:pointer;list-style:none;display:flex;align-items:center;justify-content:space-between">
                        6-Year Program Roadmap
                        <span style="font-size:0.7em;color:#6b7280;font-weight:normal">‚ñº Toggle View</span>
                    </summary>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;margin-top:20px">
                        <div style="background:#eff6ff;padding:15px;border-radius:8px;border-left:4px solid #3b82f6">
                            <span style="display:block;font-weight:bold;color:#1d4ed8;margin-bottom:8px">Years 1-2</span>
                            <p style="font-size:0.9em;color:#374151">Pre-entry: 2 years pre-registration + Full registration.</p>
                        </div>
                        <div style="background:#f0fdf4;padding:15px;border-radius:8px;border-left:4px solid #22c55e">
                            <span style="display:block;font-weight:bold;color:#15803d;margin-bottom:8px">Years 1-3</span>
                            <p style="font-size:0.9em;color:#374151">Part 1 Training (Modules 1-5). Solar Course.</p>
                        </div>
                        <div style="background:#fff7ed;padding:15px;border-radius:8px;border-left:4px solid #ea580c">
                            <span style="display:block;font-weight:bold;color:#c2410c;margin-bottom:8px">End of Year 3</span>
                            <p style="font-size:0.9em;color:#374151">Part 1 Exams (Common Core + Specialty).</p>
                        </div>
                        <div style="background:#faf5ff;padding:15px;border-radius:8px;border-left:4px solid #9333ea">
                            <span style="display:block;font-weight:bold;color:#7e22ce;margin-bottom:8px">Years 4-6</span>
                            <p style="font-size:0.9em;color:#374151">Adv. Training, Research, Management Intensive.</p>
                        </div>
                        <div style="background:#fff1f2;padding:15px;border-radius:8px;border-left:4px solid #e11d48">
                            <span style="display:block;font-weight:bold;color:#be123c;margin-bottom:8px">Final Year</span>
                            <p style="font-size:0.9em;color:#374151">Part 2 Exams & Graduation.</p>
                        </div>
                    </div>
                </details>
            </div>

            <div style="background:linear-gradient(to right, #15803d, #0ea5e9);border-radius:12px;padding:30px;color:white;margin-bottom:20px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)">
                <h1 style="font-size:2em;font-weight:bold;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,0.1)">Master of Medicine (Rural)</h1>
                <p style="opacity:0.9">Year ${state.account ? state.account.year : 1} of 6</p>
                <div style="margin-top:20px">
                    <div style="display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:8px">
                        <span>Overall Progress</span>
                        <span style="font-weight:bold">${calculateOverallProgress()}%</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.2);border-radius:999px;height:12px">
                        <div style="background:white;border-radius:999px;height:12px;width:${calculateOverallProgress()}%;transition:width 0.5s"></div>
                    </div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px">
                <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border-left:4px solid #22c55e">
                    <p style="color:#6b7280;font-size:0.9em">Modules Completed</p>
                    <p style="font-size:2em;font-weight:bold">${Object.values(state.modules).filter(m => m.completed === m.total && m.total > 0).length}/10</p>
                </div>
                <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border-left:4px solid #3b82f6">
                    <p style="color:#6b7280;font-size:0.9em">Procedures Logged</p>
                    <p style="font-size:2em;font-weight:bold">${state.procedureLog.length}</p>
                </div>
            </div>

            <div style="background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                <div style="padding:20px;border-bottom:1px solid #e5e7eb">
                    <h2 style="font-size:1.5em;font-weight:bold">Module Overview</h2>
                </div>
                <div style="padding:20px">
                    ${moduleConfigs.map(m => {
                const mod = state.modules[m.id];
                const prog = getModuleProgress(m.id);
                const procCount = state.procedureLog.filter(p => p.module === m.id).length;
                return `
                            <div style="border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:12px;cursor:pointer;transition:box-shadow 0.2s" 
                                 onmouseover="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'" 
                                 onmouseout="this.style.boxShadow='none'"
                                 onclick="state.activeTab='${m.id}';render()">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <div style="display:flex;align-items:center;gap:12px">
                                        <div style="background:${m.color};color:white;padding:8px;border-radius:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center">
                                            üìä
                                        </div>
                                        <div>
                                            <h3 style="font-weight:600">${m.name}</h3>
                                            <p style="font-size:0.85em;color:#6b7280">${m.duration}</p>
                                        </div>
                                    </div>
                                    <span style="color:#2563eb;font-size:0.9em">View Details ‚Üí</span>
                                </div>
                                <div>
                                    <div style="display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:4px">
                                        <span>Units: ${mod.completed}/${mod.total}</span>
                                        <span style="font-weight:600">${prog}%</span>
                                    </div>
                                    <div style="background:#e5e7eb;border-radius:999px;height:8px">
                                        <div style="background:${m.color};border-radius:999px;height:8px;width:${prog}%;transition:width 0.3s"></div>
                                    </div>
                                    <div style="display:flex;gap:16px;font-size:0.75em;color:#6b7280;margin-top:8px">
                                        ${mod.assignmentsTotal > 0 ? `<span>Assignments: ${mod.assignments}/${mod.assignmentsTotal}</span>` : ''}
                                        ${m.procedures > 0 ? `<span>Procedures: ${procCount}/${m.procedures}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            </div>
        </div>
    `;
        }

        function renderModuleDetail(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const mod = state.modules[moduleId];
            const prog = getModuleProgress(moduleId);
            const procs = state.procedureLog.filter(p => p.module === moduleId);

            // Calculate counts
            const assignTotal = config.assignmentList ? config.assignmentList.length : 0;
            const assignDone = mod.assignments ? Object.keys(mod.assignments).length : 0;

            const weekTotal = config.weeks ? config.weeks.length : 0;
            const weekDone = config.weeks ? Object.values(mod.weeks || {}).filter(w => w.status === 'Done' || w.status === 'Passed').length : 0;

            const caseTotal = config.caseReports ? config.caseReports.length : 0;
            const caseDone = mod.caseReports ? Object.keys(mod.caseReports).length : 0;

            return `
                <div style="max-width:1200px;margin:0 auto;padding:20px">
                    <div style="background:${config.color};border-radius:12px;padding:30px;color:white;margin-bottom:20px">
                        <div style="display:flex;justify-content:space-between;align-items:start">
                            <div>
                                <h1 style="font-size:2em;font-weight:bold;margin-bottom:10px">${config.name}</h1>
                                <p style="opacity:0.9">Duration: ${config.duration}</p>
                            </div>
                            <button onclick="showNotes('${moduleId}')" style="background:rgba(255,255,255,0.2);padding:10px 20px;border:none;border-radius:6px;color:white;cursor:pointer">
                                üìù Notes
                            </button>
                            <button onclick="renderAssignmentEditor('${moduleId}')" style="background:rgba(255,255,255,0.2);padding:10px 20px;border:none;border-radius:6px;color:white;cursor:pointer;margin-left:10px">
                                ‚úèÔ∏è Edit
                            </button>
                        </div>
                        <div style="background:rgba(255,255,255,0.2);border-radius:8px;padding:16px;margin-top:20px">
                            <div style="display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:8px">
                                <span>Module Progress</span>
                                <span style="font-weight:bold">${prog}%</span>
                            </div>
                            <div style="background:rgba(255,255,255,0.2);border-radius:999px;height:12px">
                                <div style="background:white;border-radius:999px;height:12px;width:${prog}%"></div>
                            </div>
                        </div>
                    </div>

                    ${weekTotal > 0 ? `
                    <div style="background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px;padding:20px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                            <h3 style="font-weight:bold;font-size:1.2em">Weekly Schedule (${weekDone}/${weekTotal})</h3>
                        </div>
                        <div style="overflow-x:auto">
                            <table style="width:100%;border-collapse:collapse;font-size:0.9em">
                                <thead>
                                    <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb">
                                        <th style="padding:12px;text-align:left">Week</th>
                                        <th style="padding:12px;text-align:left">Topic</th>
                                        <th style="padding:12px;text-align:left">Status</th>
                                        <th style="padding:12px;text-align:left">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${config.weeks.map(w => {
                const wData = (mod.weeks && mod.weeks[w.id]) || {};
                return `
                                        <tr style="border-bottom:1px solid #e5e7eb">
                                            <td style="padding:12px;font-weight:500;color:#6b7280">${w.id.toUpperCase()}</td>
                                            <td style="padding:12px;font-weight:600">${w.title}</td>
                                            <td style="padding:12px">
                                                <select onchange="state.updateModule('${moduleId}', 'week', {id:'${w.id}', field:'status', value:this.value})"
                                                        style="padding:6px;border-radius:4px;border:1px solid #d1d5db;background:${wData.status === 'Done' ? '#dcfce7' : wData.status === 'In Progress' ? '#fef9c3' : 'white'}">
                                                    <option value="Not Started" ${!wData.status || wData.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                                    <option value="In Progress" ${wData.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                                    <option value="Done" ${wData.status === 'Done' ? 'selected' : ''}>Done</option>
                                                </select>
                                            </td>
                                            <td style="padding:12px">
                                                <input type="date" value="${wData.date || ''}" 
                                                       onchange="state.updateModule('${moduleId}', 'week', {id:'${w.id}', field:'date', value:this.value})"
                                                       style="padding:6px;border-radius:4px;border:1px solid #d1d5db">
                                            </td>
                                        </tr>`;
            }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>` : ''}

                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px">
                        ${!config.weeks && !config.assignmentList && !config.caseReports && mod.total > 0 ? `
                        <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <h3 style="font-weight:600;margin-bottom:12px">Module Completion</h3>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:2em;font-weight:bold">${mod.completed}/${mod.total}</span>
                                <button onclick="state.incrementModule('${moduleId}','completed');render()" 
                                        style="background:#22c55e;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer"
                                        ${mod.completed >= mod.total ? 'disabled' : ''}>
                                    ${mod.completed >= mod.total ? '‚úì' : '+1'}
                                </button>
                            </div>
                        </div>` : ''}

                        ${assignTotal > 0 ? `
                        <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <h3 style="font-weight:600;margin-bottom:12px">Assignments</h3>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:2em;font-weight:bold">${assignDone}/${assignTotal}</span>
                            </div>
                        </div>` : ''}

                        ${caseTotal > 0 ? `
                        <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <h3 style="font-weight:600;margin-bottom:12px">Case Reports</h3>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:2em;font-weight:bold">${caseDone}/${caseTotal}</span>
                            </div>
                        </div>` : ''}

                        ${config.procedures > 0 ? `
                        <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <h3 style="font-weight:600;margin-bottom:12px">Procedures</h3>
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:2em;font-weight:bold">${procs.length}/${config.procedures}</span>
                                <button onclick="showProcedureModal('${moduleId}')" 
                                        style="background:#a855f7;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">
                                    + Add
                                </button>
                            </div>
                        </div>` : ''}
                    </div>

                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px">
                        ${caseTotal > 0 ? `
                        <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <h3 style="font-weight:bold;font-size:1.2em;margin-bottom:15px">Case Reports Checklist</h3>
                            <div style="display:grid;gap:10px">
                                ${config.caseReports.map((item, i) => {
                const id = 'case_' + i;
                const isDone = mod.caseReports && mod.caseReports[id] === 'Done';
                return `
                                    <div onclick="state.updateModule('${moduleId}', 'caseReport', {id: '${id}', status: '${isDone ? '' : 'Done'}'});render()"
                                         style="display:flex;align-items:center;padding:10px;border-radius:6px;cursor:pointer;border:1px solid ${isDone ? '#bbf7d0' : '#e5e7eb'};background:${isDone ? '#f0fdf4' : 'white'}">
                                        <div style="width:20px;height:20px;border-radius:4px;border:2px solid ${isDone ? '#22c55e' : '#d1d5db'};background:${isDone ? '#22c55e' : 'white'};display:flex;align-items:center;justify-content:center;margin-right:10px;color:white;font-size:0.8em">
                                            ${isDone ? '‚úì' : ''}
                                        </div>
                                        <span>${item}</span>
                                    </div>`;
            }).join('')}
                            </div>
                        </div>` : ''}

                        ${assignTotal > 0 ? `
                        <div style="background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                            <h3 style="font-weight:bold;font-size:1.2em;margin-bottom:15px">Assignment Checklist</h3>
                            <div style="display:grid;gap:10px">
                                ${config.assignmentList.map((item, i) => {
                const id = 'assign_' + i;
                const isDone = mod.assignments && mod.assignments[id] === 'Done';
                return `
                                    <div style="padding:16px;background:${isDone ? '#f0fdf4' : 'white'};border-radius:8px;border:1px solid ${isDone ? '#bbf7d0' : '#e5e7eb'};box-shadow:0 1px 2px rgba(0,0,0,0.05)">
                                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                                            <div style="display:flex;align-items:center">
                                                <div style="width:24px;height:24px;border-radius:4px;border:2px solid ${isDone ? '#22c55e' : '#d1d5db'};background:${isDone ? '#22c55e' : 'white'};display:flex;align-items:center;justify-content:center;margin-right:12px;color:white;flex-shrink:0">
                                                    ${isDone ? '‚úì' : ''}
                                                </div>
                                                <span style="font-weight:600;color:#374151;font-size:1em">${item.title || item}</span>
                                            </div>
                                            <span style="font-size:0.75em;padding:4px 8px;border-radius:99px;background:${isDone ? '#dcfce7' : '#f3f4f6'};color:${isDone ? '#166534' : '#6b7280'};font-weight:500">
                                                ${isDone ? 'Completed' : 'Pending'}
                                            </span>
                                        </div>
                                        ${item.prompt ? `<div style="font-size:0.9em;color:#4b5563;margin-bottom:12px;padding-left:36px;font-style:italic">${item.prompt}</div>` : ''}
                                        
                                        <div style="display:flex;gap:16px;padding-left:36px;flex-wrap:wrap">
                                            <div style="display:flex;flex-direction:column;gap:4px">
                                                <label style="font-size:0.75em;color:#6b7280;font-weight:500;text-transform:uppercase">Date Started</label>
                                                <input type="date" value="${(mod.assignments && mod.assignments[id] && mod.assignments[id].dateStarted) || ''}"
                                                       onchange="state.updateModule('${moduleId}', 'assignment', {id: '${id}', field: 'dateStarted', value: this.value})"
                                                       style="padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:0.9em;color:#374151">
                                            </div>
                                            <div style="display:flex;flex-direction:column;gap:4px">
                                                <label style="font-size:0.75em;color:#6b7280;font-weight:500;text-transform:uppercase">Date Submitted</label>
                                                <input type="date" value="${(mod.assignments && mod.assignments[id] && mod.assignments[id].dateSubmitted) || ''}"
                                                       onchange="state.updateModule('${moduleId}', 'assignment', {id: '${id}', field: 'dateSubmitted', value: this.value}); render()"
                                                       style="padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:0.9em;color:#374151">
                                            </div>
                                        </div>
                                    </div>
                                    `;
            }).join('')}
                            </div>
                        </div>` : ''}
                    </div>

                    ${config.procedures > 0 ? `
                    <div style="background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px">
                        <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
                            <h3 style="font-weight:bold;font-size:1.2em">Procedure Log (${procs.length}/${config.procedures})</h3>
                            <button onclick="printProcedures('${moduleId}')" 
                                    style="background:#f97316;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">
                                üñ®Ô∏è Print Log
                            </button>
                        </div>
                        <div style="padding:20px">
                            ${procs.slice(0, 10).map(p => `
                                <div style="border:1px solid #e5e7eb;border-radius:6px;padding:12px;margin-bottom:8px">
                                    <div style="display:flex;justify-content:space-between">
                                        <div>
                                            <h4 style="font-weight:600">${p.name}</h4>
                                            <p style="font-size:0.9em;color:#6b7280">${new Date(p.date).toLocaleDateString()}</p>
                                            <p style="font-size:0.9em;color:#6b7280">Supervisor: ${p.supervisor}</p>
                                            ${p.notes ? `<p style="font-size:0.85em;color:#6b7280;font-style:italic;margin-top:4px">"${p.notes}"</p>` : ''}
                                        </div>
                                        <button onclick="state.deleteProcedure(${p.id});render()" 
                                                style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:1.2em">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            ${procs.length > 10 ? `<p style="text-align:center;color:#6b7280;font-size:0.9em;margin-top:12px">Showing 10 of ${procs.length} procedures</p>` : ''}
                        </div>
                    </div>` : ''}
                </div>
            `;
        }


        function showProcedureModal(moduleId) {
            const modal = document.createElement('div');
            modal.id = 'procedureModal';
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000';

            // Get unique supervisors for autocomplete
            const supervisors = [...new Set(state.procedureLog.map(p => p.supervisor))].filter(Boolean);
            const datalist = `<datalist id="supervisorList">${supervisors.map(s => `<option value="${s}">`).join('')}</datalist>`;

            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:30px;max-width:500px;width:90%;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)">
                    <h2 style="font-size:1.5em;font-weight:bold;margin-bottom:20px">Log Procedure</h2>
                    <form id="procForm" style="display:flex;flex-direction:column;gap:16px">
                        ${!moduleId ? `
                        <div style="display:flex;flex-direction:column;gap:6px">
                             <label style="font-size:0.9em;color:#4b5563">Module</label>
                             <select id="procModule" required style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                <option value="" disabled selected>Select Module</option>
                                ${moduleConfigs.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                             </select>
                        </div>
                        ` : ''}
                        
                        <input type="text" id="procName" placeholder="Procedure name" required
                               style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px">
                        <input type="date" id="procDate" required value="${new Date().toISOString().split('T')[0]}"
                               style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px">
                        
                        <div>
                            <input type="text" id="procSupervisor" placeholder="Supervisor name" required list="supervisorList"
                                   style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px">
                            ${datalist}
                        </div>

                        <textarea id="procNotes" placeholder="Notes (optional)" rows="3"
                                  style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px"></textarea>
                        <div style="display:flex;gap:12px">
                            <button type="submit" style="flex:1;background:#a855f7;color:white;border:none;padding:12px;border-radius:6px;cursor:pointer;font-weight:500">
                                Save Procedure
                            </button>
                            <button type="button" onclick="document.getElementById('procedureModal').remove()" 
                                    style="flex:1;background:#e5e7eb;border:none;padding:12px;border-radius:6px;cursor:pointer;color:#374151">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            document.getElementById('procForm').onsubmit = (e) => {
                e.preventDefault();
                state.addProcedure({
                    module: moduleId || document.getElementById('procModule').value,
                    name: document.getElementById('procName').value,
                    date: document.getElementById('procDate').value,
                    supervisor: document.getElementById('procSupervisor').value,
                    notes: document.getElementById('procNotes').value
                });
                modal.remove();
                render();
            };
        };

        function showNotes(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const notes = state.modules[moduleId].notes || '';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            // Added slightly darker shadow and better z-index handling
            modal.style.cssText = 'position:fixed;top:0;right:0;bottom:0;width:400px;background:white;box-shadow:-4px 0 15px rgba(0,0,0,0.1);z-index:1000;display:flex;flex-direction:column;transition:transform 0.3s ease';
            modal.innerHTML = `
                <div style="background:${config.color};color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 2px rgba(0,0,0,0.1)">
                    <h2 style="font-weight:bold">Notes: ${config.name}</h2>
                    <button onclick="this.closest('div').parentElement.remove()" 
                            style="background:none;border:none;color:white;font-size:1.5em;cursor:pointer;opacity:0.8;transition:opacity 0.2s"
                            onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.8">√ó</button>
                </div>
                <div style="flex:1;padding:20px;background:#f9fafb">
                    <textarea id="notesArea" style="width:100%;height:100%;border:1px solid #d1d5db;border-radius:8px;padding:16px;resize:none;font-family:inherit;font-size:1em;line-height:1.5;box-shadow:inset 0 1px 2px rgba(0,0,0,0.05)"
                              placeholder="Add your notes here...">${notes}</textarea>
                </div>
                <div style="padding:16px 20px;border-top:1px solid #e5e7eb;background:white;display:flex;justify-content:space-between;align-items:center">
                    <p style="font-size:0.85em;color:#6b7280">üíæ Auto-saving...</p>
                    <span id="saveStatus" style="font-size:0.85em;color:#22c55e;font-weight:bold;opacity:0;transition:opacity 0.3s">Saved ‚úì</span>
                </div>
            `;
            document.body.appendChild(modal);

            // Click outside to close (for the notes sidebar, this means clicking anywhere outside the sidebar itself)
            // This requires a slightly different approach as it's a sidebar, not a centered modal.
            // We'll add a transparent overlay behind it.
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:transparent;z-index:999';
            overlay.onclick = () => {
                modal.remove();
                overlay.remove();
            };
            document.body.appendChild(overlay);

            let timeout;
            const statusEl = document.getElementById('saveStatus');
            document.getElementById('notesArea').oninput = (e) => {
                statusEl.style.opacity = '0';
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    state.updateModule(moduleId, 'notes', e.target.value);
                    statusEl.style.opacity = '1';
                    setTimeout(() => { statusEl.style.opacity = '0'; }, 2000);
                }, 500);
            };
        }

        function showSettings() {
            const modal = document.createElement('div');
            modal.id = 'settingsModal';
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:30px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h2 style="font-size:1.5em;font-weight:bold">Data Management</h2>
                        <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                                style="background:none;border:none;font-size:1.5em;cursor:pointer;padding:4px 8px;border-radius:4px;transition:background 0.2s"
                                onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
                    </div>
                    
                    <div style="border-bottom:1px solid #e5e7eb;padding-bottom:20px;margin-bottom:20px">
                        <h3 style="font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px">
                            üë§ Profile
                        </h3>
                        <p style="font-size:0.9em;color:#6b7280;margin-bottom:12px">Update your personal details</p>
                        <form onsubmit="event.preventDefault(); state.updateProfile(this.name.value, this.year.value, this.pass.value); alert('Profile updated!');">
                            <div style="display:grid;gap:10px">
                                <input name="name" value="${state.account.name}" placeholder="Name" required
                                       style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
                                <select name="year" required style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
                                    ${[1, 2, 3, 4, 5, 6].map(y => `<option value="${y}" ${y == state.account.year ? 'selected' : ''}>Year ${y}</option>`).join('')}
                                </select>
                                <input name="pass" type="password" placeholder="New Password (optional)"
                                       style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
                                <button type="submit" style="padding:8px;background:#374151;color:white;border:none;border-radius:6px;cursor:pointer">
                                    Update Profile
                                </button>
                            </div>
                        </form>
                    </div>

                    <div style="border-bottom:1px solid #e5e7eb;padding-bottom:20px;margin-bottom:20px">
                        <h3 style="font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px">
                            üì• Export Data
                        </h3>
                        <p style="font-size:0.9em;color:#6b7280;margin-bottom:12px">Download your progress as a JSON file</p>
                        <button onclick="state.exportData()" 
                                style="width:100%;background:#3b82f6;color:white;border:none;padding:12px;border-radius:6px;cursor:pointer;display:flex;justify-content:center;align-items:center;font-weight:500;transition:background 0.2s"
                                onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                            Export to File
                        </button>
                    </div>

                    <div style="border-bottom:1px solid #e5e7eb;padding-bottom:20px;margin-bottom:20px">
                        <h3 style="font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px">
                            üì§ Import Data
                        </h3>
                        <p style="font-size:0.9em;color:#6b7280;margin-bottom:12px">Restore from backup file</p>
                        <label style="width:100%;background:#22c55e;color:white;padding:12px;border-radius:6px;cursor:pointer;display:block;text-align:center;font-weight:500;transition:background 0.2s"
                               onmouseover="this.style.background='#16a34a'" onmouseout="this.style.background='#22c55e'">
                            Import from File
                            <input type="file" accept=".json" onchange="state.importData(this.files[0]);this.closest('div').parentElement.parentElement.remove();render()" 
                                   style="display:none">
                        </label>
                    </div>

                    <div style="border-bottom:1px solid #e5e7eb;padding-bottom:20px;margin-bottom:20px">
                        <h3 style="font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px">
                            ‚òÅÔ∏è Cloud Backup
                        </h3>
                        <p style="font-size:0.9em;color:#6b7280;margin-bottom:12px">Create backup file for Google Drive</p>
                        <button onclick="state.exportData(true)" 
                                style="width:100%;background:#a855f7;color:white;border:none;padding:12px;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.2s"
                                onmouseover="this.style.background='#9333ea'" onmouseout="this.style.background='#a855f7'">
                            Create Cloud Backup
                        </button>
                        <p style="font-size:0.75em;color:#6b7280;margin-top:8px">üí° Upload downloaded file to Google Drive</p>
                    </div>

                    <div>
                        <h3 style="font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px">
                            üñ®Ô∏è Print Reports
                        </h3>
                        <p style="font-size:0.9em;color:#6b7280;margin-bottom:12px">Print progress and procedure logs</p>
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <button onclick="printProgressReport()" 
                                    style="width:100%;background:#f97316;color:white;border:none;padding:12px;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.2s"
                                    onmouseover="this.style.background='#ea580c'" onmouseout="this.style.background='#f97316'">
                                Print Progress Report
                            </button>
                            <button onclick="printProcedures()" 
                                    style="width:100%;background:#f97316;color:white;border:none;padding:12px;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.2s"
                                    onmouseover="this.style.background='#ea580c'" onmouseout="this.style.background='#f97316'">
                                Print All Procedures
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function renderAssignmentEditor(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const assignments = config.assignmentList || [];

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000';

            const renderList = () => {
                return assignments.map((a, i) => {
                    const title = typeof a === 'string' ? a : a.title;
                    const prompt = typeof a === 'string' ? '' : a.prompt;
                    return `
                        <div style="display:flex;justify-content:space-between;align-items:start;padding:10px;border:1px solid #e5e7eb;margin-bottom:8px;border-radius:6px;background:white">
                            <div style="flex:1;margin-right:10px">
                                <div style="font-weight:500">${title}</div>
                                ${prompt ? `<div style="font-size:0.85em;color:#6b7280">${prompt}</div>` : ''}
                            </div>
                            <button onclick="document.getElementById('edit_assign_${i}').style.display='block'" 
                                    style="color:#3b82f6;background:none;border:none;cursor:pointer;margin-right:8px">‚úé</button>
                            <button onclick="deleteAssignment(${i})" 
                                    style="color:#ef4444;background:none;border:none;cursor:pointer">üóëÔ∏è</button>
                            
                            <div id="edit_assign_${i}" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1100">
                                <div style="background:white;padding:20px;max-width:400px;margin:100px auto;border-radius:8px">
                                    <h3>Edit Assignment</h3>
                                    <input id="edit_title_${i}" value="${title}" style="width:100%;padding:8px;margin:10px 0;border:1px solid #ddd;border-radius:4px">
                                    <textarea id="edit_prompt_${i}" style="width:100%;padding:8px;margin-bottom:10px;border:1px solid #ddd;border-radius:4px">${prompt}</textarea>
                                    <div style="display:flex;gap:10px">
                                        <button onclick="saveAssignment(${i}, document.getElementById('edit_title_${i}').value, document.getElementById('edit_prompt_${i}').value)" 
                                                style="flex:1;padding:8px;background:#3b82f6;color:white;border:none;border-radius:4px">Save</button>
                                        <button onclick="document.getElementById('edit_assign_${i}').style.display='none'" 
                                                style="flex:1;padding:8px;background:#e5e7eb;border:none;border-radius:4px">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:30px;max-width:600px;width:90%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <div>
                            <h2 style="font-size:1.5em;font-weight:bold">Edit Assignments</h2>
                            <p style="color:#6b7280">${config.name}</p>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove()" 
                                style="font-size:1.5em;background:none;border:none;cursor:pointer">√ó</button>
                    </div>
                    
                    <div id="assignList" style="flex:1;overflow-y:auto;border:1px solid #f3f4f6;border-radius:8px;padding:10px;background:#f9fafb;margin-bottom:20px">
                        ${renderList()}
                    </div>

                    <form id="addAssignForm" style="border-top:1px solid #e5e7eb;padding-top:20px">
                        <h4 style="font-weight:600;margin-bottom:10px">Add New Assignment</h4>
                        <div style="display:grid;gap:10px">
                            <input type="text" id="newAssignTitle" placeholder="Title (e.g. 'Report on X')" required
                                   style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                            <input type="text" id="newAssignPrompt" placeholder="Description/Prompt (optional)"
                                   style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                            <button type="submit" 
                                    style="padding:10px;background:#22c55e;color:white;border:none;border-radius:6px;font-weight:500;cursor:pointer">
                                + Add Assignment
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Helpers attached to window for inline onclicks
            window.deleteAssignment = (index) => {
                assignments.splice(index, 1);
                state.updateAssignmentList(moduleId, assignments);
                document.getElementById('assignList').innerHTML = renderList();
            };

            window.saveAssignment = (index, title, prompt) => {
                const newAssign = prompt ? { title, prompt } : title;
                assignments[index] = newAssign;
                state.updateAssignmentList(moduleId, assignments);
                document.getElementById('assignList').innerHTML = renderList();
            };

            modal.querySelector('#addAssignForm').onsubmit = (e) => {
                e.preventDefault();
                const title = document.getElementById('newAssignTitle').value;
                const prompt = document.getElementById('newAssignPrompt').value;
                if (title) {
                    const newAssign = prompt ? { title, prompt } : title;
                    assignments.push(newAssign);
                    state.updateAssignmentList(moduleId, assignments);
                    document.getElementById('assignList').innerHTML = renderList();
                    e.target.reset();
                }
            };

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function renderMilestones(category) {
            const items = milestoneConfigs[category] || [];
            const data = state.milestones[category] || {};

            let title = 'Milestones';
            if (category === 'research') title = 'Research Project';
            else if (category === 'management') title = 'Management & Leadership';
            else if (category === 'exams') title = 'Examinations';
            else if (category === 'other') title = 'Other Requirements';

            return `
                <div style="max-width:800px;margin:0 auto;padding:20px">
                    <div style="background:white;border-radius:12px;padding:30px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                        <h1 style="font-size:2em;font-weight:bold;margin-bottom:10px;color:#1f2937">${title}</h1>
                        <p style="color:#6b7280;margin-bottom:30px">Track your progress for ${title.toLowerCase()}.</p>
                        
                        <div style="display:flex;flex-direction:column;gap:16px">
                            ${items.map(item => {
                const status = data[item.id]?.status || 'Not Started';
                const date = data[item.id]?.date || '';
                return `
                                <div style="border:1px solid #e5e7eb;border-radius:8px;padding:20px;display:flex;justify-content:space-between;align-items:center;background:${status === 'Done' || status === 'Passed' ? '#f0fdf4' : 'white'}">
                                    <div>
                                        <h3 style="font-weight:600;margin-bottom:4px">${item.label}</h3>
                                        ${date ? `<p style="font-size:0.85em;color:#6b7280">Completed: ${new Date(date).toLocaleDateString()}</p>` : ''}
                                    </div>
                                    <div style="display:flex;gap:12px;align-items:center">
                                        <select onchange="state.updateMilestone('${category}', '${item.id}', this.value, document.getElementById('date_${item.id}').value)"
                                                style="padding:8px;border:1px solid #d1d5db;border-radius:6px;background:white">
                                            <option value="Not Started" ${status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                            <option value="${category === 'exams' ? 'Passed' : 'Done'}" ${status === 'Done' || status === 'Passed' ? 'selected' : ''}>
                                                ${category === 'exams' ? 'Passed' : 'Done'}
                                            </option>
                                        </select>
                                        <input type="date" id="date_${item.id}" value="${date}" 
                                               onchange="state.updateMilestone('${category}', '${item.id}', document.querySelector('select[onchange*=\\'${item.id}\\']').value, this.value)"
                                               style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
                                    </div>
                                </div>
                                `;
            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLogbook() {
            const categories = [
                {
                    name: 'Anaesthesiology', items: [
                        { id: 'la_pre', label: 'Pre-op Assess', target: 50 },
                        { id: 'la_int', label: 'Intubation', target: 10 },
                        { id: 'la_spin', label: 'Spinal', target: 20 },
                        { id: 'la_ket', label: 'Ketamine', target: 10 }
                    ]
                },
                {
                    name: 'Obstetrics & Gynaecology', items: [
                        { id: 'lo_norm', label: 'Normal Delivery', target: 20 },
                        { id: 'lo_cs', label: 'LUSCS', target: 6 },
                        { id: 'lo_breech', label: 'Breech', target: 5 },
                        { id: 'lo_vac', label: 'Vacuum', target: 6 },
                        { id: 'lo_pph', label: 'PPH Mgmt', target: 6 }
                    ]
                },
                {
                    name: 'Child Health', items: [
                        { id: 'lc_neo', label: 'Neonatal Resus', target: 4 },
                        { id: 'lc_pon', label: 'Ponsetti Cast', target: 2 },
                        { id: 'lc_io', label: 'IO Needle', target: 1 }
                    ]
                },
                {
                    name: 'Surgery & Medicine', items: [
                        { id: 'ls_hernia', label: 'Hernia Repair', target: 8 },
                        { id: 'ls_lap', label: 'Laparotomy', target: 5 },
                        { id: 'ls_chest', label: 'Chest Drain', target: 7 },
                        { id: 'lm_lp', label: 'Lumbar Puncture', target: 10 }
                    ]
                },
                {
                    name: 'Laboratory', items: [
                        { id: 'log_blood', label: 'Blood Typing & Crossmatch', target: 10 },
                        { id: 'log_malaria', label: 'Malaria Smear Staining', target: 10 }
                    ]
                }
            ];

            return `
                <div style="max-width:800px;margin:0 auto;padding:20px">
                     <div style="background:white;border-radius:12px;padding:30px;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
                        <h1 style="font-size:2em;font-weight:bold;color:#1f2937;margin-bottom:10px">Master Logbook</h1>
                        <p style="color:#6b7280;margin-bottom:30px">Track your progress against graduation requirements.</p>

                        ${categories.map(cat => `
                            <div style="margin-bottom:30px">
                                <h2 style="font-size:1.2em;font-weight:bold;margin-bottom:15px;color:#2563eb;border-bottom:2px solid #eff6ff;padding-bottom:8px">${cat.name}</h2>
                                <div style="display:grid;gap:12px">
                                    ${cat.items.map(item => {
                const val = state.logbook[item.id] || 0;
                const isDone = val >= item.target;
                const pct = Math.min(100, Math.round((val / item.target) * 100));
                return `
                                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:${isDone ? '#f0fdf4' : '#f9fafb'};border-radius:6px;border:1px solid ${isDone ? '#bbf7d0' : '#e5e7eb'}">
                                            <div style="flex:1">
                                                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                                                    <span style="font-weight:500;color:${isDone ? '#15803d' : '#374151'}">${item.label}</span>
                                                    <span style="font-size:0.9em;color:${isDone ? '#15803d' : '#6b7280'}">${val} / ${item.target}</span>
                                                </div>
                                                <div style="background:#e5e7eb;height:6px;border-radius:99px;width:100%;max-width:200px">
                                                    <div style="background:${isDone ? '#22c55e' : '#3b82f6'};height:6px;border-radius:99px;width:${pct}%"></div>
                                                </div>
                                            </div>
                                            <div style="margin-left:20px">
                                                <input type="number" min="0" value="${val}" 
                                                       onchange="state.updateLogbook('${item.id}', parseInt(this.value) || 0);render()"
                                                       style="width:70px;padding:6px;border:1px solid #d1d5db;border-radius:4px;text-align:center">
                                            </div>
                                        </div>
                                        `;
            }).join('')}
                                </div>
                            </div>
                        `).join('')}
                     </div>
                </div>
            `;
        }


        function renderLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div style="min-height:100vh;background:#f3f4f6;display:flex;align-items:center;justify-content:center;padding:20px">
                    <div style="background:white;padding:40px;border-radius:12px;box-shadow:0 10px 25px -5px rgba(0,0,0,0.1);width:100%;max-width:400px">
                        <div style="text-align:center;margin-bottom:30px">
                            <h1 style="color:#15803d;font-size:2em;font-weight:bold;margin-bottom:10px">Master of Medicine (Rural)</h1>
                            <p style="color:#6b7280">Electronic Logbook & Tracker</p>
                            <div style="margin-top:10px;font-size:0.75em;color:#9ca3af;background:#f9fafb;padding:8px;border-radius:6px;border:1px solid #e5e7eb">
                                üîí <strong>Privacy Note:</strong> This login prevents casual viewing only. Data is stored on this device and is not encrypted.
                            </div>
                        </div>

                        ${localStorage.getItem('mmed_tracker_data') && JSON.parse(localStorage.getItem('mmed_tracker_data')).account ? `
                            <div id="loginForm">
                                <form onsubmit="event.preventDefault(); if(state.login(document.getElementById('loginId').value, document.getElementById('loginPass').value)) render(); else alert('Invalid credentials');">
                                    <h2 style="font-size:1.2em;font-weight:600;margin-bottom:20px;color:#374151">Student Login</h2>
                                    <div style="display:grid;gap:16px">
                                        <div style="display:flex;flex-direction:column;gap:6px">
                                            <label style="font-size:0.9em;color:#4b5563">ID Number</label>
                                            <input type="text" id="loginId" required placeholder="e.g. 20100540"
                                                style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                        </div>
                                        <div style="display:flex;flex-direction:column;gap:6px">
                                            <label style="font-size:0.9em;color:#4b5563">Password</label>
                                            <div style="position:relative">
                                                <input type="password" id="loginPass" required
                                                    style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                                <button type="button" onclick="const i=document.getElementById('loginPass'); i.type=i.type==='password'?'text':'password'; this.textContent=i.type==='text'?'üëÅÔ∏è':'üëÅÔ∏è‚Äçüó®Ô∏è'" 
                                                        style="position:absolute;right:10px;top:10px;background:none;border:none;cursor:pointer">üëÅÔ∏è‚Äçüó®Ô∏è</button>
                                            </div>
                                        </div>
                                        <button type="submit" 
                                                style="background:#15803d;color:white;border:none;padding:12px;border-radius:6px;font-weight:600;cursor:pointer;margin-top:10px">
                                            Login
                                        </button>
                                    </div>
                                </form>
                                <p style="margin-top:20px;text-align:center;font-size:0.9em;color:#6b7280">
                                    <a href="#" onclick="document.getElementById('loginForm').style.display='none';document.getElementById('resetForm').style.display='block'" style="color:#0ea5e9">Admin Support (Forgot Password)</a>
                                    <br><br>
                                    Need to re-activate? <a href="#" onclick="const c=prompt('TYPE &quot;DELETE&quot; TO CONFIRM WIPE OF ALL DATA:'); if(c==='DELETE'){ localStorage.removeItem('mmed_tracker_data');location.reload(); } else { alert('Deletion cancelled. You must type DELETE (uppercase) to confirm.'); }" style="color:#ef4444">Reset Local Data</a>
                                </p>
                            </div>

                            <div id="resetForm" style="display:none">
                                <form onsubmit="event.preventDefault(); if(state.resetPassword(document.getElementById('resetId').value, document.getElementById('resetAns').value, document.getElementById('resetNewPass').value)) { alert('Password Reset Successful!'); render(); } else alert('Incorrect ID or Security Answer');">
                                    <h2 style="font-size:1.2em;font-weight:600;margin-bottom:20px;color:#374151">Admin Support</h2>
                                    <p style="font-size:0.9em;color:#6b7280;margin-bottom:15px">Verify your identity to reset password.</p>
                                    <div style="display:grid;gap:16px">
                                        <div style="display:flex;flex-direction:column;gap:6px">
                                            <label style="font-size:0.9em;color:#4b5563">ID Number</label>
                                            <input type="text" id="resetId" required placeholder="e.g. 20100540"
                                                style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                        </div>
                                        <div style="display:flex;flex-direction:column;gap:6px">
                                            <label style="font-size:0.9em;color:#4b5563">Security Question</label>
                                            <div style="padding:10px;background:#f3f4f6;border-radius:6px;color:#374151;font-size:0.9em;border:1px solid #e5e7eb">
                                                ${JSON.parse(localStorage.getItem('mmed_tracker_data')).account ? JSON.parse(localStorage.getItem('mmed_tracker_data')).account.securityQuestion : 'No security question set.'}
                                            </div>
                                        </div>
                                        <div style="display:flex;flex-direction:column;gap:6px">
                                            <label style="font-size:0.9em;color:#4b5563">Security Answer</label>
                                            <input type="text" id="resetAns" required placeholder="Your answer"
                                                style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                        </div>
                                        <div style="display:flex;flex-direction:column;gap:6px">
                                            <label style="font-size:0.9em;color:#4b5563">New Password</label>
                                            <input type="password" id="resetNewPass" required
                                                style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                        </div>
                                        <button type="submit" 
                                                style="background:#0ea5e9;color:white;border:none;padding:12px;border-radius:6px;font-weight:600;cursor:pointer;margin-top:10px">
                                            Reset Password
                                        </button>
                                    </div>
                                     <p style="margin-top:20px;text-align:center;font-size:0.9em;">
                                        <a href="#" onclick="document.getElementById('resetForm').style.display='none';document.getElementById('loginForm').style.display='block'" style="color:#6b7280">Back to Login</a>
                                    </p>
                                </form>
                            </div>
                        ` : `
                            <form onsubmit="event.preventDefault(); 
                                            const name = document.getElementById('regName').value;
                                            const id = document.getElementById('regId').value;
                                            const year = document.getElementById('regYear').value;
                                            const q = document.getElementById('regQ').value;
                                            const a = document.getElementById('regA').value;
                                            // Admin simplified flow: Default password
                                            state.register(name, id, year, 'RURAL2026', q, a);
                                            alert('Account Activated!\\n\\nDefault Password: RURAL2026\\n\\nPlease change this immediately after login.');
                                            render();">
                                <h2 style="font-size:1.2em;font-weight:600;margin-bottom:20px;color:#374151">Activate Account</h2>
                                <p style="font-size:0.9em;color:#6b7280;margin-bottom:20px">Enter your registration details to retrieve your credentials.</p>
                                
                                <div style="display:grid;gap:16px">
                                    <div style="display:flex;flex-direction:column;gap:6px">
                                        <label style="font-size:0.9em;color:#4b5563">Full Name</label>
                                        <input type="text" id="regName" required placeholder="e.g. John Doe"
                                               style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                    </div>
                                    <div style="display:flex;flex-direction:column;gap:6px">
                                        <label style="font-size:0.9em;color:#4b5563">Student ID Number</label>
                                        <input type="text" id="regId" required placeholder="e.g. 20100540"
                                               style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                    </div>
                                    <div style="display:flex;flex-direction:column;gap:6px">
                                        <label style="font-size:0.9em;color:#4b5563">Current Year</label>
                                        <select id="regYear" required style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                            <option value="1">Year 1</option>
                                            <option value="2">Year 2</option>
                                            <option value="3">Year 3</option>
                                            <option value="4">Year 4</option>
                                            <option value="5">Year 5</option>
                                            <option value="6">Year 6</option>
                                        </select>
                                    </div>
                                    
                                     <div style="border-top:1px solid #e5e7eb;padding-top:16px;margin-top:4px">
                                        <h3 style="font-size:1em;font-weight:600;color:#374151;margin-bottom:12px">Account Security</h3>
                                        <p style="font-size:0.85em;color:#6b7280;margin-bottom:10px">Set a security question for password recovery.</p>
                                        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">
                                            <label style="font-size:0.9em;color:#4b5563">Security Question</label>
                                            <select id="regQ" required style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                                <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                                                <option value="What was the name of your first pet?">What was the name of your first pet?</option>
                                                <option value="What city were you born in?">What city were you born in?</option>
                                                <option value="What is your favorite book?">What is your favorite book?</option>
                                            </select>
                                        </div>
                                        <div style="display:flex;flex-direction:column;gap:6px">
                                            <label style="font-size:0.9em;color:#4b5563">Security Answer</label>
                                            <input type="text" id="regA" required placeholder="Answer"
                                                style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                                        </div>
                                    </div>

                                    <button type="submit" 
                                            style="background:#15803d;color:white;border:none;padding:12px;border-radius:6px;font-weight:600;cursor:pointer;margin-top:10px">
                                        Activate Account
                                    </button>
                                </div>
                            </form>
                        `}
                        
                    </div>
                </div>
            `;
        }

        function renderChangePasswordModal() {
            if (document.getElementById('password-change-modal')) return;
            const modal = document.createElement('div');
            modal.id = 'password-change-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:12px;width:100%;max-width:400px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)">
                    <h2 style="color:#d97706;font-size:1.5em;font-weight:bold;margin-bottom:10px">Security Update Required</h2>
                    <p style="color:#4b5563;margin-bottom:20px">For your security, you must change your default password before continuing.</p>
                    
                    <form onsubmit="event.preventDefault(); const p1=document.getElementById('newP1').value; const p2=document.getElementById('newP2').value; if(p1===p2) { state.changePassword(p1); document.getElementById('password-change-modal').remove(); render(); } else { alert('Passwords do not match'); }">
                        <div style="display:flex;flex-direction:column;gap:15px">
                            <div style="display:flex;flex-direction:column;gap:6px">
                                <label style="font-size:0.9em;color:#4b5563">New Password</label>
                                <input type="password" id="newP1" required minlength="4"
                                       style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                            </div>
                            <div style="display:flex;flex-direction:column;gap:6px">
                                <label style="font-size:0.9em;color:#4b5563">Confirm Password</label>
                                <input type="password" id="newP2" required minlength="4"
                                       style="padding:10px;border:1px solid #d1d5db;border-radius:6px">
                            </div>
                            <button type="submit" 
                                    style="background:#d97706;color:white;border:none;padding:12px;border-radius:6px;font-weight:600;cursor:pointer;margin-top:10px">
                                Update Password
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function render() {
            if (!state.session || !state.session.isLoggedIn) {
                renderLogin();
                return;
            }

            if (state.account && state.account.needsPasswordChange) {
                renderChangePasswordModal();
                // We still render the app behind the modal, or just the modal. 
                // Let's render the app but with the modal on top.
            }

            const app = document.getElementById('app');

            // Check backup status
            const daysSinceBackup = state.lastBackupDate ? (Date.now() - new Date(state.lastBackupDate).getTime()) / (1000 * 60 * 60 * 24) : 999;
            const backupNeeded = daysSinceBackup > 7;

            let content = '';
            if (state.activeTab === 'dashboard') content = renderDashboard();
            else if (moduleConfigs.find(m => m.id === state.activeTab)) content = renderModuleDetail(state.activeTab);
            else if (['research', 'management', 'exams', 'other'].includes(state.activeTab)) content = renderMilestones(state.activeTab);
            else if (state.activeTab === 'logbook') content = renderLogbook();

            app.innerHTML = `
                <div style="min-height:100vh;background:#f9fafb">
                    ${state.sidebarOpen ? `
                    <div class="no-print" style="position:fixed;left:0;top:0;bottom:0;width:260px;background:#1f2937;color:white;overflow-y:auto;z-index:100">
                        <div style="padding:20px;border-bottom:1px solid #374151">
                            <h2 style="font-weight:bold;font-size:1.2em;color:#60a5fa">MMED Tracker</h2>
                            <div style="margin-top:8px;font-size:0.85em;color:#9ca3af;display:flex;align-items:center;gap:8px">
                                <div style="width:8px;height:8px;background:#22c55e;border-radius:50%"></div>
                                ${state.account.name} (${state.account.id})
                            </div>
                            <div style="margin-top:4px;font-size:0.75em;color:#34d399;display:flex;align-items:center;gap:4px">
                                <span>‚úÖ</span> All changes saved
                            </div>
                        </div>
                        <div style="padding:12px">
                            <button onclick="state.activeTab='dashboard';render()" 
                                    style="width:100%;text-align:left;padding:12px;border:none;border-radius:6px;cursor:pointer;margin-bottom:4px;background:${state.activeTab === 'dashboard' ? '#374151' : 'transparent'};color:white">
                                üìä Dashboard
                            </button>
                            
                            <div style="margin-top:20px;margin-bottom:8px;padding-left:12px;font-size:0.75em;color:#9ca3af;text-transform:uppercase;letter-spacing:0.05em">Modules</div>
                            ${moduleConfigs.map(m => `
                                <button onclick="state.activeTab='${m.id}';render()" 
                                        style="width:100%;text-align:left;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;margin-bottom:2px;background:${state.activeTab === m.id ? '#374151' : 'transparent'};color:#e5e7eb;display:flex;align-items:center;gap:10px;transition:background 0.2s">
                                    <span style="width:8px;height:8px;border-radius:50%;background:${m.color}"></span>
                                    <span style="font-size:0.95em">${m.name.split(' (')[0]}</span>
                                </button>
                            `).join('')}

                            <div style="margin-top:20px;margin-bottom:8px;padding-left:12px;font-size:0.75em;color:#9ca3af;text-transform:uppercase;letter-spacing:0.05em">Milestones</div>
                            <button onclick="state.activeTab='research';render()" style="width:100%;text-align:left;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;background:${state.activeTab === 'research' ? '#374151' : 'transparent'};color:#e5e7eb">üî¨ Research Project</button>
                            <button onclick="state.activeTab='management';render()" style="width:100%;text-align:left;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;background:${state.activeTab === 'management' ? '#374151' : 'transparent'};color:#e5e7eb">üíº Management</button>
                            <button onclick="state.activeTab='other';render()" style="width:100%;text-align:left;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;background:${state.activeTab === 'other' ? '#374151' : 'transparent'};color:#e5e7eb">‚òÄÔ∏è Solar Course</button>

                            <div style="margin-top:20px;margin-bottom:8px;padding-left:12px;font-size:0.75em;color:#9ca3af;text-transform:uppercase;letter-spacing:0.05em">Assessment</div>
                            <button onclick="state.activeTab='exams';render()" style="width:100%;text-align:left;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;background:${state.activeTab === 'exams' ? '#374151' : 'transparent'};color:#e5e7eb">üìù Examinations</button>
                            <button onclick="state.activeTab='logbook';render()" style="width:100%;text-align:left;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;background:${state.activeTab === 'logbook' ? '#374151' : 'transparent'};color:#e5e7eb">üìã Master Logbook</button>
                            
                            <div style="margin-top:40px;border-top:1px solid #374151;padding-top:20px">
                                <button onclick="state.logout();render()" 
                                        style="width:100%;text-align:left;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;color:#ef4444;display:flex;align-items:center;gap:10px;background:transparent;transition:background 0.2s"
                                        onmouseover="this.style.background='rgba(239,68,68,0.1)'" onmouseout="this.style.background='transparent'">
                                    <span>üö™</span>
                                    <span style="font-size:0.95em">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-left:${state.sidebarOpen ? '260px' : '0'};transition:margin-left 0.2s">
                        
                        ${backupNeeded ? `
                            <div class="no-print" style="background:#fef2f2;color:#991b1b;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #fecaca">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span>‚ö†Ô∏è</span>
                                    <span style="font-weight:500">Backup Required! It's been over 7 days since your last backup.</span>
                                </div>
                                <button onclick="showSettings()" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:0.9em">
                                    Backup Now
                                </button>
                            </div>
                        ` : ''}

                        <div class="no-print" style="background:white;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:90">
                            <button onclick="state.sidebarOpen=!state.sidebarOpen;render()" 
                                    style="background:none;border:none;cursor:pointer;font-size:1.5em;padding:8px">
                                ${state.sidebarOpen ? '‚úï' : '‚ò∞'}
                            </button>
                            <div style="display:flex;gap:16px;align-items:center">
                                <span style="font-size:0.9em;color:#6b7280;font-weight:500">Year ${state.account.year} (Progress: ${calculateOverallProgress()}%)</span>
                                <button onclick="showProcedureModal()" 
                                        style="background:#22c55e;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:500;display:flex;align-items:center;gap:6px">
                                    <span>+</span> Quick Log
                                </button>
                                <button onclick="showSettings()" 
                                        style="background:#eff6ff;color:#2563eb;border:1px solid #dbeafe;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:500">
                                    ‚öôÔ∏è Settings
                                </button>
                            </div>
                        </div>
                        
                        ${content}
                    </div>
                </div>
            `;
        }

        // Initialize
        state.subscribe(render);
        render();

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
    </script>
</body>

</html>