<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Postgraduate Portfolio</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <style>
        :root {
            --forest-green: #15803d;
            --clay: #92400e;
            --earth-black: #1f2937;
            --bg-rural: #fdfbf7;
            /* Light sand/paper color */
            --accent-orange: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-rural);
            color: var(--earth-black);
            line-height: 1.5;
        }

        button {
            font-family: inherit;
            transition: all 0.2s;
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* Professional Inputs */
        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
        }

        .btn-rural {
            background: var(--forest-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-rural:hover {
            background: var(--clay);
        }

        /* Modal Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-overlay {
            animation: fadeIn 0.15s ease-out;
        }
    </style>
</head>

<body>
    <div id="app"></div>
    <script>
        // --- Configuration ---
        let moduleConfigs = [
            {
                id: 'surgery',
                name: 'Surgery (Module 1)',
                color: '#15803d',
                duration: '9 months',
                procedures: 45,
                assignmentList: [
                    { title: '1. Cancer Pathophysiology', prompt: 'Staging and development in rural contexts.' },
                    { title: '2. Blood Transfusion Protocols', prompt: 'Risks, safety, and rural alternatives.' }
                ],
                weeks: [
                    { id: 'w1', title: 'Trauma Assessment & Shock' },
                    { id: 'w2', title: 'Antibiotics & Pre-op Prep' }
                ]
            },
            {
                id: 'anaesthesia',
                name: 'Anaesthesiology (Module 2)',
                color: '#475569',
                duration: '4 months',
                procedures: 50,
                assignmentList: [{ title: 'Ketamine Safety', prompt: 'Protocols for peripheral settings.' }],
                weeks: [{ id: 'w1', title: 'Machine Check & Equipment' }]
            },
            {
                id: 'childhealth',
                name: 'Child Health (Module 3)',
                color: '#f97316',
                duration: '1 month',
                procedures: 30,
                weeks: [{ id: 'w1', title: 'Milestones & Malnutrition' }]
            },
            {
                id: 'obs_gyn',
                name: 'Obstetrics & Gynaecology (Module 4)',
                color: '#ec4899',
                duration: '3 months',
                procedures: 40,
                weeks: [{ id: 'w1', title: 'Menstrual Cycle' }]
            },
            {
                id: 'medicine',
                name: 'Internal Medicine (Module 5)',
                color: '#3b82f6',
                duration: '2 months',
                procedures: 20,
                weeks: [{ id: 'w1', title: 'Diabetes' }]
            },
            {
                id: 'psychiatry',
                name: 'Psychiatry (Module 6)',
                color: '#a855f7',
                duration: '1 month',
                procedures: 10
            },
            {
                id: 'publichealth',
                name: 'Public Health (Module 7)',
                color: '#10b981',
                duration: 'Longitudinal',
                procedures: 0
            },
            {
                id: 'eye_ent',
                name: 'Eye/ENT (Module 8)',
                color: '#06b6d4',
                duration: '1 month',
                procedures: 15
            },
            {
                id: 'lab',
                name: 'Laboratory (Module 9)',
                color: '#6366f1',
                duration: '1 month',
                procedures: 10
            },
            {
                id: 'management',
                name: 'Management (Module 10)',
                color: '#475569',
                duration: '4 weeks',
                procedures: 0
            }
        ];

        // --- State Management ---
        class AppState {
            constructor() {
                this.account = null;
                this.modules = {};
                this.procedureLog = [];
                this.milestones = {};
                this.logbook = {};
                this.sidebarOpen = window.innerWidth > 768;
                this.activeTab = 'dashboard';
                this.listeners = [];
                this.loadData();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('mmed_tracker_data'); // Keeping unified storage key
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.account = data.account || null;
                        this.modules = data.modules || {};
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                        this.logbook = data.logbook || {};
                    }
                } catch (e) { console.error("Data load failed", e); }
            }

            saveData() {
                localStorage.setItem('mmed_tracker_data', JSON.stringify({
                    account: this.account,
                    modules: this.modules,
                    procedureLog: this.procedureLog,
                    milestones: this.milestones,
                    logbook: this.logbook
                }));
                this.notify();
            }

            // --- Data Import/Export (Device Sync) ---
            exportData() {
                const dataStr = localStorage.getItem('mmed_tracker_data');
                if (!dataStr) return alert('No data to export!');

                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mmed_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            importData(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.account || !data.modules) throw new Error('Invalid backup file');

                        if (confirm(`Replace current data with backup from ${data.account.name}? This cannot be undone.`)) {
                            localStorage.setItem('mmed_tracker_data', JSON.stringify(data));
                            location.reload();
                        }
                    } catch (err) {
                        alert('Error importing data: ' + err.message);
                    }
                };
                reader.readAsText(file);
                input.value = ''; // Reset input
            }

            // --- Professional Auth Logic ---
            register(name, id, year, question, answer) {
                // Generate a professional random password
                const randomPass = "MMED-" + Math.floor(1000 + Math.random() * 9000);
                this.account = {
                    name,
                    id,
                    year,
                    password: randomPass,
                    securityQuestion: question,
                    securityAnswer: answer.toLowerCase(),
                    needsPasswordChange: true
                };
                this.saveData();
                return randomPass;
            }

            login(id, password) {
                if (this.account && this.account.id === id && this.account.password === password) {
                    this.session = { isLoggedIn: true };
                    return true;
                }
                return false;
            }

            resetPassword(id, answer, newPassword) {
                if (this.account && this.account.id === id && this.account.securityAnswer === answer.toLowerCase()) {
                    this.account.password = newPassword;
                    this.account.needsPasswordChange = false;
                    this.saveData();
                    return true;
                }
                return false;
            }

            logout() {
                this.session = null;
                this.notify();
            }

            updateAssignment(moduleId, index, field, value) {
                const id = `assign_${index}`;
                if (!this.modules[moduleId]) this.modules[moduleId] = { assignments: {} };
                if (!this.modules[moduleId].assignments) this.modules[moduleId].assignments = {};
                if (!this.modules[moduleId].assignments[id]) this.modules[moduleId].assignments[id] = {};

                this.modules[moduleId].assignments[id][field] = value;
                this.saveData();
            }

            notify() { this.listeners.forEach(l => l()); }
            subscribe(l) { this.listeners.push(l); }
        }

        const state = new AppState();

        // --- UI Components ---

        function renderLogin() {
            const app = document.getElementById('app');
            const isRegistered = !!state.account;

            app.innerHTML = `
                <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:100%; max-width:400px; border-top: 6px solid var(--forest-green);">
                        <div style="text-align:center; margin-bottom:30px;">
                            <h1 style="color:var(--forest-green); font-size:1.6em; font-weight:bold;">Master of Medicine (Rural)</h1>
                            <p style="color:#6b7280; font-size:0.9em;">Postgraduate Electronic Logbook</p>
                        </div>

                        ${!isRegistered ? `
                            <form onsubmit="event.preventDefault(); 
                                const pass = state.register(this.rName.value, this.rId.value, this.rYear.value, this.rQ.value, this.rA.value);
                                alert('REGISTRATION SUCCESSFUL\\n\\nDefault Password: ' + pass + '\\n\\nPlease record this to log in.');
                                render();">
                                <h3 style="margin-bottom:15px; font-size:1.1em; color:var(--clay);">Student Activation</h3>
                                <div style="display:grid; gap:12px;">
                                    <input name="rName" placeholder="Full Name" required>
                                    <input name="rId" placeholder="Student ID Number" required>
                                    <select name="rYear">
                                        <option value="1">Year 1</option><option value="2">Year 2</option>
                                        <option value="3">Year 3</option><option value="4">Year 4</option>
                                    </select>
                                    <div style="background:#fefce8; padding:10px; border-radius:6px; font-size:0.8em; border:1px solid #fef08a;">
                                        <strong>Recovery Question:</strong>
                                        <select name="rQ" style="margin-top:5px;">
                                            <option>What is your home village?</option>
                                            <option>What was your first school?</option>
                                        </select>
                                        <input name="rA" placeholder="Answer" required style="margin-top:5px;">
                                    </div>
                                    <button class="btn-rural">Activate My Portfolio</button>
                                </div>
                            </form>
                            
                            <!-- Import Data Button (Inserted for Sync) -->
                            <div style="margin-top:20px; text-align:center; border-top:1px solid #e5e7eb; padding-top:15px;">
                                <p style="font-size:0.8em; color:#6b7280; margin-bottom:10px">Already have data on PC?</p>
                                <button onclick="document.getElementById('importInput').click()" style="background:none; border:1px solid #d1d5db; padding:8px 15px; border-radius:6px; cursor:pointer; font-size:0.9em; color:#4b5563;">
                                    üì• Import Backup File
                                </button>
                                <input type="file" id="importInput" style="display:none" onchange="state.importData(this)" accept=".json">
                            </div>

                        ` : `
                            <form onsubmit="event.preventDefault(); 
                                if(state.login(this.lId.value, this.lPass.value)) render(); 
                                else alert('Invalid Credentials');">
                                <div style="display:grid; gap:15px;">
                                    <input name="lId" placeholder="Student ID" required>
                                    <div style="position:relative;">
                                        <input name="lPass" id="lPass" type="password" placeholder="Password" required>
                                        <button type="button" onclick="const p=document.getElementById('lPass'); p.type=p.type==='password'?'text':'password';" 
                                                style="position:absolute; right:10px; top:10px; background:none; border:none; cursor:pointer;">üëÅÔ∏è</button>
                                    </div>
                                    <button class="btn-rural">Sign In</button>
                                    <a href="#" onclick="showReset()" style="text-align:center; color:var(--clay); font-size:0.8em; text-decoration:none;">Forgot Password?</a>
                                </div>
                            </form>
                            <div style="margin-top:15px; text-align:center;">
                                <button onclick="if(confirm('Reset all data? Type DELETE')) { localStorage.removeItem('mmed_tracker_data'); location.reload(); }" style="color:#ef4444; background:none; border:none; font-size:0.8em; cursor:pointer;">Reset App Data</button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function showReset() {
            const id = prompt("Enter Student ID:");
            if (id !== state.account.id) return alert("ID not found.");
            const ans = prompt(`Security Question: ${state.account.securityQuestion}`);
            if (ans && ans.toLowerCase() === state.account.securityAnswer) {
                const newP = prompt("Enter New Password:");
                if (newP && state.resetPassword(id, ans, newP)) alert("Password Reset! Log in now.");
            } else alert("Incorrect Answer.");
        }

        function renderModuleDetail(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const data = state.modules[moduleId] || { assignments: {} };
            const assignList = config.assignmentList || [];

            return `
                <div style="padding:40px; max-width:1000px; margin:auto;">
                    <div style="background:var(--forest-green); color:white; padding:30px; border-radius:12px; margin-bottom:30px;">
                        <h1>${config.name}</h1>
                        <p>Rotation Duration: ${config.duration}</p>
                    </div>

                    ${assignList.length > 0 ? `
                        <h3 style="color:var(--clay); border-bottom:2px solid var(--clay); display:inline-block; margin-bottom:20px;">Assignments Tracking</h3>
                        
                        <div style="display:grid; gap:20px;">
                            ${assignList.map((a, i) => {
                const aData = (data.assignments && data.assignments[`assign_${i}`]) || {};
                return `
                                    <div style="background:white; padding:20px; border-radius:8px; border:1px solid #e5e7eb; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                        <h4 style="font-weight:bold; margin-bottom:5px;">${a.title}</h4>
                                        <p style="font-size:0.9em; color:#6b7280; margin-bottom:15px;">${a.prompt}</p>
                                        
                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                            <div>
                                                <label style="font-size:0.7em; font-weight:bold; color:var(--clay); text-transform:uppercase;">Date Started</label>
                                                <input type="date" value="${aData.dateStarted || ''}" 
                                                       onchange="state.updateAssignment('${moduleId}', ${i}, 'dateStarted', this.value)">
                                            </div>
                                            <div>
                                                <label style="font-size:0.7em; font-weight:bold; color:var(--clay); text-transform:uppercase;">Date Submitted</label>
                                                <input type="date" value="${aData.dateSubmitted || ''}" 
                                                       onchange="state.updateAssignment('${moduleId}', ${i}, 'dateSubmitted', this.value)">
                                            </div>
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    ` : '<p style="color:#6b7280;">No fixed assignments for this module.</p>'}
                </div>
            `;
        }

        function render() {
            if (!state.session || !state.session.isLoggedIn) {
                renderLogin();
                return;
            }

            // Forced Password Change
            if (state.account.needsPasswordChange) {
                const newP = prompt("SECURITY: You are using a default password. Enter a new private password:");
                if (newP) {
                    state.account.password = newP;
                    state.account.needsPasswordChange = false;
                    state.saveData();
                } else { state.logout(); return; }
            }

            const app = document.getElementById('app');
            app.innerHTML = `
                <div style="display:flex; min-height:100vh;">
                    <!-- Sidebar -->
                    <div class="no-print" style="width:260px; background:var(--earth-black); color:white; padding:20px; display:flex; flex-direction:column;">
                        <h2 style="color:var(--forest-green); margin-bottom:30px; font-weight:bold;">MMED Rural</h2>
                        <button onclick="state.activeTab='dashboard'; render()" style="width:100%; text-align:left; background:none; border:none; color:white; padding:10px; cursor:pointer;">üìä Dashboard</button>
                        <hr style="margin:20px 0; border:0; border-top:1px solid #374151;">
                        <p style="font-size:0.7em; color:#9ca3af; margin-bottom:10px; letter-spacing:1px;">MODULES</p>
                        ${moduleConfigs.map(m => `
                            <button onclick="state.activeTab='${m.id}'; render()" style="width:100%; text-align:left; background:none; border:none; color:#d1d5db; padding:8px; cursor:pointer; font-size:0.9em;">‚Ä¢ ${m.name}</button>
                        `).join('')}
                        
                        <div style="margin-top:auto;">
                            <button onclick="state.exportData()" style="width:100%; text-align:left; background:none; border:none; color:#fbbf24; padding:8px; cursor:pointer; font-size:0.9em; margin-bottom:10px;">üì• Backup Data</button>
                            <button onclick="state.logout(); render()" style=" color:#f87171; background:none; border:none; cursor:pointer;">üö™ Sign Out</button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div style="flex:1; overflow-y:auto;">
                        ${state.activeTab === 'dashboard' ? `
                            <div style="padding:40px;">
                                <h1 style="color:var(--forest-green);">Welcome, Dr. ${state.account.name}</h1>
                                <p style="color:#6b7280;">Masters in Medicine (Rural) | Year ${state.account.year}</p>
                                <div style="margin-top:30px; background:white; padding:20px; border-radius:12px; border-left:5px solid var(--accent-orange);">
                                    <h3 style="color:var(--clay);">Academic Status</h3>
                                    <p style="font-size:0.9em;">Ensure all procedure logs are signed by supervisors before rotation end.</p>
                                </div>
                            </div>
                        ` : renderModuleDetail(state.activeTab)}
                    </div>
                </div>
            `;
        }

        state.subscribe(render);
        render();

        // --- Service Worker Registration (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }
    </script>
</body>

</html>