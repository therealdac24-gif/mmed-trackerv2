<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Postgraduate Portfolio</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <style>
        :root {
            --forest-green: #15803d;
            --clay: #92400e;
            --earth-black: #1f2937;
            --bg-rural: #fdfbf7;
            /* Light sand/paper color */
            --accent-orange: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-rural);
            color: var(--earth-black);
            line-height: 1.5;
        }

        button {
            font-family: inherit;
            transition: all 0.2s;
            cursor: pointer;
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* Modern Inputs */
        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--forest-green);
            ring: 2px solid #bbf7d0;
        }

        /* Buttons */
        .btn-rural {
            background: var(--forest-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
        }

        .btn-rural:hover {
            background: #166534;
        }

        .btn-secondary {
            background: white;
            color: var(--earth-black);
            border: 1px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        /* Status Pills */
        .status-badge {
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.75em;
            font-weight: 600;
            display: inline-block;
        }

        .status-done {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-pending {
            background: #fef9c3;
            color: #854d0e;
            border: 1px solid #fde047;
        }

        .status-none {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        /* Layout */
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Mobile Sidebar */
        #sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 260px;
            background: #0f172a;
            color: #cbd5e1;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        #sidebar.open {
            transform: translateX(0);
        }

        @media (min-width: 769px) {
            #sidebar {
                position: sticky;
                transform: none;
                height: 100vh;
            }
        }

        .nav-item {
            padding: 12px 20px;
            color: inherit;
            text-decoration: none;
            display: block;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #1e293b;
            color: white;
        }

        .nav-item.active {
            background: #1e293b;
            color: white;
            border-left-color: var(--forest-green);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body>
    <div id="app"></div>

    <script>
        // --- CONFIGURATION ---
        const moduleConfigs = [
            { id: 'surgery', name: 'Surgery (Module 1)', color: '#15803d', duration: '9 months', procedures: 45, weeks: [{ id: 'w1', title: 'Trauma Assessment' }, { id: 'w2', title: 'Antibiotics' }, { id: 'w3', title: 'Sterilization' }, { id: 'w4', title: 'Theatre Setup' }, { id: 'w5', title: 'Acute Pain' }, { id: 'w6', title: 'Chronic Pain' }, { id: 'w7', title: 'Wounds' }, { id: 'w8', title: 'Transfer' }, { id: 'w9', title: 'Pyomyositis' }, { id: 'w10', title: 'Chest Drains' }, { id: 'w11', title: 'Closed Fractures' }, { id: 'w12', title: 'Neurovascular' }, { id: 'w13', title: 'Dental' }, { id: 'w14', title: 'Abscesses' }, { id: 'w15', title: 'Appendicitis' }, { id: 'w16', title: 'Laparotomy' }, { id: 'w17', title: 'Gut Repair' }, { id: 'w18', title: 'Stomas' }, { id: 'w19', title: 'Obstruction' }, { id: 'w20', title: 'Casting' }, { id: 'w21', title: 'Traction' }, { id: 'w22', title: 'Open Fractures' }, { id: 'w23', title: 'Dislocations' }, { id: 'w24', title: 'Upper Limb' }, { id: 'w25', title: 'Bleeding' }, { id: 'w26', title: 'Enucleation' }, { id: 'w27', title: 'Hernia' }, { id: 'w28', title: 'Strangulated Hernia' }, { id: 'w29', title: 'Minor Ops' }, { id: 'w30', title: 'Head/Spine' }, { id: 'w31', title: 'Burns' }, { id: 'w32', title: 'Ethics' }], assignmentList: ['1. Cancer Pathophysiology', '2. Cancer Screening', '3. Blood Transfusion', '4. Blood/Haemopoiesis', '5. Cytokines', '6. Wound Healing', '7. Hb/Oxygen', '8. Genetics', '9. Nerve Conduction', '10. Pain Pathways', '11. Urodynamics', '12. CSF/ICP', '13. Calcium', '14. Liver Function', '15. Bile/Gallstones', '16. Oedema', '17. Thrombosis', '18. Gastric Secretion', '19. Surgical Infections', '20. Antibiotics Policy'] },
            { id: 'anaesthesia', name: 'Anaesthesiology (Module 2)', color: '#475569', duration: '4 months', procedures: 50, weeks: [{ id: 'w1', title: 'Equipment' }, { id: 'w2', title: 'Ketamine' }, { id: 'w3', title: 'Propofol' }, { id: 'w4', title: 'Pre-op' }, { id: 'w5', title: 'Opiates' }, { id: 'w6', title: 'Chronic Pain' }, { id: 'w7', title: 'Spinal' }, { id: 'w8', title: 'Brachial' }, { id: 'w9', title: 'Wrist/Ankle' }, { id: 'w10', title: 'Neonatal Resus' }, { id: 'w11', title: 'Can\'t Intubate' }, { id: 'w12', title: 'IV Access' }, { id: 'w13', title: 'Cardiac Arrest' }, { id: 'w14', title: 'Outcomes' }], caseReports: ['General Anaesthesia', 'Ketamine', 'Spinal', 'Paediatric', 'Resuscitation'] },
            { id: 'childhealth', name: 'Child Health (Module 3)', color: '#f97316', duration: '1 month', procedures: 30, weeks: [{ id: 'w1', title: 'Milestones' }, { id: 'w2', title: 'Pneumonia' }, { id: 'w3', title: 'Cardiac' }, { id: 'w4', title: 'Newborn' }, { id: 'w5', title: 'Ponsetti' }, { id: 'w6', title: 'Immunization' }], caseReports: ['Pneumonia', 'Diarrhoea', 'Malnutrition', 'Meningitis', 'Neonatal Sepsis'] },
            { id: 'obs_gyn', name: 'Obs & Gynae (Module 4)', color: '#ec4899', duration: '3 months', procedures: 40, weeks: [{ id: 'w1', title: 'Menstral' }, { id: 'w2', title: 'Contraception' }, { id: 'w3', title: 'Antenatal' }, { id: 'w4', title: 'USS' }, { id: 'w5', title: 'Miscarriage' }, { id: 'w6', title: 'Labour' }, { id: 'w7', title: 'Partograms' }, { id: 'w8', title: 'CS' }, { id: 'w9', title: 'APH' }, { id: 'w10', title: 'Failure Progress' }, { id: 'w11', title: 'PPH' }, { id: 'w12', title: 'Sepsis' }, { id: 'w13', title: 'Infertility' }, { id: 'w15', title: 'Ovarian' }, { id: 'w17', title: 'Endometrial' }, { id: 'w19', title: 'Cervical' }, { id: 'w21', title: 'Pelvic Sepsis' }, { id: 'w23', title: 'Pre-eclampsia' }, { id: 'w26', title: 'PPH Adv' }, { id: 'w29', title: 'Destructive' }], assignmentList: ['Antenatal/Family Planning', 'Emergency Obstetric Care'] },
            { id: 'medicine', name: 'Internal Medicine (Module 5)', color: '#3b82f6', duration: '2 months', procedures: 20, weeks: [{ id: 'w1', title: 'Diabetes' }, { id: 'w2', title: 'Sepsis' }, { id: 'w3', title: 'TB' }, { id: 'w4', title: 'Snake/ECG' }, { id: 'w5', title: 'HTN/HIV' }, { id: 'w6', title: 'Asthma' }], caseReports: ['Severe Malaria', 'Meningitis', 'Pneumonia', 'Heart Failure', 'TB'] },
            { id: 'psychiatry', name: 'Psychiatry (Module 6)', color: '#a855f7', duration: '1 month', procedures: 10, caseReports: ['Acute Psychosis', 'Somatoform'] },
            { id: 'publichealth', name: 'Public Health (Module 7)', color: '#10b981', duration: 'Longitudinal', assignmentList: ['PH1: Community', 'PH2: Outbreak', 'PH3: Evaluation', 'PH4: Management', 'PH5: Environment'] },
            { id: 'eye_ent', name: 'Eye/ENT (Module 8)', color: '#06b6d4', duration: '1 month', procedures: 15, caseReports: ['Eye Injury', 'Red Eye', 'Epistaxis'] },
            { id: 'lab', name: 'Laboratory (Module 9)', color: '#6366f1', duration: '1 month', procedures: 10, assignmentList: ['Cross-match', 'Malaria Stain'] },
            { id: 'management', name: 'Management (Module 10)', color: '#475569', duration: '4 weeks', assignmentList: ['4-Week Course', 'Major Assignment'] }
        ];

        const milestoneConfigs = {
            research: [{ id: 'res_topic', label: 'Topic Approved' }, { id: 'res_data', label: 'Data Collection' }, { id: 'res_submit', label: 'Submitted' }, { id: 'res_present', label: 'Presented' }],
            exams: [{ id: 'exam_part1', label: 'Part 1 Passed' }, { id: 'exam_part2_written', label: 'Part 2 Written' }, { id: 'exam_part2_clinical', label: 'Part 2 Clinical' }],
            management: [{ id: 'mgmt_course', label: 'Course' }, { id: 'mgmt_assign', label: 'Assignment' }],
            other: [{ id: 'solar_course', label: 'Solar/Radio Course' }]
        };

        const masterLogbookConfig = [
            { category: 'Anaesthesiology', items: [{ id: 'la_pre', label: 'Pre-op', target: 50 }, { id: 'la_int', label: 'Intubation', target: 10 }, { id: 'la_spin', label: 'Spinal', target: 20 }, { id: 'la_ket', label: 'Ketamine', target: 10 }] },
            { category: 'Obs & Gynae', items: [{ id: 'lo_norm', label: 'Normal Delivery', target: 20 }, { id: 'lo_cs', label: 'LUSCS', target: 6 }, { id: 'lo_breech', label: 'Breech', target: 5 }, { id: 'lo_vac', label: 'Vacuum', target: 6 }, { id: 'lo_pph', label: 'PPH', target: 6 }] },
            { category: 'Child Health', items: [{ id: 'lc_neo', label: 'Neonatal Resus', target: 4 }, { id: 'lc_pon', label: 'Ponsetti', target: 2 }, { id: 'lc_io', label: 'Intraosseous', target: 1 }] },
            { category: 'Surgery & Med', items: [{ id: 'ls_hernia', label: 'Hernia', target: 8 }, { id: 'ls_lap', label: 'Laparotomy', target: 5 }, { id: 'ls_chest', label: 'Chest Drain', target: 7 }, { id: 'lm_lp', label: 'Lumbar Puncture', target: 10 }] },
            { category: 'Laboratory', items: [{ id: 'log_blood', label: 'Blood X-Match', target: 10 }, { id: 'log_malaria', label: 'Malaria Stain', target: 10 }] }
        ];

        // --- APP STATE ---
        class AppState {
            constructor() {
                this.account = null;
                this.modules = {};
                this.procedureLog = [];
                this.milestones = {};
                this.logbook = {};
                this.activeTab = 'dashboard';
                this.sidebarOpen = false;
                this._loginHandled = false;

                this.initFirebase();
                this.loadData();
            }

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyBhEln9kmgq22NnNHI83eUH7_d6S4F1O5s",
                    authDomain: "rural-mmed-logbook-3e095.firebaseapp.com",
                    projectId: "rural-mmed-logbook-3e095",
                    storageBucket: "rural-mmed-logbook-3e095.firebasestorage.app",
                    messagingSenderId: "826477177641",
                    appId: "1:826477177641:web:fe9de6e733b442fdffe538"
                };

                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();

                    // CRITICAL: Handle Redirect Result (but only if not logged in)
                    if (!this.auth.currentUser) {
                        this.auth.getRedirectResult().then(result => {
                            if (result.user) {
                                console.log("Redirect Success:", result.user.email);
                                this.handleCloudLogin(result.user);
                            }
                        }).catch(e => console.error("Redirect Error (Benign):", e.code));
                    }

                    this.auth.onAuthStateChanged(user => {
                        if (user) this.handleCloudLogin(user);
                    });
                } catch (e) {
                    console.error("Firebase Init Failed:", e);
                }
            }

            async handleCloudLogin(user) {
                if (this._loginHandled && this.account && this.account.id === user.uid) return;
                this._loginHandled = true;

                const defaultYear = 1;
                const cloudRef = this.db.collection('users').doc(user.uid);

                try {
                    const doc = await cloudRef.get();
                    let cloudData = doc.exists ? doc.data() : {};

                    this.account = {
                        name: cloudData.account?.name || user.displayName || "Dr. " + user.email.split('@')[0],
                        email: user.email,
                        id: user.uid,
                        year: cloudData.account?.year || defaultYear,
                        lastBackup: Date.now()
                    };

                    this.modules = cloudData.modules || this.modules;
                    this.procedureLog = cloudData.procedureLog || this.procedureLog;
                    this.milestones = cloudData.milestones || this.milestones;
                    this.logbook = cloudData.logbook || this.logbook;

                    this.saveData(true);
                } catch (e) {
                    console.error("Sync Error:", e);
                    this.account = { name: user.displayName || "User", email: user.email, id: user.uid, year: defaultYear };
                    alert("Synced Offline Mode.");
                } finally {
                    render();
                }
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('mmed_struct');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.account = data.account || null;
                        this.modules = data.modules || {};
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                        this.logbook = data.logbook || {};
                    }
                    // Ensure structure exists
                    moduleConfigs.forEach(m => {
                        if (!this.modules[m.id]) this.modules[m.id] = { assignments: {}, weeks: {}, caseReports: {} };
                    });
                } catch (e) { console.error("Load failed", e); }
            }

            saveData(skipCloud = false) {
                const data = { account: this.account, modules: this.modules, procedureLog: this.procedureLog, milestones: this.milestones, logbook: this.logbook };
                localStorage.setItem('mmed_struct', JSON.stringify(data));

                if (!skipCloud && this.account && this.db && this.account.id) {
                    this.db.collection('users').doc(this.account.id).set(data, { merge: true }).catch(e => console.error(e));
                }
            }

            // --- AUTH ACTIONS ---
            signInWithGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                // Strategy: Popup First -> Redirect Fallback
                this.auth.signInWithPopup(provider)
                    .then(result => this.handleCloudLogin(result.user))
                    .catch(error => {
                        console.warn("Popup blocked/closed, using redirect...", error.code);
                        this.auth.signInWithRedirect(provider);
                    });
            }

            logout() {
                this._loginHandled = false;
                if (this.auth) this.auth.signOut();
                this.account = null;
                this.session = null;
                this.saveData(true); // <--- CRITICAL FIX: Wipes user from localStorage
                location.reload();
            }

            signInWithEmail() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                if (!email || !password) return alert("Enter email/password");

                this.auth.signInWithEmailAndPassword(email, password)
                    .catch(e => {
                        if (e.code === 'auth/user-not-found') {
                            if (confirm("User not found. Create Account?")) this.auth.createUserWithEmailAndPassword(email, password);
                        } else alert("Error: " + e.message);
                    });
            }

            // --- DATA ACTIONS ---
            updateModule(modId, type, itemId, val) {
                if (!this.modules[modId]) this.modules[modId] = { weeks: {}, assignments: {}, caseReports: {} };

                if (type === 'week') {
                    if (!this.modules[modId].weeks[itemId]) this.modules[modId].weeks[itemId] = {};
                    this.modules[modId].weeks[itemId] = { ...this.modules[modId].weeks[itemId], ...val };
                }
                else if (type === 'assign') {
                    if (!this.modules[modId].assignments[itemId]) this.modules[modId].assignments[itemId] = {};
                    this.modules[modId].assignments[itemId] = { ...this.modules[modId].assignments[itemId], ...val };
                }
                else if (type === 'case') {
                    if (!this.modules[modId].caseReports) this.modules[modId].caseReports = {};
                    this.modules[modId].caseReports[itemId] = val; // 'Done' or null
                }
                this.saveData();
                render();
            }

            addProcedure(data) {
                this.procedureLog.push({ ...data, timestamp: Date.now() });
                this.saveData();
                render();
            }

            exportData() {
                const blob = new Blob([JSON.stringify(localStorage.getItem('mmed_struct'))], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `mmed_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            }

            importData(input) {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const raw = JSON.parse(e.target.result); // Unwraps the stringified storage
                        const data = JSON.parse(raw);
                        if (confirm("Restore backup?")) {
                            localStorage.setItem('mmed_struct', JSON.stringify(data));
                            location.reload();
                        }
                    } catch (e) { alert("Import failed: " + e.message); }
                };
                reader.readAsText(input.files[0]);
            }
        }

        const state = new AppState();

        // --- VIEWS ---

        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; background-color:#0d1117; color:#c9d1d9;">
                    <div style="width:100%; max-width:350px; text-align:center;">
                        <div style="font-size:3rem; margin-bottom:10px;">üè•</div>
                        <h1 style="color:white; font-size:1.5rem; font-weight:300; margin-bottom:20px;">Sign in to MMED Rural</h1>
                        
                        <div style="background:#161b22; padding:20px; border:1px solid #30363d; border-radius:6px; text-align:left;">
                            <label style="display:block; margin-bottom:8px; font-size:14px;">Email address</label>
                            <input type="email" id="email" style="margin-bottom:15px; background:#0d1117; border-color:#30363d; color:white;">
                            
                            <label style="display:block; margin-bottom:8px; font-size:14px;">Password</label>
                            <input type="password" id="password" style="margin-bottom:20px; background:#0d1117; border-color:#30363d; color:white;">
                            
                            <button onclick="state.signInWithEmail()" style="width:100%; padding:10px; background:#238636; color:white; border:none; border-radius:6px; font-weight:bold; margin-bottom:15px;">Sign in / Sign up</button>

                            <div style="text-align:center; position:relative; margin:15px 0;">
                                <span style="background:#161b22; padding:0 10px; color:#8b949e; position:relative; z-index:1; font-size:12px;">OR</span>
                                <div style="position:absolute; top:50%; left:0; width:100%; height:1px; background:#30363d;"></div>
                            </div>

                            <button onclick="state.signInWithGoogle()" style="width:100%; padding:8px; background:#21262d; color:#c9d1d9; border:1px solid #30363d; border-radius:6px; display:flex; align-items:center; justify-content:center; gap:10px;">
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Continue with Google
                            </button>
                            
                            <button onclick="document.getElementById('import').click()" style="width:100%; margin-top:10px; padding:8px; background:none; border:none; color:#58a6ff; font-size:12px; cursor:pointer;">üì• Import Offline Backup</button>
                            <input type="file" id="import" style="display:none" onchange="state.importData(this)" accept=".json">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const user = state.account;
            const completedProcs = state.procedureLog.length;

            return `
                <div class="card" style="border-top: 4px solid var(--forest-green);">
                    <h2 style="color:var(--forest-green); margin-bottom:5px;">Welcome, Dr. ${user.name}</h2>
                    <p style="color:#6b7280;">Masters in Medicine (Rural) | Year ${user.year}</p>
                    
                    <div style="margin-top:20px; display:flex; gap:20px; flex-wrap:wrap;">
                        <div style="flex:1; background:#f0fdf4; padding:15px; border-radius:8px; border:1px solid #bbf7d0;">
                            <span style="display:block; font-size:0.8em; color:#166534; font-weight:bold;">PROCEDURES</span>
                            <span style="font-size:2em; font-weight:bold; color:#15803d;">${completedProcs}</span>
                        </div>
                        <div style="flex:1; background:#fefce8; padding:15px; border-radius:8px; border:1px solid #fde047;">
                            <span style="display:block; font-size:0.8em; color:#854d0e; font-weight:bold;">PENDING WEEKS</span>
                            <span style="font-size:2em; font-weight:bold; color:#ca8a04;">
                                ${Object.values(state.modules).reduce((num, m) => num + Object.values(m.weeks || {}).filter(w => w.status === 'Pending').length, 0)}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Profile Settings</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div>
                            <label style="font-size:0.8em; font-weight:bold;">Display Name</label>
                            <input type="text" value="${user.name}" onchange="state.account.name = this.value; state.saveData()">
                        </div>
                        <div>
                            <label style="font-size:0.8em; font-weight:bold;">Year</label>
                            <select onchange="state.account.year = parseInt(this.value); state.saveData(); render();">
                                ${[1, 2, 3, 4, 5, 6].map(y => `<option value="${y}" ${user.year === y ? 'selected' : ''}>Year ${y}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModule(id) {
            const config = moduleConfigs.find(c => c.id === id);
            const data = state.modules[id];

            return `
                <div style="padding:20px; background:${config.color}; color:white; border-radius:12px 12px 0 0; margin-bottom:20px;">
                    <h1>${config.name}</h1>
                </div>

                <!-- WEEKS -->
                ${config.weeks ? `
                <div class="card">
                    <h3>Clinical Schedule</h3>
                    <div style="display:grid; gap:10px; margin-top:10px;">
                    ${config.weeks.map(w => {
                const stat = (data.weeks[w.id] || {}).status || 'Not Started';
                return `
                            <div style="padding:10px; border:1px solid #e5e7eb; border-radius:6px; background:${stat === 'Completed' ? '#f0fdf4' : 'white'}; display:flex; align-items:center; justify-content:space-between;">
                                <div><strong>${w.title}</strong></div>
                                <select onchange="state.updateModule('${id}','week','${w.id}',{status:this.value})">
                                    <option ${stat === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                    <option ${stat === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option ${stat === 'Completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>`;
            }).join('')}
                    </div>
                </div>` : ''}

                <!-- PROCEDURES -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Procedure Log (${state.procedureLog.filter(p => p.moduleId === id).length} / ${config.procedures || 0})</h3>
                        <div>
                            <button class="btn-secondary" onclick="renderPrintView('${id}')">üñ®Ô∏è Print</button>
                            <button class="btn-rural" onclick="showLogModal('${id}')">+ New</button>
                        </div>
                    </div>
                    ${state.procedureLog.filter(p => p.moduleId === id).length === 0 ? '<p style="margin-top:10px; color:#9ca3af;">No logs yet.</p>' : ''}
                    <div style="margin-top:10px;">
                        ${state.procedureLog.filter(p => p.moduleId === id).map(p => `
                            <div style="padding:8px; border-bottom:1px solid #eee;">
                                <strong>${p.procedure}</strong> (${p.date}) - Sup: ${p.supervisor}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- MASTER RENDER ---
        function render() {
            if (!state.account) return renderLogin();

            const app = document.getElementById('app');
            let content = '';

            if (state.activeTab === 'dashboard') content = renderDashboard();
            else if (state.activeTab === 'logbook') content = renderMasterLogbookView(); // Renamed to avoid confusion
            else content = renderModule(state.activeTab);

            app.innerHTML = `
                <div style="display:flex; min-height:100vh;">
                    <!-- Sidebar -->
                    <div id="sidebar">
                        <div style="padding:20px; font-weight:bold; font-size:1.2em; color:white;">MMED Rural</div>
                        <a href="#" class="nav-item ${state.activeTab === 'dashboard' ? 'active' : ''}" onclick="state.activeTab='dashboard';render()">Dashboard</a>
                        ${moduleConfigs.map(m => `<a href="#" class="nav-item ${state.activeTab === m.id ? 'active' : ''}" onclick="state.activeTab='${m.id}';render()">${m.name}</a>`).join('')}
                        <div style="margin-top:auto; padding:20px;">
                            <button onclick="state.logout()" style="width:100%; background:#ef4444; color:white; border:none; padding:10px; border-radius:6px;">Sign Out</button>
                        </div>
                    </div>

                    <!-- Overlay for mobile -->
                    <div class="${state.sidebarOpen ? 'modal-overlay' : ''}" onclick="state.sidebarOpen=false;render()" style="${state.sidebarOpen ? '' : 'display:none;'}"></div>

                    <!-- Main Content -->
                    <div style="flex:1; display:flex; flex-direction:column; height:100vh; overflow:hidden;">
                        <!-- Mobile Header -->
                        <div class="no-print" style="padding:15px; background:var(--forest-green); color:white; display:flex; align-items:center; gap:15px; display:none;">
                            <button onclick="document.getElementById('sidebar').classList.add('open')" style="background:none; border:none; color:white; font-size:1.5em;">‚ò∞</button>
                            <strong>MMED Rural</strong>
                        </div>
                        <style>@media(max-width:768px){ .no-print[style*="background:var(--forest-green)"] { display:flex !important; } }</style>

                        <div style="flex:1; overflow-y:auto; padding:20px;">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
        }

        function showLogModal(modId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Log Procedure</h2>
                    <form onsubmit="event.preventDefault(); submitLog(this, '${modId}')">
                        <label>Date</label><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" style="margin-bottom:10px;">
                        <label>Procedure</label><input type="text" name="proc" required placeholder="e.g. Appendectomy" style="margin-bottom:10px;">
                        <label>Supervisor</label><input type="text" name="sup" required style="margin-bottom:20px;">
                        <button class="btn-rural" style="width:100%">Save Log</button>
                    </form>
                    <button onclick="this.closest('.modal-overlay').remove()" style="margin-top:10px; width:100%; border:none; background:none; color:#6b7280;">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        window.submitLog = (form, modId) => {
            state.addProcedure({ moduleId: modId, date: form.date.value, procedure: form.proc.value, supervisor: form.sup.value });
            document.querySelector('.modal-overlay').remove();
        };

        function renderPrintView(modId) {
            const config = moduleConfigs.find(c => c.id === modId);
            const logs = state.procedureLog.filter(p => p.moduleId === modId);
            document.body.innerHTML = `
                <div style="padding:40px; font-family:serif;">
                    <h1 style="text-align:center;">${config.name} Logbook</h1>
                    <p style="text-align:center;">Resident: ${state.account.name} (Year ${state.account.year})</p>
                    <table style="width:100%; border-collapse:collapse; margin-top:30px;">
                        <thead>
                            <tr style="background:#eee;"><th style="border:1px solid #000; padding:10px;">Date</th><th style="border:1px solid #000; padding:10px;">Procedure</th><th style="border:1px solid #000; padding:10px;">Supervisor</th><th style="border:1px solid #000; padding:10px;">Signature</th></tr>
                        </thead>
                        <tbody>
                            ${logs.map(l => `<tr><td style="border:1px solid #000; padding:10px;">${l.date}</td><td style="border:1px solid #000; padding:10px;">${l.procedure}</td><td style="border:1px solid #000; padding:10px;">${l.supervisor}</td><td style="border:1px solid #000; padding:10px;"></td></tr>`).join('')}
                        </tbody>
                    </table>
                    <div class="no-print" style="margin-top:20px; text-align:center;">
                        <button onclick="window.print()" class="btn-rural">Print</button>
                        <button onclick="location.reload()" class="btn-secondary">Back</button>
                    </div>
                </div>
            `;
        }

        // Initial Render Call
        render();

    </script>
</body>

</html>