<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Postgraduate Portfolio</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <style>
        :root {
            --forest-green: #15803d;
            --clay: #92400e;
            --earth-black: #1f2937;
            --bg-rural: #fdfbf7;
            /* Light sand/paper color */
            --accent-orange: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-rural);
            color: var(--earth-black);
            line-height: 1.5;
        }

        button {
            font-family: inherit;
            transition: all 0.2s;
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }

        /* Professional Inputs */
        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
        }

        .btn-rural {
            background: var(--forest-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-rural:hover {
            background: var(--clay);
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-done {
            background: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Modal Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-overlay {
            animation: fadeIn 0.15s ease-out;
        }
    </style>
</head>

<body>
    <div id="app"></div>
    <script>
        // --- Detailed Configuration (The Content You Like) ---
        const moduleConfigs = [
            {
                id: 'surgery',
                name: 'Surgery (Module 1)',
                color: '#15803d',
                duration: '9 months',
                procedures: 45,
                weeks: [
                    { id: 'w1', title: 'Trauma Assessment & Shock' }, { id: 'w2', title: 'Antibiotics & Pre-op Prep' },
                    { id: 'w3', title: 'Instruments & Sterilization' }, { id: 'w4', title: 'Theatre Setup (Case: Stab wound)' },
                    { id: 'w5', title: 'Acute Pain' }, { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Wounds & Suturing' }, { id: 'w8', title: 'Transfer Principles' },
                    { id: 'w9', title: 'Pyomyositis & Osteo' }, { id: 'w10', title: 'Chest Drains' },
                    { id: 'w11', title: 'Closed Fractures' }, { id: 'w12', title: 'Neurovascular & Secondary Intention' },
                    { id: 'w13', title: 'Dental/Airway Infections' }, { id: 'w14', title: 'Abscesses' },
                    { id: 'w15', title: 'Appendicitis' }, { id: 'w16', title: 'Laparotomy Basics' },
                    { id: 'w17', title: 'Gut Repair' }, { id: 'w18', title: 'Stomas & Ulcers' },
                    { id: 'w19', title: 'Bowel Obstruction' }, { id: 'w20', title: 'Casting & Splinting' },
                    { id: 'w21', title: 'Traction' }, { id: 'w22', title: 'Open Fractures' },
                    { id: 'w23', title: 'Dislocations' }, { id: 'w24', title: 'Upper Limb Trauma' },
                    { id: 'w25', title: 'Bleeding Control' }, { id: 'w26', title: 'Enucleation' },
                    { id: 'w27', title: 'Hernia Repair' }, { id: 'w28', title: 'Strangulated Hernia' },
                    { id: 'w29', title: 'Minor Procedures' }, { id: 'w30', title: 'Head & Spinal Injury' },
                    { id: 'w31', title: 'Burns' }, { id: 'w32', title: 'Ethics' }
                ],
                assignmentList: [
                    { title: '1. Cancer Pathophysiology', prompt: 'Staging and development in rural contexts.' },
                    { title: '2. Cancer Screening in PNG', prompt: 'Pros/cons of screening programs.' },
                    { title: '3. Blood Transfusion Protocols', prompt: 'Risks, safety, and rural alternatives.' },
                    { title: '4. Blood / Haemopoiesis', prompt: 'Blood cell development, splenomegaly pathology.' },
                    { title: '5. Cytokines', prompt: 'Role in wound healing, inflammation, haemostasis, neoplasia.' },
                    { title: '6. Wound Healing Physiology', prompt: 'Stages of healing in different tissues.' },
                    { title: '7. Hb & Oxygen Transport', prompt: 'Oxygen dissociation curve, respiratory failure types.' },
                    { title: '8. Genetics', prompt: 'Genetic defects, gene therapy, counselling.' },
                    { title: '9. Nerve Conduction', prompt: 'Peripheral nerve injuries, diagnosis, assessment.' },
                    { title: '10. Pain Pathways', prompt: 'Pathways, analgesics, local anaesthetics.' },
                    { title: '11. Urodynamics', prompt: 'Incontinence, spinal cord injury, bladder function.' },
                    { title: '12. CSF & ICP', prompt: 'Pathophysiology of raised intracranial pressure.' },
                    { title: '13. Calcium Homeostasis', prompt: 'Renal calculi, hypercalcemia, osteoporosis.' },
                    { title: '14. Liver Function', prompt: 'Portal hypertension, cirrhosis, ascites, encephalopathy.' },
                    { title: '15. Bile & Gallstones', prompt: 'Bile composition, gallbladder function, stones.' },
                    { title: '16. Oedema', prompt: 'Pathophysiology of unilateral leg swelling.' },
                    { title: '17. Thrombosis', prompt: 'Thrombosis, embolism, anticoagulants.' },
                    { title: '18. Gastric Secretion', prompt: 'Physiology, H. pylori, ulcer, cancer.' },
                    { title: '19. Surgical Infections', prompt: 'Osteomyelitis, HIV, TB, Necrotising Fasciitis.' },
                    { title: '20. Antibiotics Policy', prompt: 'Antibiotic policy recommendations and monitoring.' }
                ]
            },
            {
                id: 'anaesthesia',
                name: 'Anaesthesiology (Module 2)',
                color: '#475569',
                duration: '4 months',
                procedures: 50,
                weeks: [
                    { id: 'w1', title: 'Machine Check & Equipment' }, { id: 'w2', title: 'Ketamine (Pharma & Use)' },
                    { id: 'w3', title: 'Propofol & Benzos' }, { id: 'w4', title: 'Pre-op Assessment' },
                    { id: 'w5', title: 'Opiates & Deferring Surgery' }, { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Spinal & LUSCS' }, { id: 'w8', title: 'Brachial Plexus Blocks' },
                    { id: 'w9', title: 'Wrist/Ankle Blocks' }, { id: 'w10', title: 'Neonatal Resuscitation' },
                    { id: 'w11', title: 'Cannot Intubate/Ventilate' }, { id: 'w12', title: 'IV Access' },
                    { id: 'w13', title: 'Cardiac Arrest' }, { id: 'w14', title: 'Handling Negative Outcomes' }
                ],
                caseReports: ['General Anaesthesia', 'Ketamine Anaesthesia', 'Spinal Anaesthesia', 'Paediatric Anaesthesia', 'Resuscitation']
            },
            {
                id: 'childhealth',
                name: 'Child Health (Module 3)',
                color: '#f97316',
                duration: '1 month',
                procedures: 30,
                weeks: [
                    { id: 'w1', title: 'Milestones & Malnutrition' }, { id: 'w2', title: 'Pneumonia & Oxygen' },
                    { id: 'w3', title: 'Cardiac & Kidney' }, { id: 'w4', title: 'Newborn Exam ' },
                    { id: 'w5', title: 'Ponsetti & Diarrhoea' }, { id: 'w6', title: 'Immunization' }
                ],
                caseReports: ['Pneumonia', 'Diarrhoea', 'Malnutrition', 'Meningitis', 'Neonatal Sepsis']
            },
            {
                id: 'obs_gyn',
                name: 'Obs & Gynae (Module 4)',
                color: '#ec4899',
                duration: '3 months',
                procedures: 40,
                weeks: [
                    { id: 'w1', title: 'Menstrual Cycle' }, { id: 'w2', title: 'Contraception' },
                    { id: 'w3', title: 'Routine Antenatal' }, { id: 'w4', title: 'Basic USS' },
                    { id: 'w5', title: 'Miscarriage/Ectopic' }, { id: 'w6', title: 'Normal Labour' },
                    { id: 'w7', title: 'Partograms' }, { id: 'w8', title: 'CS Technique' },
                    { id: 'w9', title: 'APH & Pre-eclampsia' }, { id: 'w10', title: 'Failure to Progress' },
                    { id: 'w11', title: 'PPH' }, { id: 'w12', title: 'Puerperal Sepsis' },
                    { id: 'w13', title: 'Infertility' }, { id: 'w15', title: 'Ovarian Tumours' },
                    { id: 'w17', title: 'Endometrial CA' }, { id: 'w19', title: 'Cervical CA' },
                    { id: 'w21', title: 'Pelvic Sepsis' }, { id: 'w23', title: 'Pre-eclampsia/Eclampsia' },
                    { id: 'w26', title: 'PPH Advanced' }, { id: 'w29', title: 'Destructive Delivery' }
                ],
                assignmentList: [
                    { title: 'Written Assignment 1', prompt: 'Topic: Antenatal Care or Family Planning' },
                    { title: 'Written Assignment 2', prompt: 'Topic: Emergency Obstetric Care' }
                ]
            },
            {
                id: 'medicine',
                name: 'Internal Medicine (Module 5)',
                color: '#3b82f6',
                duration: '2 months',
                procedures: 20,
                weeks: [
                    { id: 'w1', title: 'Diabetes' }, { id: 'w2', title: 'Antibiotics & Sepsis' },
                    { id: 'w3', title: 'Tuberculosis' }, { id: 'w4', title: 'Snake Bite & ECG' },
                    { id: 'w5', title: 'Hypertension & HIV' }, { id: 'w6', title: 'Asthma/COAD' }
                ],
                caseReports: ['Severe Malaria', 'Meningitis', 'Pneumonia', 'Heart Failure', 'TB']
            },
            {
                id: 'psychiatry',
                name: 'Psychiatry (Module 6)',
                color: '#a855f7',
                duration: '1 month',
                procedures: 10,
                caseReports: ['Acute Psychosis', 'Somatoform Disorder']
            },
            {
                id: 'publichealth',
                name: 'Public Health (Module 7)',
                color: '#10b981',
                duration: 'Longitudinal',
                assignmentList: [
                    'PH1: Community Diagnosis', 'PH2: Outbreak Investigation',
                    'PH3: Program Evaluation', 'PH4: Health Management',
                    'PH5: Environmental Health'
                ]
            },
            {
                id: 'eye_ent',
                name: 'Eye/ENT (Module 8)',
                color: '#06b6d4',
                duration: '1 month',
                procedures: 15,
                caseReports: ['Perforating Eye Injury', 'Red Eye Differential', 'Epistaxis Mgmt']
            },
            {
                id: 'lab',
                name: 'Laboratory (Module 9)',
                color: '#6366f1',
                duration: '1 month',
                procedures: 10,
                assignmentList: ['Skill: Cross-match', 'Skill: Malaria Stain']
            },
            {
                id: 'management',
                name: 'Management (Module 10)',
                color: '#475569',
                duration: '4 weeks',
                assignmentList: ['4-Week Intensive Course', 'Major Assignment (3500 words)']
            }
        ];

        const milestoneConfigs = {
            research: [
                { id: 'res_topic', label: 'Research Topic Approved' },
                { id: 'res_data', label: 'Data Collection Completed' },
                { id: 'res_submit', label: 'Research Submitted' },
                { id: 'res_present', label: 'Research Presented' }
            ],
            exams: [
                { id: 'exam_part1', label: 'Part 1 Exam Passed' },
                { id: 'exam_part2_written', label: 'Part 2 Written Passed' },
                { id: 'exam_part2_clinical', label: 'Part 2 Clinical Passed' }
            ],
            management: [
                { id: 'mgmt_course', label: '4-Week Intensive Course' },
                { id: 'mgmt_assign', label: '7,500 Word Assignment' }
            ],
            other: [
                { id: 'solar_course', label: 'Solar/Radio Maintenance Course' }
            ]
        };

        const masterLogbookConfig = [
            {
                category: 'Anaesthesiology',
                items: [
                    { id: 'la_pre', label: 'Pre-op Assessment', target: 50 },
                    { id: 'la_int', label: 'Intubation', target: 10 },
                    { id: 'la_spin', label: 'Spinal Anaesthesia', target: 20 },
                    { id: 'la_ket', label: 'Ketamine Anaesthesia', target: 10 }
                ]
            },
            {
                category: 'Obstetrics & Gynaecology',
                items: [
                    { id: 'lo_norm', label: 'Normal Delivery', target: 20 },
                    { id: 'lo_cs', label: 'LUSCS (Caesarean)', target: 6 },
                    { id: 'lo_breech', label: 'Breech Delivery', target: 5 },
                    { id: 'lo_vac', label: 'Vacuum Extraction', target: 6 },
                    { id: 'lo_pph', label: 'PPH Management', target: 6 }
                ]
            },
            {
                category: 'Child Health',
                items: [
                    { id: 'lc_neo', label: 'Neonatal Resuscitation', target: 4 },
                    { id: 'lc_pon', label: 'Ponsetti Casting', target: 2 },
                    { id: 'lc_io', label: 'Intraosseous Needle', target: 1 }
                ]
            },
            {
                category: 'Surgery & Medicine',
                items: [
                    { id: 'ls_hernia', label: 'Hernia Repair', target: 8 },
                    { id: 'ls_lap', label: 'Laparotomy', target: 5 },
                    { id: 'ls_chest', label: 'Chest Drain Insertion', target: 7 },
                    { id: 'lm_lp', label: 'Lumbar Puncture', target: 10 }
                ]
            },
            {
                category: 'Laboratory Medicine',
                items: [
                    { id: 'log_blood', label: 'Blood Typing & Crossmatch', target: 10 },
                    { id: 'log_malaria', label: 'Malaria Smear Staining', target: 10 }
                ]
            }
        ];

        // --- State Management (With Sync & Offline) ---
        class AppState {
            constructor() {
                this.account = null;
                this.modules = {};
                this.procedureLog = [];
                this.milestones = {};
                this.logbook = {};
                this.sidebarOpen = window.innerWidth > 768;
                this.activeTab = 'dashboard';
                this.listeners = [];
                this.loadData();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('mmed_tracker_data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.account = data.account || null;
                        this.modules = data.modules || {};
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                        this.logbook = data.logbook || {};
                    }
                    // Initialize modules if missing
                    moduleConfigs.forEach(m => {
                        if (!this.modules[m.id]) this.modules[m.id] = { assignments: {}, weeks: {}, caseReports: {} };
                    });
                } catch (e) { console.error("Data load failed", e); }
            }

            saveData() {
                localStorage.setItem('mmed_tracker_data', JSON.stringify({
                    account: this.account,
                    modules: this.modules,
                    procedureLog: this.procedureLog,
                    milestones: this.milestones,
                    logbook: this.logbook
                }));
                this.notify();
            }

            // --- Data Import/Export (Device Sync) ---
            exportData() {
                const dataStr = localStorage.getItem('mmed_tracker_data');
                if (!dataStr) return alert('No data to export!');

                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mmed_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            importData(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm(`Replace current data with backup from ${data.account ? data.account.name : 'Success'}? This cannot be undone.`)) {
                            localStorage.setItem('mmed_tracker_data', JSON.stringify(data));
                            location.reload();
                        }
                    } catch (err) {
                        alert('Error importing data: ' + err.message);
                    }
                };
                reader.readAsText(file);
                input.value = '';
            }

            // --- Auth Logic ---
            register(name, id, year, question, answer) {
                const randomPass = "MMED-" + Math.floor(1000 + Math.random() * 9000);
                this.account = { name, id, year, password: randomPass, securityQuestion: question, securityAnswer: answer.toLowerCase(), needsPasswordChange: true };
                this.saveData();
                return randomPass;
            }

            login(id, password) {
                if (this.account && this.account.id === id && this.account.password === password) {
                    this.session = { isLoggedIn: true };
                    return true;
                }
                return false;
            }

            resetPassword(id, answer, newPassword) {
                if (this.account && this.account.id === id && this.account.securityAnswer === answer.toLowerCase()) {
                    this.account.password = newPassword;
                    this.account.needsPasswordChange = false;
                    this.saveData();
                    return true;
                }
                return false;
            }

            logout() {
                this.session = null;
                this.notify();
            }

            updateModuleData(moduleId, type, id, value) {
                if (!this.modules[moduleId]) this.modules[moduleId] = { assignments: {}, weeks: {}, caseReports: {} };
                if (type === 'week') {
                    if (!this.modules[moduleId].weeks) this.modules[moduleId].weeks = {};
                    if (!this.modules[moduleId].weeks[id]) this.modules[moduleId].weeks[id] = {};
                    if (typeof value === 'object') {
                        this.modules[moduleId].weeks[id] = { ...this.modules[moduleId].weeks[id], ...value };
                    } else {
                        this.modules[moduleId].weeks[id].status = value;
                    }
                } else if (type === 'assignment') {
                    // Check if value is object (date) or string
                    if (!this.modules[moduleId].assignments) this.modules[moduleId].assignments = {};
                    if (!this.modules[moduleId].assignments[id]) this.modules[moduleId].assignments[id] = {};
                    this.modules[moduleId].assignments[id] = { ...this.modules[moduleId].assignments[id], ...value };
                } else if (type === 'caseReport') {
                    if (!this.modules[moduleId].caseReports) this.modules[moduleId].caseReports = {};
                    this.modules[moduleId].caseReports[id] = value; // 'Done' or null
                }
                this.saveData();
            }

            logProcedure(moduleId) {
                const lastSup = this.procedureLog.length > 0 ? this.procedureLog[this.procedureLog.length - 1].supervisor : '';
                const date = prompt("Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
                if (!date) return;
                const procedure = prompt("Procedure Name (e.g., Appendectomy):");
                if (!procedure) return;
                const supervisor = prompt("Supervisor Name (Auto-filled last used):", lastSup);
                if (!supervisor) return;

                this.procedureLog.push({
                    moduleId, date, procedure, supervisor, timestamp: Date.now()
                });
                this.saveData();
                render();
            }

            updateMilestone(category, id, value, date) {
                if (!this.milestones[category]) this.milestones[category] = {};
                this.milestones[category][id] = { status: value, date: date };
                this.saveData();
            }

            updateLogbook(id, value) {
                this.logbook[id] = value;
                this.saveData();
                render(); // Re-render to show progress
            }

            notify() { this.listeners.forEach(l => l()); }
            subscribe(l) { this.listeners.push(l); }
        }

        const state = new AppState();

        // --- UI Rendering ---

        function renderLogin() {
            const app = document.getElementById('app');
            const isRegistered = !!state.account;

            app.innerHTML = `
                <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:100%; max-width:400px; border-top: 6px solid var(--forest-green);">
                        <div style="text-align:center; margin-bottom:30px;">
                            <h1 style="color:var(--forest-green); font-size:1.6em; font-weight:bold;">Master of Medicine (Rural)</h1>
                            <p style="color:#6b7280; font-size:0.9em;">Postgraduate Electronic Logbook</p>
                        </div>

                        ${!isRegistered ? `
                            <form onsubmit="event.preventDefault(); 
                                const pass = state.register(this.rName.value, this.rId.value, this.rYear.value, this.rQ.value, this.rA.value);
                                alert('REGISTRATION SUCCESSFUL\\n\\nDefault Password: ' + pass + '\\n\\nPlease record this to log in.');
                                render();">
                                <h3 style="margin-bottom:15px; font-size:1.1em; color:var(--clay);">Student Activation</h3>
                                <div style="display:grid; gap:12px;">
                                    <input name="rName" placeholder="Full Name" required>
                                    <input name="rId" placeholder="Student ID Number" required>
                                    <select name="rYear">
                                        <option value="1">Year 1</option><option value="2">Year 2</option>
                                        <option value="3">Year 3</option><option value="4">Year 4</option>
                                        <option value="5">Year 5</option><option value="6">Year 6</option>
                                    </select>
                                    <div style="background:#fefce8; padding:10px; border-radius:6px; font-size:0.8em; border:1px solid #fef08a;">
                                        <strong>Recovery Question:</strong>
                                        <select name="rQ" style="margin-top:5px;">
                                            <option>What is your home village?</option>
                                            <option>What was your first school?</option>
                                        </select>
                                        <input name="rA" placeholder="Answer" required style="margin-top:5px;">
                                    </div>
                                    <button class="btn-rural">Activate My Portfolio</button>
                                </div>
                            </form>
                             <div style="margin-top:20px; text-align:center; border-top:1px solid #e5e7eb; padding-top:15px;">
                                <button onclick="document.getElementById('importInput').click()" style="background:none; border:1px solid #d1d5db; padding:8px 15px; border-radius:6px; cursor:pointer; font-size:0.9em; color:#4b5563;">
                                    üì• Import Backup File
                                </button>
                                <input type="file" id="importInput" style="display:none" onchange="state.importData(this)" accept=".json">
                            </div>

                        ` : `
                            <form onsubmit="event.preventDefault(); 
                                if(state.login(this.lId.value, this.lPass.value)) render(); 
                                else alert('Invalid Credentials');">
                                <div style="display:grid; gap:15px;">
                                    <input name="lId" placeholder="Student ID" required>
                                    <div style="position:relative;">
                                        <input name="lPass" id="lPass" type="password" placeholder="Password" required>
                                        <button type="button" onclick="const p=document.getElementById('lPass'); p.type=p.type==='password'?'text':'password';" 
                                                style="position:absolute; right:10px; top:10px; background:none; border:none; cursor:pointer;">üëÅÔ∏è</button>
                                    </div>
                                    <button class="btn-rural">Sign In</button>
                                    <a href="#" onclick="showReset()" style="text-align:center; color:var(--clay); font-size:0.8em; text-decoration:none;">Forgot Password?</a>
                                </div>
                            </form>
                             <div style="margin-top:20px; text-align:center; border-top:1px solid #e5e7eb; padding-top:15px;">
                                <button onclick="document.getElementById('importInput').click()" style="background:none; border:1px solid #d1d5db; padding:8px 15px; border-radius:6px; cursor:pointer; font-size:0.9em; color:#4b5563;">
                                    üì• Import Backup File
                                </button>
                                <input type="file" id="importInput" style="display:none" onchange="state.importData(this)" accept=".json">
                            </div>
                            <div style="margin-top:10px; text-align:center;">
                                <button onclick="if(confirm('Reset all data? Type DELETE')) { localStorage.removeItem('mmed_tracker_data'); location.reload(); }" style="color:#ef4444; background:none; border:none; font-size:0.8em; cursor:pointer;">Reset App Data</button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function showReset() {
            const id = prompt("Enter Student ID:");
            if (id !== state.account.id) return alert("ID not found.");
            const ans = prompt(`Security Question: ${state.account.securityQuestion}`);
            if (ans && ans.toLowerCase() === state.account.securityAnswer) {
                const newP = prompt("Enter New Password:");
                if (newP && state.resetPassword(id, ans, newP)) alert("Password Reset! Log in now.");
            } else alert("Incorrect Answer.");
        }

        function renderModuleDetail(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const data = state.modules[moduleId] || { assignments: {}, weeks: {}, caseReports: {} };

            return `
                <div style="padding:20px; max-width:1000px; margin:auto;">
                    <div style="background:${config.color}; color:white; padding:30px; border-radius:12px; margin-bottom:30px;">
                        <h1>${config.name}</h1>
                        <p>Rotation Duration: ${config.duration}</p>
                    </div>

                    <!-- Weekly Schedule (If exists) -->
                    ${config.weeks ? `
                    <div style="background:white; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:20px;">
                        <h3 style="color:var(--clay); margin-bottom:15px;">Weekly Clinical Schedule</h3>
                        <div style="display:grid; gap:10px;">
                            ${config.weeks.map(w => {
                const wData = (data.weeks && data.weeks[w.id]) || {};
                const wStatus = wData.status || 'Not Started';
                // Determine if we should auto-set Pending on start date change (only if Not Started)
                return `
                                <div style="padding:15px; border-bottom:1px solid #f3f4f6; background:${wStatus === 'Completed' ? '#dcfce7' : wStatus === 'Pending' ? '#fef9c3' : 'white'}; border-radius:8px; margin-bottom:10px; border:1px solid ${wStatus === 'Completed' ? '#bbf7d0' : '#e5e7eb'};">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                        <div>
                                            <span style="font-weight:bold; color:var(--forest-green); margin-right:10px;">${w.id.toUpperCase()}</span>
                                            <span style="font-weight:600; color:#374151;">${w.title}</span>
                                        </div>
                                        <select onchange="state.updateModuleData('${moduleId}', 'week', '${w.id}', {status: this.value})" 
                                                style="padding:6px 12px; border-radius:6px; border:1px solid #d1d5db; cursor:pointer; font-weight:500; ${wStatus === 'Completed' ? 'background:#15803d; color:white' : wStatus === 'Pending' ? 'background:#ca8a04; color:white' : 'color:#6b7280'}">
                                            <option value="Not Started" ${wStatus === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                            <option value="Pending" ${wStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="Completed" ${wStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                                        </select>
                                    </div>
                                    <div style="display:flex; gap:20px; font-size:0.9em; color:#6b7280; background:#f9fafb; padding:10px; border-radius:6px;">
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="font-weight:500;">Start:</span>
                                            <input type="date" value="${wData.startDate || ''}" 
                                                   onchange="state.updateModuleData('${moduleId}', 'week', '${w.id}', {startDate: this.value, ...('${wStatus}'==='Not Started'?{status:'Pending'}:{})})"
                                                   style="padding:5px; border:1px solid #d1d5db; border-radius:4px; color:#374151;">
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="font-weight:500;">End:</span>
                                            <input type="date" value="${wData.completeDate || ''}" 
                                                   onchange="state.updateModuleData('${moduleId}', 'week', '${w.id}', {completeDate: this.value, status: 'Completed'})"
                                                   style="padding:5px; border:1px solid #d1d5db; border-radius:4px; color:#374151;">
                                        </div>
                                    </div>
                                </div>`;
            }).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Case Reports (If exists) -->
                    ${config.caseReports ? `
                    <div style="background:white; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:20px;">
                        <h3 style="color:var(--clay); margin-bottom:15px;">Required Case Reports</h3>
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                            ${config.caseReports.map((cr, i) => {
                const crId = 'cr_' + i;
                const isDone = data.caseReports && data.caseReports[crId] === 'Done';
                return `
                                <div onclick="state.updateModuleData('${moduleId}', 'caseReport', '${crId}', '${isDone ? '' : 'Done'}')"
                                     style="padding:15px; border:1px solid ${isDone ? '#22c55e' : '#e5e7eb'}; background:${isDone ? '#f0fdf4' : 'white'}; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px;">
                                    <div style="width:20px; height:20px; border-radius:50%; border:2px solid #22c55e; background:${isDone ? '#22c55e' : 'white'}; display:flex; justify-content:center; align-items:center; font-size:12px; color:white;">${isDone ? '‚úì' : ''}</div>
                                    <span style="${isDone ? 'font-weight:bold; color:#15803d' : ''}">${cr}</span>
                                </div>`;
            }).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Assignments -->
                     ${config.assignmentList && config.assignmentList.length > 0 ? `
                        <h3 style="color:var(--clay); border-bottom:2px solid var(--clay); display:inline-block; margin-bottom:20px;">Assignments Tracking</h3>
                        <div style="display:grid; gap:20px;">
                            ${config.assignmentList.map((a, i) => {
                const aId = 'assign_' + i;
                const aData = (data.assignments && data.assignments[aId]) || {};
                const title = typeof a === 'string' ? a : a.title;
                const prompt = typeof a === 'string' ? '' : a.prompt;
                return `
                                    <div style="background:white; padding:20px; border-radius:8px; border:1px solid #e5e7eb; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                                        <h4 style="font-weight:bold; margin-bottom:5px;">${title}</h4>
                                        ${prompt ? `<p style="font-size:0.9em; color:#6b7280; margin-bottom:15px;">${prompt}</p>` : ''}
                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                            <div><label style="font-size:0.7em; font-weight:bold; color:var(--clay);">STARTED</label>
                                                <input type="date" value="${aData.dateStarted || ''}" onchange="state.updateModuleData('${moduleId}', 'assignment', '${aId}', {dateStarted: this.value})">
                                            </div>
                                            <div><label style="font-size:0.7em; font-weight:bold; color:var(--clay);">SUBMITTED</label>
                                                <input type="date" value="${aData.dateSubmitted || ''}" onchange="state.updateModuleData('${moduleId}', 'assignment', '${aId}', {dateSubmitted: this.value})">
                                            </div>
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    ` : ''}

                    <!-- Procedures Log -->
                    <div style="background:white; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-top:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="color:var(--clay);">Procedure Log</h3>
                            <div style="display:flex; gap:10px;">
                                <button onclick="renderPrintView('${moduleId}')" style="background:#f3f4f6; color:#4b5563; border:1px solid #d1d5db; padding:8px 15px; border-radius:6px; cursor:pointer; font-size:0.9em;">üñ®Ô∏è Print Log</button>
                                <button onclick="state.logProcedure('${moduleId}')" class="btn-rural" style="font-size:0.9em;">+ Log New</button>
                            </div>
                        </div>
                        <p><strong>Goal:</strong> ${state.procedureLog.filter(p => p.moduleId === moduleId).length} / ${config.procedures || 0}</p>
                        <div style="margin-top:15px; display:grid; gap:10px;">
                            ${state.procedureLog.filter(p => p.moduleId === moduleId).map(p => `
                                <div style="padding:10px; border:1px solid #e5e7eb; border-radius:6px; background:#f9fafb; font-size:0.9em;">
                                    <strong>${p.date}</strong>: ${p.procedure} <span style="color:#6b7280;">(Supervisor: ${p.supervisor})</span>
                                </div>
                            `).join('')}
                            ${state.procedureLog.filter(p => p.moduleId === moduleId).length === 0 ? '<p style="color:#9ca3af; font-style:italic;">No procedures logged yet.</p>' : ''}
                        </div>
                    </div>

                </div>
            `;
        }

        function renderPrintView(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const logs = state.procedureLog.filter(p => p.moduleId === moduleId);
            const app = document.getElementById('app');

            app.innerHTML = `
                <div style="padding:40px; max-width:800px; margin:auto; background:white; min-height:100vh;">
                    <div style="text-align:center; margin-bottom:30px; border-bottom:2px solid #15803d; padding-bottom:20px;">
                        <h1 style="color:#15803d; margin:0;">Master of Medicine (Rural)</h1>
                        <h2 style="color:#4b5563; margin:5px 0 0 0;">${config.name} Logbook</h2>
                        <p style="margin-top:10px;"><strong>Student:</strong> ${state.account.name} (ID: ${state.account.id})</p>
                    </div>

                    <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
                        <thead>
                            <tr style="background:#f3f4f6; text-align:left;">
                                <th style="border:1px solid #d1d5db; padding:10px;">Date</th>
                                <th style="border:1px solid #d1d5db; padding:10px;">Procedure</th>
                                <th style="border:1px solid #d1d5db; padding:10px;">Supervisor</th>
                                <th style="border:1px solid #d1d5db; padding:10px; width:150px;">Signature</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(p => `
                                <tr>
                                    <td style="border:1px solid #d1d5db; padding:10px;">${p.date}</td>
                                    <td style="border:1px solid #d1d5db; padding:10px;">${p.procedure}</td>
                                    <td style="border:1px solid #d1d5db; padding:10px;">${p.supervisor}</td>
                                    <td style="border:1px solid #d1d5db; padding:10px;"></td> <!-- Signature Box -->
                                </tr>
                            `).join('')}
                            ${logs.length === 0 ? '<tr><td colspan="4" style="text-align:center; padding:20px; color:#9ca3af;">No procedures logged yet.</td></tr>' : ''}
                        </tbody>
                    </table>

                    <div class="no-print" style="text-align:center; position:fixed; bottom:20px; left:0; width:100%;">
                        <button onclick="window.print()" style="background:#15803d; color:white; border:none; padding:12px 25px; border-radius:6px; font-weight:bold; cursor:pointer; margin-right:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">üñ®Ô∏è Print Now</button>
                        <button onclick="render()" style="background:#f3f4f6; color:#4b5563; border:1px solid #d1d5db; padding:12px 25px; border-radius:6px; cursor:pointer;">‚ùå Close</button>
                    </div>
                </div>
            `;
        }

        function renderMilestones() {
            return `
            < div style = "padding:30px; max-width:1000px; margin:auto;" >
                <h1 style="color:var(--forest-green); margin-bottom:30px;">Milestones & Progress</h1>
                    ${Object.keys(milestoneConfigs).map(cat => `
                        <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                            <h3 style="text-transform:uppercase; color:var(--clay); letter-spacing:1px; margin-bottom:15px;">${cat}</h3>
                            <div style="display:grid; gap:10px;">
                                ${milestoneConfigs[cat].map(m => {
                const mData = state.milestones[cat] && state.milestones[cat][m.id] ? state.milestones[cat][m.id] : {};
                return `
                                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f9fafb; border-radius:8px;">
                                        <span style="font-weight:600;">${m.label}</span>
                                        <div style="display:flex; gap:10px;">
                                            <select onchange="state.updateMilestone('${cat}', '${m.id}', this.value, document.getElementById('d_${m.id}').value)"
                                                    style="width:auto; padding:5px; border-radius:4px; ${mData.status === 'Done' || mData.status === 'Passed' ? 'background:#dcfce7; color:#166534' : ''}">
                                                <option value="Not Started" ${mData.status !== 'Done' && mData.status !== 'Passed' ? 'selected' : ''}>Pending</option>
                                                <option value="${cat === 'exams' ? 'Passed' : 'Done'}" ${mData.status === 'Done' || mData.status === 'Passed' ? 'selected' : ''}>${cat === 'exams' ? 'Passed' : 'Done'}</option>
                                            </select>
                                            <input type="date" id="d_${m.id}" value="${mData.date || ''}" style="width:auto;"
                                                   onchange="state.updateMilestone('${cat}', '${m.id}', document.querySelector('select[onchange*=\\'${m.id}\\']').value, this.value)">
                                        </div>
                                    </div>`;
            }).join('')}
                            </div>
                        </div>
                    `).join('')
                }
                </div >
            `;
        }

        function renderMasterLogbook() {
            return `
            <div style="padding:30px; max-width:1000px; margin:auto;">
                <h1 style="color:var(--forest-green); margin-bottom:10px;">Master Logbook Checklist</h1>
                <p style="color:#6b7280; margin-bottom:30px;">Track your progress against graduation requirements (Numbers indicate procedures performed).</p>
                
                ${masterLogbookConfig.map(cat => `
                    <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="color:#15803d; border-bottom:2px solid #e5e7eb; padding-bottom:10px; margin-bottom:15px;">
                            ${cat.category}
                        </h3>
                        <div style="display:grid; gap:12px;">
                            ${cat.items.map(item => {
                const val = state.logbook[item.id] || 0;
                const isDone = val >= item.target;
                const pct = Math.min(100, Math.round((val / item.target) * 100));
                return `
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:${isDone ? '#f0fdf4' : '#f9fafb'}; border-radius:6px; border:1px solid ${isDone ? '#bbf7d0' : '#e5e7eb'};">
                                    <div style="flex:1;">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                                            <span style="font-weight:500; color:${isDone ? '#15803d' : '#374151'};">${item.label}</span>
                                            <span style="font-size:0.9em; color:${isDone ? '#15803d' : '#6b7280'}; margin-right: 15px;">${val} / ${item.target}</span>
                                        </div>
                                        <div style="background:#e5e7eb; height:6px; border-radius:99px; width:100%; max-width:300px;">
                                            <div style="background:${isDone ? '#22c55e' : '#3b82f6'}; height:6px; border-radius:99px; width:${pct}%;"></div>
                                        </div>
                                    </div>
                                    <div style="margin-left:20px;">
                                        <input type="number" min="0" value="${val}" 
                                               onchange="state.updateLogbook('${item.id}', parseInt(this.value) || 0)"
                                               style="width:70px; padding:6px; border:1px solid #d1d5db; border-radius:4px; text-align:center;">
                                    </div>
                                </div>
                            `;
            }).join('')}
                        </div>
                    </div>
                `).join('')}

                <div style="margin-top:40px; text-align:center;">
                     <button onclick="window.print()" class="btn-rural">üñ®Ô∏è Print Master Logbook</button>
                </div>
            </div>
            `;
        }


        function render() {
            if (!state.session || !state.session.isLoggedIn) {
                renderLogin();
                return;
            }

            if (state.account.needsPasswordChange) {
                const newP = prompt("SECURITY: You are using a default password. Enter a new private password:");
                if (newP) {
                    state.account.password = newP;
                    state.account.needsPasswordChange = false;
                    state.saveData();
                } else { state.logout(); return; }
            }

            const app = document.getElementById('app');
            app.innerHTML = `
                <div style="display:flex; min-height:100vh;">
                    <!-- Sidebar -->
                    <div class="no-print" style="width:260px; background:var(--earth-black); color:white; padding:20px; display:flex; flex-direction:column;">
                        <h2 style="color:var(--forest-green); margin-bottom:30px; font-weight:bold;">MMED Rural</h2>
                        <button onclick="state.activeTab='dashboard'; render()" style="width:100%; text-align:left; background:none; border:none; color:white; padding:10px; cursor:pointer;">üìä Dashboard</button>
                        <button onclick="state.activeTab='master_logbook'; render()" style="width:100%; text-align:left; background:none; border:none; color:white; padding:10px; cursor:pointer;">üìã Master Logbook</button>
                         <button onclick="state.activeTab='milestones'; render()" style="width:100%; text-align:left; background:none; border:none; color:white; padding:10px; cursor:pointer;">üèÅ Milestones</button>
                        <hr style="margin:20px 0; border:0; border-top:1px solid #374151;">
                        <div style="flex:1; overflow-y:auto;">
                            <p style="font-size:0.7em; color:#9ca3af; margin-bottom:10px; letter-spacing:1px;">MODULES</p>
                            ${moduleConfigs.map(m => `
                                <button onclick="state.activeTab='${m.id}'; render()" style="width:100%; text-align:left; background:none; border:none; color:#d1d5db; padding:8px; cursor:pointer; font-size:0.9em;">‚Ä¢ ${m.name}</button>
                            `).join('')}
                        </div>
                        <div style="margin-top:auto;">
                            <button onclick="state.exportData()" style="width:100%; text-align:left; background:none; border:none; color:#fbbf24; padding:8px; cursor:pointer; font-size:0.9em; margin-bottom:10px;">üì• Backup Data</button>
                            <button onclick="state.logout(); render()" style=" color:#f87171; background:none; border:none; cursor:pointer;">üö™ Sign Out</button>
                        </div>
                    </div>

                    <!--Content -->
            <div style="flex:1; overflow-y:auto; height: 100vh;">
                ${state.activeTab === 'dashboard' ? `
                            <div style="padding:40px;">
                                <h1 style="color:var(--forest-green);">Welcome, Dr. ${state.account.name}</h1>
                                <p style="color:#6b7280;">Masters in Medicine (Rural) | Year ${state.account.year}</p>
                                
                                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-top:30px;">
                                    <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border-top:4px solid var(--forest-green);">
                                        <h3 style="color:#6b7280; font-size:0.9em; text-transform:uppercase;">Assignments</h3>
                                        <p style="font-size:2em; font-weight:bold; color:var(--earth-black);">
                                            ${Object.values(state.modules).reduce((acc, m) => acc + (m.assignments ? Object.values(m.assignments).filter(a => a.dateSubmitted).length : 0), 0)}
                                            <span style="font-size:0.5em; color:#9ca3af;">/ ${moduleConfigs.reduce((acc, m) => acc + (m.assignmentList ? m.assignmentList.length : 0), 0)}</span>
                                        </p>
                                    </div>
                                    <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border-top:4px solid var(--forest-green);">
                                        <h3 style="color:#6b7280; font-size:0.9em; text-transform:uppercase;">Procedures</h3>
                                        <p style="font-size:2em; font-weight:bold; color:var(--earth-black);">
                                            ${state.procedureLog.length}
                                            <span style="font-size:0.5em; color:#9ca3af;">/ ${moduleConfigs.reduce((acc, m) => acc + (m.procedures || 0), 0)}</span>
                                        </p>
                                    </div>
                                </div>

                                <div style="margin-top:30px; background:white; padding:20px; border-radius:12px; border-left:5px solid var(--accent-orange);">
                                    <h3 style="color:var(--clay);">Academic Status</h3>
                                    <p style="font-size:0.9em;">Ensure all procedure logs are signed by supervisors before rotation end.</p>
                                </div>
                            </div>
                        ` : state.activeTab === 'milestones' ? renderMilestones()
                    : state.activeTab === 'master_logbook' ? renderMasterLogbook()
                        : renderModuleDetail(state.activeTab)}
            </div>
                </div >
            `;
        }

        state.subscribe(render);
        render();

        // --- Service Worker Registration (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }
    </script>
</body>

</html>