<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Postgraduate Portfolio</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <style>
        :root { --forest-green: #15803d; --clay: #92400e; --earth-black: #1f2937; --bg-rural: #fdfbf7; --accent-orange: #d97706; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-rural); color: var(--earth-black); line-height: 1.5; }
        button { font-family: inherit; transition: all 0.2s; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; background: white; }
        .btn-rural { background: var(--forest-green); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-rural:hover { background: var(--clay); }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500; }
        .status-done { background: #dcfce7; color: #166534; }
        .status-pending { background: #f3f4f6; color: #6b7280; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { animation: fadeIn 0.15s ease-out; }
        .mobile-header { display: none; }
        #mobile-overlay { display: none; }
        @media (max-width: 768px) {
            #sidebar { position: fixed !important; left: -280px; top: 0; bottom: 0; z-index: 1000; transition: transform 0.3s ease; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2); }
            #sidebar.open { transform: translateX(280px); }
            #mobile-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 999; }
            #mobile-overlay.open { display: block; }
            .mobile-header { display: flex; background: var(--forest-green); color: white; padding: 15px; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 900; }
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        const moduleConfigs = [
            { id: 'surgery', name: 'Surgery (Module 1)', color: '#15803d', duration: '9 months', procedures: 45, weeks: [{id:'w1',title:'Trauma Assessment'},{id:'w2',title:'Antibiotics'},{id:'w3',title:'Sterilization'},{id:'w4',title:'Theatre Setup'},{id:'w5',title:'Acute Pain'},{id:'w6',title:'Chronic Pain'},{id:'w7',title:'Wounds'},{id:'w8',title:'Transfer'},{id:'w9',title:'Pyomyositis'},{id:'w10',title:'Chest Drains'},{id:'w11',title:'Closed Fractures'},{id:'w12',title:'Neurovascular'},{id:'w13',title:'Dental'},{id:'w14',title:'Abscesses'},{id:'w15',title:'Appendicitis'},{id:'w16',title:'Laparotomy'},{id:'w17',title:'Gut Repair'},{id:'w18',title:'Stomas'},{id:'w19',title:'Obstruction'},{id:'w20',title:'Casting'},{id:'w21',title:'Traction'},{id:'w22',title:'Open Fractures'},{id:'w23',title:'Dislocations'},{id:'w24',title:'Upper Limb'},{id:'w25',title:'Bleeding'},{id:'w26',title:'Enucleation'},{id:'w27',title:'Hernia'},{id:'w28',title:'Strangulated Hernia'},{id:'w29',title:'Minor Ops'},{id:'w30',title:'Head/Spine'},{id:'w31',title:'Burns'},{id:'w32',title:'Ethics'}], assignmentList: ['1. Cancer Pathophysiology','2. Cancer Screening','3. Blood Transfusion','4. Blood/Haemopoiesis','5. Cytokines','6. Wound Healing','7. Hb/Oxygen','8. Genetics','9. Nerve Conduction','10. Pain Pathways','11. Urodynamics','12. CSF/ICP','13. Calcium','14. Liver Function','15. Bile/Gallstones','16. Oedema','17. Thrombosis','18. Gastric Secretion','19. Surgical Infections','20. Antibiotics Policy'] },
            { id: 'anaesthesia', name: 'Anaesthesiology (Module 2)', color: '#475569', duration: '4 months', procedures: 50, weeks: [{id:'w1',title:'Equipment'},{id:'w2',title:'Ketamine'},{id:'w3',title:'Propofol'},{id:'w4',title:'Pre-op'},{id:'w5',title:'Opiates'},{id:'w6',title:'Chronic Pain'},{id:'w7',title:'Spinal'},{id:'w8',title:'Brachial'},{id:'w9',title:'Wrist/Ankle'},{id:'w10',title:'Neonatal Resus'},{id:'w11',title:'Can\'t Intubate'},{id:'w12',title:'IV Access'},{id:'w13',title:'Cardiac Arrest'},{id:'w14',title:'Outcomes'}], caseReports: ['General Anaesthesia','Ketamine','Spinal','Paediatric','Resuscitation'] },
            { id: 'childhealth', name: 'Child Health (Module 3)', color: '#f97316', duration: '1 month', procedures: 30, weeks: [{id:'w1',title:'Milestones'},{id:'w2',title:'Pneumonia'},{id:'w3',title:'Cardiac'},{id:'w4',title:'Newborn'},{id:'w5',title:'Ponsetti'},{id:'w6',title:'Immunization'}], caseReports: ['Pneumonia','Diarrhoea','Malnutrition','Meningitis','Neonatal Sepsis'] },
            { id: 'obs_gyn', name: 'Obs & Gynae (Module 4)', color: '#ec4899', duration: '3 months', procedures: 40, weeks: [{id:'w1',title:'Menstral'},{id:'w2',title:'Contraception'},{id:'w3',title:'Antenatal'},{id:'w4',title:'USS'},{id:'w5',title:'Miscarriage'},{id:'w6',title:'Labour'},{id:'w7',title:'Partograms'},{id:'w8',title:'CS'},{id:'w9',title:'APH'},{id:'w10',title:'Failure Progress'},{id:'w11',title:'PPH'},{id:'w12',title:'Sepsis'},{id:'w13',title:'Infertility'},{id:'w15',title:'Ovarian'},{id:'w17',title:'Endometrial'},{id:'w19',title:'Cervical'},{id:'w21',title:'Pelvic Sepsis'},{id:'w23',title:'Pre-eclampsia'},{id:'w26',title:'PPH Adv'},{id:'w29',title:'Destructive'}], assignmentList: [{title:'Written Assign 1',prompt:'Antenatal or Family Planning'},{title:'Written Assign 2',prompt:'Emergency Obstetric Care'}] },
            { id: 'medicine', name: 'Internal Medicine (Module 5)', color: '#3b82f6', duration: '2 months', procedures: 20, weeks: [{id:'w1',title:'Diabetes'},{id:'w2',title:'Sepsis'},{id:'w3',title:'TB'},{id:'w4',title:'Snake/ECG'},{id:'w5',title:'HTN/HIV'},{id:'w6',title:'Asthma'}], caseReports: ['Severe Malaria','Meningitis','Pneumonia','Heart Failure','TB'] },
            { id: 'psychiatry', name: 'Psychiatry (Module 6)', color: '#a855f7', duration: '1 month', procedures: 10, caseReports: ['Acute Psychosis','Somatoform'] },
            { id: 'publichealth', name: 'Public Health (Module 7)', color: '#10b981', duration: 'Longitudinal', assignmentList: ['PH1: Community','PH2: Outbreak','PH3: Evaluation','PH4: Management','PH5: Environment'] },
            { id: 'eye_ent', name: 'Eye/ENT (Module 8)', color: '#06b6d4', duration: '1 month', procedures: 15, caseReports: ['Eye Injury','Red Eye','Epistaxis'] },
            { id: 'lab', name: 'Laboratory (Module 9)', color: '#6366f1', duration: '1 month', procedures: 10, assignmentList: ['Cross-match','Malaria Stain'] },
            { id: 'management', name: 'Management (Module 10)', color: '#475569', duration: '4 weeks', assignmentList: ['4-Week Course','Major Assignment'] }
        ];

        const milestoneConfigs = {
            research: [{id:'res_topic',label:'Topic Approved'},{id:'res_data',label:'Data Collection'},{id:'res_submit',label:'Submitted'},{id:'res_present',label:'Presented'}],
            exams: [{id:'exam_part1',label:'Part 1 Passed'},{id:'exam_part2_written',label:'Part 2 Written'},{id:'exam_part2_clinical',label:'Part 2 Clinical'}],
            management: [{id:'mgmt_course',label:'Course'},{id:'mgmt_assign',label:'Assignment'}],
            other: [{id:'solar_course',label:'Solar/Radio Course'}]
        };

        const masterLogbookConfig = [
            { category: 'Anaesthesiology', items: [{id:'la_pre',label:'Pre-op',target:50},{id:'la_int',label:'Intubation',target:10},{id:'la_spin',label:'Spinal',target:20},{id:'la_ket',label:'Ketamine',target:10}] },
            { category: 'Obstetrics & Gynaecology', items: [{id:'lo_norm',label:'Normal Delivery',target:20},{id:'lo_cs',label:'LUSCS',target:6},{id:'lo_breech',label:'Breech',target:5},{id:'lo_vac',label:'Vacuum',target:6},{id:'lo_pph',label:'PPH',target:6}] },
            { category: 'Child Health', items: [{id:'lc_neo',label:'Neonatal Resus',target:4},{id:'lc_pon',label:'Ponsetti',target:2},{id:'lc_io',label:'Intraosseous',target:1}] },
            { category: 'Surgery & Medicine', items: [{id:'ls_hernia',label:'Hernia',target:8},{id:'ls_lap',label:'Laparotomy',target:5},{id:'ls_chest',label:'Chest Drain',target:7},{id:'lm_lp',label:'Lumbar Puncture',target:10}] },
            { category: 'Laboratory Medicine', items: [{id:'log_blood',label:'Blood X-Match',target:10},{id:'log_malaria',label:'Malaria Stain',target:10}] }
        ];

        class AppState {
            constructor() {
                this.account = null;
                this.modules = {};
                this.procedureLog = [];
                this.milestones = {};
                this.logbook = {};
                this.sidebarOpen = window.innerWidth > 768;
                this.activeTab = 'dashboard';
                this.listeners = [];
                this.initFirebase();
                this.loadData();
            }

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyBhEln9kmgq22NnNHI83eUH7_d6S4F1O5s",
                    authDomain: "rural-mmed-logbook-3e095.firebaseapp.com",
                    projectId: "rural-mmed-logbook-3e095",
                    storageBucket: "rural-mmed-logbook-3e095.firebasestorage.app",
                    messagingSenderId: "826477177641",
                    appId: "1:826477177641:web:fe9de6e733b442fdffe538"
                };
                try {
                    firebase.initializeApp(firebaseConfig);
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();
                    this.auth.onAuthStateChanged(user => {
                        if (user) { this.handleCloudLogin(user); }
                    });
                } catch (e) {
                    console.log("Firebase Error: " + e.message);
                }
            }

            async handleCloudLogin(user) {
                console.log("Cloud User:", user.email);
                const defaultYear = 1;
                const cloudRef = this.db.collection('users').doc(user.uid);

                try {
                    const doc = await cloudRef.get();
                    let cloudData = doc.exists ? doc.data() : {};
                    
                    this.account = {
                        name: cloudData.account?.name || user.displayName || "Dr. " + user.email.split('@')[0],
                        email: user.email,
                        photo: user.photoURL,
                        id: user.uid,
                        year: cloudData.account?.year || defaultYear,
                        lastBackup: Date.now()
                    };

                    this.modules = cloudData.modules || this.modules;
                    this.procedureLog = cloudData.procedureLog || this.procedureLog;
                    this.milestones = cloudData.milestones || this.milestones;
                    this.logbook = cloudData.logbook || this.logbook;

                    this.saveData(true); 
                    if (!doc.exists) { this.saveData(); }

                } catch (e) {
                    console.error("Login Sync Error:", e);
                    this.account = {
                        name: user.displayName || "User",
                        email: user.email,
                        id: user.uid,
                        year: defaultYear,
                        lastBackup: Date.now()
                    };
                    alert("Logged in locally (Offline/Sync Error).");
                } finally {
                    render();
                }
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('mmed_tracker_data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.account = data.account || null;
                        this.modules = data.modules || {};
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                        this.logbook = data.logbook || {};
                    }
                    moduleConfigs.forEach(m => {
                        if (!this.modules[m.id]) this.modules[m.id] = { assignments: {}, weeks: {}, caseReports: {} };
                    });
                } catch (e) { console.error("Data load failed", e); }
            }

            saveData(skipCloud = false) {
                const data = { account: this.account, modules: this.modules, procedureLog: this.procedureLog, milestones: this.milestones, logbook: this.logbook };
                localStorage.setItem('mmed_tracker_data', JSON.stringify(data));
                if (!skipCloud && this.account && this.db && this.account.id) {
                    this.db.collection('users').doc(this.account.id).set(data, { merge: true }).catch(e => console.error(e));
                }
                this.notify();
            }

            exportData() {
                const dataStr = localStorage.getItem('mmed_tracker_data');
                if (!dataStr) return alert('No data!');
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mmed_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            importData(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm(`Replace data with backup?`)) {
                            localStorage.setItem('mmed_tracker_data', JSON.stringify(data));
                            location.reload();
                        }
                    } catch (err) { alert('Error: ' + err.message); }
                };
                reader.readAsText(file);
                input.value = '';
            }

            signInWithGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                this.auth.signInWithRedirect(provider);
            }

            logout() {
                if (this.auth) this.auth.signOut();
                this.account = null;
                this.notify();
                location.reload();
            }

            updateModuleData(moduleId, type, id, value) {
                if (!this.modules[moduleId]) this.modules[moduleId] = { assignments: {}, weeks: {}, caseReports: {} };
                if (type === 'week') {
                    if (!this.modules[moduleId].weeks) this.modules[moduleId].weeks = {};
                    if (!this.modules[moduleId].weeks[id]) this.modules[moduleId].weeks[id] = {};
                    if (typeof value === 'object') {
                        this.modules[moduleId].weeks[id] = { ...this.modules[moduleId].weeks[id], ...value };
                    } else {
                        this.modules[moduleId].weeks[id].status = value;
                    }
                } else if (type === 'assignment') {
                    if (!this.modules[moduleId].assignments) this.modules[moduleId].assignments = {};
                    if (!this.modules[moduleId].assignments[id]) this.modules[moduleId].assignments[id] = {};
                    this.modules[moduleId].assignments[id] = { ...this.modules[moduleId].assignments[id], ...value };
                } else if (type === 'caseReport') {
                    if (!this.modules[moduleId].caseReports) this.modules[moduleId].caseReports = {};
                    this.modules[moduleId].caseReports[id] = value;
                }
                this.saveData();
            }

            addProcedure(data) {
                this.procedureLog.push({ ...data, timestamp: Date.now() });
                this.saveData();
                render();
            }

            logProcedure(moduleId) {
                const lastSup = this.procedureLog.length > 0 ? this.procedureLog[this.procedureLog.length - 1].supervisor : '';
                const date = prompt("Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
                if (!date) return;
                const procedure = prompt("Procedure Name:");
                if (!procedure) return;
                const supervisor = prompt("Supervisor Name:", lastSup);
                if (!supervisor) return;
                this.addProcedure({ moduleId, date, procedure, supervisor });
            }

            updateMilestone(category, id, value, date) {
                if (!this.milestones[category]) this.milestones[category] = {};
                this.milestones[category][id] = { status: value, date: date };
                this.saveData();
            }

            updateLogbook(id, value) {
                this.logbook[id] = value;
                this.saveData();
                render();
            }

            notify() { this.listeners.forEach(l => l()); }
            subscribe(l) { this.listeners.push(l); }
        }

        const state = new AppState();

        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;">
                    <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:100%; max-width:400px; border-top: 6px solid var(--forest-green); text-align:center;">
                        <h1 style="color:var(--forest-green); font-size:1.6em; font-weight:bold; margin-bottom:10px;">Master of Medicine (Rural)</h1>
                        <p style="color:#6b7280; font-size:0.9em; margin-bottom:30px;">Cloud-Synced Portfolio</p>
                        <button onclick="state.signInWithGoogle()" style="background:white; color:#374151; border:1px solid #d1d5db; padding:12px 20px; border-radius:6px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; width:100%; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with Google
                        </button>
                        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb;">
                            <button onclick="document.getElementById('importInput').click()" style="background:none; border:none; cursor:pointer; font-size:0.9em; color:var(--forest-green); text-decoration:underline;">üì• Import Backup</button>
                            <input type="file" id="importInput" style="display:none" onchange="state.importData(this)" accept=".json">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModuleDetail(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const data = state.modules[moduleId] || { assignments: {}, weeks: {}, caseReports: {} };
            return `
                <div style="padding:20px; max-width:1000px; margin:auto;">
                    <div style="background:${config.color}; color:white; padding:30px; border-radius:12px; margin-bottom:30px;">
                        <h1>${config.name}</h1>
                        <p>Duration: ${config.duration}</p>
                    </div>
                    ${config.weeks ? `<div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;"><h3>Schedule</h3><div style="display:grid; gap:10px;">${config.weeks.map(w => {
                        const wData = (data.weeks && data.weeks[w.id]) || {};
                        const wStatus = wData.status || 'Not Started';
                        return `<div style="padding:10px; border:1px solid #e5e7eb; background:${wStatus==='Completed'?'#dcfce7':wStatus==='Pending'?'#fef9c3':'white'}; border-radius:6px;">
                            <div style="display:flex; justify-content:space-between;"><strong>${w.title}</strong><select onchange="state.updateModuleData('${moduleId}','week','${w.id}',{status:this.value})"><option ${wStatus==='Not Started'?'selected':''}>Not Started</option><option ${wStatus==='Pending'?'selected':''}>Pending</option><option ${wStatus==='Completed'?'selected':''}>Completed</option></select></div>
                            <div style="margin-top:5px; font-size:0.9em;">Start: <input type="date" value="${wData.startDate||''}" onchange="state.updateModuleData('${moduleId}','week','${w.id}',{startDate:this.value})"> End: <input type="date" value="${wData.completeDate||''}" onchange="state.updateModuleData('${moduleId}','week','${w.id}',{completeDate:this.value})"></div>
                        </div>`;
                    }).join('')}</div></div>` : ''}
                    
                    ${config.caseReports ? `<div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px;"><h3>Case Reports</h3><div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px;">${config.caseReports.map((cr,i) => {
                        const isDone = data.caseReports && data.caseReports['cr_'+i] === 'Done';
                        return `<div onclick="state.updateModuleData('${moduleId}','caseReport','cr_'+${i},'${isDone?'':'Done'}')" style="padding:10px; border:1px solid ${isDone?'#22c55e':'#e5e7eb'}; background:${isDone?'#f0fdf4':'white'}; border-radius:6px; cursor:pointer;">${isDone?'‚úì ':''}${cr}</div>`;
                    }).join('')}</div></div>` : ''}

                    <div style="background:white; padding:20px; border-radius:8px;"><h3>Procedure Log</h3>
                        <p>Goal: ${state.procedureLog.filter(p=>p.moduleId===moduleId).length} / ${config.procedures||0}</p>
                        <button onclick="state.logProcedure('${moduleId}')" class="btn-rural">+ Log New</button>
                        <div style="margin-top:10px;">${state.procedureLog.filter(p=>p.moduleId===moduleId).map(p=>`<div style="padding:5px; border-bottom:1px solid #eee;">${p.date}: ${p.procedure} (${p.supervisor})</div>`).join('')}</div>
                    </div>
                </div>
            `;
        }

        function renderMilestones() {
            return `<div style="padding:30px; max-width:1000px; margin:auto;"><h1>Milestones</h1>${Object.keys(milestoneConfigs).map(cat => `
                <div style="background:white; padding:20px; margin-bottom:20px; border-radius:8px;"><h3>${cat.toUpperCase()}</h3>
                ${milestoneConfigs[cat].map(m => {
                    const mData = state.milestones[cat] && state.milestones[cat][m.id] ? state.milestones[cat][m.id] : {};
                    return `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${m.label}</span>
                    <div><select onchange="state.updateMilestone('${cat}','${m.id}',this.value, document.getElementById('d_${m.id}').value)"><option ${mData.status!=='Done'?'selected':''}>Pending</option><option ${mData.status==='Done'?'selected':''}>Done</option></select>
                    <input type="date" id="d_${m.id}" value="${mData.date||''}" onchange="state.updateMilestone('${cat}','${m.id}',this.previousElementSibling.value,this.value)"></div></div>`;
                }).join('')}</div>`).join('')}</div>`;
        }

        function renderMasterLogbook() {
            return `<div style="padding:30px; max-width:1000px; margin:auto;"><h1>Master Logbook</h1>${masterLogbookConfig.map(cat => `
                <div style="background:white; padding:20px; margin-bottom:20px; border-radius:8px;"><h3>${cat.category}</h3>
                ${cat.items.map(item => {
                    const val = state.logbook[item.id] || 0;
                    return `<div style="display:flex; justify-content:space-between; padding:10px;"><span>${item.label} (${val}/${item.target})</span>
                    <input type="number" value="${val}" onchange="state.updateLogbook('${item.id}',parseInt(this.value)||0)" style="width:60px;"></div>`;
                }).join('')}</div>`).join('')}</div>`;
        }

        function render() {
            if (!state.account) { renderLogin(); return; }
            document.getElementById('app').innerHTML = `
                <div class="mobile-header no-print"><button onclick="document.getElementById('sidebar').classList.add('open');document.getElementById('mobile-overlay').classList.add('open')" style="background:none;border:none;color:white;font-size:1.5em">‚ò∞</button> <span>MMED Rural</span></div>
                <div id="mobile-overlay" onclick="document.getElementById('sidebar').classList.remove('open');document.getElementById('mobile-overlay').classList.remove('open')"></div>
                <div style="display:flex; min-height:100vh;">
                    <div id="sidebar" class="no-print" style="width:260px; background:var(--earth-black); color:white; padding:20px; display:flex; flex-direction:column;">
                        <h2 style="color:var(--forest-green); margin-bottom:20px;">MMED Rural</h2>
                        <button onclick="state.activeTab='dashboard';render();" style="text-align:left; background:none; border:none; color:white; padding:10px;">üìä Dashboard</button>
                        <button onclick="state.activeTab='master_logbook';render();" style="text-align:left; background:none; border:none; color:white; padding:10px;">üìã Master Logbook</button>
                        <button onclick="state.activeTab='milestones';render();" style="text-align:left; background:none; border:none; color:white; padding:10px;">üèÅ Milestones</button>
                        <hr style="margin:10px 0; border-color:#374151;">
                        <div style="flex:1; overflow-y:auto;">${moduleConfigs.map(m=>`<button onclick="state.activeTab='${m.id}';render();" style="text-align:left; background:none; border:none; color:#d1d5db; padding:8px; width:100%;">‚Ä¢ ${m.name}</button>`).join('')}</div>
                        <button onclick="state.exportData()" style="text-align:left; background:none; border:none; color:#fbbf24; padding:10px;">üì• Backup</button>
                        <button onclick="state.logout()" style="text-align:left; color:#f87171; background:none; border:none; padding:10px;">üö™ Sign Out</button>
                    </div>
                    <div style="flex:1; overflow-y:auto; height:100vh;">
                        ${state.activeTab === 'dashboard' ? `
                            <div style="padding:40px;">
                                <h1 style="color:var(--forest-green);">Welcome, ${state.account.name}</h1>
                                <p style="color:#6b7280;">Year ${state.account.year}</p>
                                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:30px;">
                                    <div style="background:white; padding:20px; border-radius:8px; border-top:4px solid var(--forest-green);"><h3>Procedures</h3><p style="font-size:2em; font-weight:bold;">${state.procedureLog.length}</p></div>
                                </div>
                                <div style="margin-top:30px; background:white; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                                    <h3 style="color:var(--forest-green); margin-bottom:15px;">Your Profile</h3>
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                        <div><label style="font-size:0.8em; font-weight:bold; color:#6b7280;">Display Name</label><input type="text" value="${state.account.name}" onchange="state.account.name=this.value;state.saveData();"></div>
                                        <div><label style="font-size:0.8em; font-weight:bold; color:#6b7280;">Current Year</label>
                                            <select onchange="state.account.year=parseInt(this.value);state.saveData();render();"><option value="1"${state.account.year===1?'selected':''}>Year 1</option><option value="2"${state.account.year===2?'selected':''}>Year 2</option><option value="3"${state.account.year===3?'selected':''}>Year 3</option><option value="4"${state.account.year===4?'selected':''}>Year 4</option><option value="5"${state.account.year===5?'selected':''}>Year 5</option><option value="6"${state.account.year===6?'selected':''}>Year 6</option></select>
                                        </div>
                                    </div>
                                    <p style="margin-top:10px; font-size:0.8em; color:#9ca3af;">Updates auto-saved.</p>
                                </div>
                            </div>
                        ` : state.activeTab === 'milestones' ? renderMilestones() : state.activeTab === 'master_logbook' ? renderMasterLogbook() : renderModuleDetail(state.activeTab)}
                    </div>
                </div>
            `;
        }
        
        window.onclick = function(event) { if (event.target == document.getElementById('mobile-overlay')) { document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobile-overlay').classList.remove('open'); } }
    </script>
</body>
</html>
